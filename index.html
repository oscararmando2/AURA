<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA STUDIO - Pilates a tu medida</title>
    
    <!-- iOS/iPadOS/macOS Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167x167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- Google Fonts - Amita -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amita:wght@400;700&display=swap" rel="stylesheet">
    <!-- Google Fonts - Fondamento -->
    <link href="https://fonts.googleapis.com/css2?family=Fondamento:ital@0;1&display=swap" rel="stylesheet">
    <!-- FullCalendar v6.1.15 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <!-- AURA Styles -->
    <link rel="stylesheet" href="assets/css/styles.css">
    <!-- Mercado Pago SDK v2 - Para Checkout Pro en Producci√É¬≥n -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <!-- Firebase SDK v10 via CDN - Authentication and Firestore -->
    <script type="module">
        // Firebase imports will be handled in the script section
    </script>

    <!-- Vercel Speed Insights -->
    <script>
        window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</head>
<body>
    <!-- ========== Page Loader ========== -->
    <div id="page-loader">
        <div class="loader-content">
            <div class="planet">
                <div class="spots">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <p>Aura Studio</p>
        </div>
    </div>

    <!-- ========== Site Header ========== -->
    <header class="site-header">
        <img src="auralogo2.png" alt="AURA" class="logo">
    </header>

    <!-- ========== Hamburger Menu ========== -->
    <!-- Men√∫ hamburguesa en la esquina superior derecha -->
    <div id="hamburger-container">
        <!-- Bot√≥n hamburguesa (tres l√≠neas) -->
        <button type="button" id="hamburger-btn" aria-label="Abrir men√∫ de opciones" aria-expanded="false" aria-controls="menu-dropdown">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </button>
        
        <!-- Men√∫ desplegable -->
        <div id="menu-dropdown" role="menu" aria-hidden="true" style="display: none; position: absolute; top: 60px; right: 0; background: linear-gradient(135deg, #ffffff 0%, #EFE9E1 100%); border-radius: 15px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); border: 2px solid rgba(239, 233, 225, 0.3); min-width: 200px; overflow: hidden;">
            <button type="button" id="menu-register" role="menuitem" aria-label="Registrarse" style="display: block; width: 100%; padding: 15px 20px; background: #fff; border: none; text-align: left; cursor: pointer; color: #333; font-size: 1rem; border-bottom: 1px solid #ccc;">
                Registrarse
            </button>
            <button type="button" id="menu-my-classes" role="menuitem" aria-label="Iniciar Sesi√≥n" style="display: block; width: 100%; padding: 15px 20px; background: #fff; border: none; text-align: left; cursor: pointer; color: #333; font-size: 1rem; border-bottom: 1px solid #ccc;">
                Iniciar Sesi√≥n
            </button>
            <button type="button" id="menu-admin-login" role="menuitem" aria-label="Login Admin" style="display: block; width: 100%; padding: 15px 20px; background: #fff; border: none; text-align: left; cursor: pointer; color: #333; font-size: 1rem; border-bottom: 1px solid #ccc;">
                Login Admin
            </button>
            <button type="button" id="menu-logout" role="menuitem" aria-label="Cerrar Sesi√≥n" style="display: none; width: 100%; padding: 15px 20px; background: #fff; border: none; text-align: left; cursor: pointer; color: #333; font-size: 1rem;">
                Cerrar Sesi√≥n
            </button>
            <button type="button" id="menu-admin-logout" role="menuitem" aria-label="Cerrar Sesi√≥n Admin" style="display: none; width: 100%; padding: 15px 20px; background: #fff; border: none; text-align: left; cursor: pointer; color: #333; font-size: 1rem;">
                Cerrar Sesi√≥n Admin
            </button>
            <button type="button" id="menu-back" role="menuitem" aria-label="Volver Atr√°s" style="display: none; width: 100%; padding: 15px 20px; background: #fff; border: none; text-align: left; cursor: pointer; color: #333; font-size: 1rem; border-top: 1px solid #ccc;">
                Volver Atr√°s
            </button>
        </div>
    </div>

    <!-- Modal para Registro de Usuario -->
    <!-- Modal de Registro - Usado para ambos: crear cuenta completa Y registro r√°pido para pago -->
    <div id="register-modal" role="dialog" aria-labelledby="register-modal-title" aria-modal="true" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
      <div style="background:#fff; padding:40px; border-radius:20px; max-width:400px; width:90%; text-align:center; box-shadow:0 20px 60px rgba(246,200,199,0.4); border:3px solid #EFE9E1;">
        <h2 id="register-modal-title" style="color:#333; margin-bottom:15px;">¬°Bienvenida a Aura!</h2>
        <p style="color:#666; margin-bottom:20px;">Ingresa tus datos para recibir un c√≥digo de verificaci√≥n</p>
        <input type="text" id="quick-name" placeholder="Nombre completo" aria-label="Nombre completo" autocomplete="name" required style="width:100%; padding:15px; margin-bottom:15px; border:1px solid #EFE9E1; border-radius:12px; font-size:1.1rem;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
          <span style="font-size: 1.3rem; font-weight: 600; color: #999; background: #f8f8f8; padding: 15px 12px; border-radius: 12px 0 0 12px; border: 1px solid #EFE9E1; border-right: none;">+52</span>
          <input type="tel" id="quick-phone-digits" placeholder="715 159 6586" maxlength="10" pattern="[0-9]{10}" inputmode="numeric" autocomplete="tel" style="flex: 1; padding: 15px; border: 1px solid #EFE9E1; border-radius: 0 12px 12px 0; font-size: 1.1rem;" required>
        </div>
        <!-- Hidden password field for compatibility, but not used anymore -->
        <input type="hidden" id="quick-password" value="not-used-anymore">
        <div style="display:flex; gap:15px;">
          <button type="button" onclick="guardarRegistroLocalYPagar()" style="flex:1; background:#EFE9E1; color:#000; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Continuar</button>
          <button type="button" onclick="document.getElementById('register-modal').style.display='none'" style="flex:1; background:#eee; color:#666; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal para Login de Usuario (Mis Clases) -->
    <div id="user-login-modal" role="dialog" aria-labelledby="user-login-modal-title" aria-modal="true" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
      <div style="background:#fff; padding:40px; border-radius:20px; max-width:400px; width:90%; text-align:center; box-shadow:0 20px 60px rgba(246,200,199,0.4); border:3px solid #EFE9E1;">
        <h2 id="user-login-modal-title" style="color:#333; margin-bottom:15px;">Mis Clases</h2>
        <p style="color:#666; margin-bottom:20px;">Ingresa tu tel√©fono para recibir un c√≥digo de verificaci√≥n</p>
        <div id="user-login-error" style="display: none; background: linear-gradient(135deg, #EFE9E1 0%, #EFE9E1 100%); color: #000; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-size: 0.9rem;"></div>
        <form id="user-login-form" onsubmit="return false;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
              <span style="font-size: 1.3rem; font-weight: 600; color: #999; background: #f8f8f8; padding: 15px 12px; border-radius: 12px 0 0 12px; border: 1px solid #EFE9E1; border-right: none;">+52</span>
              <input type="tel" id="user-login-phone" placeholder="10 d√≠gitos" maxlength="10" pattern="[0-9]{10}" inputmode="numeric" autocomplete="tel" style="flex: 1; padding: 15px; border: 1px solid #EFE9E1; border-radius: 0 12px 12px 0; font-size: 1.1rem;" required>
            </div>
            <div style="display:flex; gap:15px;">
              <button type="submit" style="flex:1; background:#EFE9E1; color:#000; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Enviar C√≥digo</button>
              <button type="button" id="user-login-cancel" style="flex:1; background:#eee; color:#666; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Cancelar</button>
            </div>
        </form>
      </div>
    </div>

    <!-- reCAPTCHA Container (Required for Phone Authentication) -->
    <div id="recaptcha-container" style="display: none;"></div>

    <!-- Modal para C√≥digo de Verificaci√≥n SMS (Registro) -->
    <div id="verification-code-modal-register" role="dialog" aria-labelledby="verification-code-title-register" aria-modal="true" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center;">
      <div style="background:#fff; padding:40px; border-radius:20px; max-width:400px; width:90%; text-align:center; box-shadow:0 20px 60px rgba(246,200,199,0.4); border:3px solid #EFE9E1;">
        <h2 id="verification-code-title-register" style="color:#333; margin-bottom:15px;">Verificaci√≥n de Tel√©fono</h2>
        <p style="color:#666; margin-bottom:20px;">Ingresa el c√≥digo de 6 d√≠gitos enviado a tu tel√©fono</p>
        <div id="verification-error-register" style="display: none; background: rgba(197, 17, 98, 0.1); color: #C51162; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-size: 0.9rem;"></div>
        <input type="text" id="verification-code-input-register" placeholder="000000" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" autocomplete="one-time-code" style="width:100%; padding:15px; margin-bottom:15px; border:1px solid #EFE9E1; border-radius:12px; font-size:1.5rem; text-align:center; letter-spacing:0.5rem;" required>
        <div style="display:flex; gap:15px;">
          <button type="button" id="verify-code-btn-register" style="flex:1; background:#EFE9E1; color:#000; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Verificar</button>
          <button type="button" id="cancel-verification-btn-register" style="flex:1; background:#eee; color:#666; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Cancelar</button>
        </div>
        <button type="button" id="resend-code-btn-register" style="margin-top:15px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer; font-size:0.95rem;">Reenviar c√≥digo</button>
      </div>
    </div>

    <!-- Modal para C√≥digo de Verificaci√≥n SMS (Login) -->
    <div id="verification-code-modal-login" role="dialog" aria-labelledby="verification-code-title-login" aria-modal="true" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center;">
      <div style="background:#fff; padding:40px; border-radius:20px; max-width:400px; width:90%; text-align:center; box-shadow:0 20px 60px rgba(246,200,199,0.4); border:3px solid #EFE9E1;">
        <h2 id="verification-code-title-login" style="color:#333; margin-bottom:15px;">Verificaci√≥n de Tel√©fono</h2>
        <p style="color:#666; margin-bottom:20px;">Ingresa el c√≥digo de 6 d√≠gitos enviado a tu tel√©fono</p>
        <div id="verification-error-login" style="display: none; background: rgba(197, 17, 98, 0.1); color: #C51162; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-size: 0.9rem;"></div>
        <input type="text" id="verification-code-input-login" placeholder="000000" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" autocomplete="one-time-code" style="width:100%; padding:15px; margin-bottom:15px; border:1px solid #EFE9E1; border-radius:12px; font-size:1.5rem; text-align:center; letter-spacing:0.5rem;" required>
        <div style="display:flex; gap:15px;">
          <button type="button" id="verify-code-btn-login" style="flex:1; background:#EFE9E1; color:#000; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Verificar</button>
          <button type="button" id="cancel-verification-btn-login" style="flex:1; background:#eee; color:#666; padding:15px; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer;">Cancelar</button>
        </div>
        <button type="button" id="resend-code-btn-login" style="margin-top:15px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer; font-size:0.95rem;">Reenviar c√≥digo</button>
      </div>
    </div>

    <!-- Modal para Selecci√≥n de Horario -->
    <div id="time-selection-modal" role="dialog" aria-labelledby="time-modal-title" aria-modal="true" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #ffffff 0%, #EFE9E1 100%); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); max-width: 450px; width: 90%; border: 2px solid rgba(239, 233, 225, 0.3);">
            <h2 id="time-modal-title" style="color: #333; margin-bottom: 10px; font-size: 1.8rem; font-weight: 600;">Selecciona tu Horario</h2>
            <p id="time-modal-date" style="color: #666; margin-bottom: 20px; font-size: 1rem; font-weight: 500;"></p>
            <div style="margin-bottom: 20px;">
                <p style="color: #666; font-weight: 500; margin-bottom: 10px;">üåÖ Horarios Disponibles:</p>
                <div id="time-slots-container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px; background: rgba(239, 233, 225, 0.05); border-radius: 10px;">
                    <!-- Time slots will be generated here -->
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" id="time-cancel" style="flex: 1; background: #e0e0e0; color: #666; padding: 12px 20px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Crear Contrase√±a (Legacy Users) -->
    <div id="create-password-modal" role="dialog" aria-labelledby="create-password-title" aria-modal="true" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 2200; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #ffffff 0%, #EFE9E1 100%); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); max-width: 450px; width: 90%; border: 2px solid rgba(239, 233, 225, 0.3);">
            <h2 id="create-password-title" style="color: #333; margin-bottom: 20px; font-size: 1.8rem; font-weight: 600; text-align: center;">¬°Encontramos tus clases!</h2>
            <p style="color: #666; margin-bottom: 25px; text-align: center; line-height: 1.6;">Tienes clases agendadas pero tu cuenta no tiene contrase√±a configurada. Por favor, crea una contrase√±a para poder acceder a tus clases.</p>
            
            <div style="margin-bottom: 25px;">
                <label for="legacy-new-password" style="display: block; color: #666; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">Nueva Contrase√±a (m√≠nimo 4 caracteres)</label>
                <div style="position: relative;">
                    <input type="password" id="legacy-new-password" placeholder="Crea tu contrase√±a" autocomplete="new-password" style="width: 100%; padding: 14px; padding-right: 45px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#EFE9E1'" onblur="this.style.borderColor='rgba(239, 233, 225, 0.3)'" />
                    <button type="button" id="toggle-legacy-password" aria-label="Mostrar contrase√±a" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 0; line-height: 1; color: #666; transition: color 0.3s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.color='#333'" onmouseout="this.style.color='#666'">üëÅÔ∏è</button>
                </div>
            </div>
            
            <div id="legacy-password-error" style="display: none; color: #C51162; background: rgba(197, 17, 98, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.95rem;"></div>
            
            <div style="display: flex; gap: 12px;">
                <button type="button" id="legacy-password-cancel" style="flex: 1; background: #e0e0e0; color: #666; padding: 16px; border: 1px solid #ccc; border-radius: 10px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#d0d0d0'" onmouseout="this.style.background='#e0e0e0'">
                    Cancelar
                </button>
                <button type="button" id="legacy-password-confirm" style="flex: 2; background: linear-gradient(135deg, #EFE9E1 0%, #EFE9E1 100%); color: #000; padding: 16px; border: 2px solid #EFE9E1; border-radius: 10px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(239, 233, 225, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 233, 225, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(239, 233, 225, 0.4)'">
                    Crear Contrase√±a
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmaci√≥n de Reserva (Nombre + Tel√©fono + Pagar) -->
    <div id="reservation-modal" role="dialog" aria-modal="true" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2100; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #ffffff 0%, #EFE9E1 100%); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); max-width: 500px; width: 90%; border: 2px solid rgba(239, 233, 225, 0.3);">
            <h2 style="color: #333; margin-bottom: 20px; font-size: 1.8rem; font-weight: 600; text-align: center;">Confirma tu Reserva</h2>
            
            <!-- Informaci√≥n del horario seleccionado -->
            <div style="background: rgba(239, 233, 225, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(239, 233, 225, 0.3); max-height: 250px; overflow-y: auto;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 1.5rem;">üìÖ</span>
                    <span id="reservation-date-display" style="color: #333; font-weight: 600; font-size: 1.1rem;"></span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="font-size: 1.5rem;">üïê</span>
                    <span id="reservation-time-display" style="color: #666; font-weight: 500; font-size: 1.05rem; flex: 1;"></span>
                </div>
            </div>
            
            <!-- Formulario de datos del cliente -->
            <div style="margin-bottom: 25px;">
                <label for="reservation-name" style="display: block; color: #666; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">Nombre Completo</label>
                <input type="text" id="reservation-name" placeholder="Ej: Mar√≠a Garc√≠a" autocomplete="name" style="width: 100%; padding: 14px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#EFE9E1'" onblur="this.style.borderColor='rgba(239, 233, 225, 0.3)'" />
            </div>
            
            <div style="margin-bottom: 25px;">
                <label for="reservation-phone" style="display: block; color: #666; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">Tel√©fono (10 d√≠gitos)</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="padding: 14px; background: rgba(239, 233, 225, 0.1); border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 10px; font-weight: 600; color: #333;">+52</span>
                    <input type="tel" id="reservation-phone" placeholder="1234567890" maxlength="10" pattern="[0-9]{10}" autocomplete="tel" style="flex: 1; padding: 14px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#EFE9E1'" onblur="this.style.borderColor='rgba(239, 233, 225, 0.3)'" />
                </div>
                <p style="color: #999; font-size: 0.85rem; margin-top: 6px;">Solo n√∫meros, sin espacios ni guiones</p>
            </div>
            
            <div id="reservation-password-container" style="margin-bottom: 25px;">
                <label for="reservation-password" style="display: block; color: #666; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">Contrase√±a (m√≠nimo 4 caracteres)</label>
                <div style="position: relative;">
                    <input type="password" id="reservation-password" placeholder="Crea tu contrase√±a" autocomplete="new-password" style="width: 100%; padding: 14px; padding-right: 45px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease;" onfocus="this.style.borderColor='#EFE9E1'" onblur="this.style.borderColor='rgba(239, 233, 225, 0.3)'" />
                    <button type="button" id="toggle-reservation-password" aria-label="Mostrar contrase√±a" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 0; line-height: 1; color: #666; transition: color 0.3s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.color='#333'" onmouseout="this.style.color='#666'">üëÅÔ∏è</button>
                </div>
                <p style="color: #999; font-size: 0.85rem; margin-top: 6px;">Para poder ver tus clases despu√©s</p>
            </div>
            
            <!-- Contador de clases seleccionadas -->
            <div style="background: rgba(239, 233, 225, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px; text-align: center;">
                <p style="color: #666; font-size: 0.95rem; margin-bottom: 5px;">Progreso de reservas</p>
                <p id="reservation-progress" style="color: #333; font-weight: 700; font-size: 1.3rem;"></p>
            </div>
            
            <!-- Botones de acci√≥n -->
            <div style="display: flex; gap: 12px;">
                <button type="button" id="reservation-cancel" style="flex: 1; background: #e0e0e0; color: #666; padding: 16px; border: 1px solid #ccc; border-radius: 10px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#d0d0d0'" onmouseout="this.style.background='#e0e0e0'">
                    Cancelar
                </button>
                <button type="button" id="reservation-confirm" style="flex: 2; background: linear-gradient(135deg, #EFE9E1 0%, #EFE9E1 100%); color: #000; padding: 16px; border: 2px solid #EFE9E1; border-radius: 10px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(239, 233, 225, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 233, 225, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(239, 233, 225, 0.4)'">
                    Reservar y pagar ahora
                </button>
            </div>
        </div>
    </div>



    <!-- ========== 1. Welcome Section (Hero Section) ========== -->
    <section class="hero-section">
        <!-- Video Background -->
        <video id="hero-video" class="hero-video-background" autoplay loop muted playsinline preload="auto" disablepictureinpicture disableremoteplayback>
            <source src="videoaura155.mp4" type="video/mp4">
            <!-- Fallback for browsers that don't support video -->
        </video>
        
        <!-- Overlay for better text readability -->
        <div class="hero-overlay"></div>
        
        <div class="hero-content">
            <h1>M√°s que pilates,</h1>
            <h2>una forma de vida</h2>
            <a href="#booking" class="hero-btn">Agendar Clase</a>
        </div>
    </section>

    <!-- ========== 2. About Section (Pilates Studio Cards) ========== -->
    <section class="about-section">
        <h2>Pilates Studio</h2>
        <div class="pilates-cards-container">
            <div class="pilates-card" onclick="togglePilatesCard(this)">
                <img class="pilates-card-image" src="https://images.pexels.com/photos/14843495/pexels-photo-14843495.jpeg" alt="Pilates Studio">
                <div class="pilates-card-overlay">
                    <h3 class="pilates-card-title">Pilates Studio</h3>
                    <p class="pilates-card-text">En Aura Studio, nuestra misi√≥n es promover el bienestar f√≠sico y mental a trav√©s del Pilates. Creemos que cada persona puede alcanzar su m√°ximo potencial con las herramientas adecuadas.</p>
                </div>
            </div>

            <div class="pilates-card" onclick="togglePilatesCard(this)">
                <img class="pilates-card-image" src="https://images.pexels.com/photos/5012112/pexels-photo-5012112.jpeg" alt="Pilates Instructor">
                <div class="pilates-card-overlay">
                    <h3 class="pilates-card-title">Pilates Instructor</h3>
                    <p class="pilates-card-text">Ofrecemos un enfoque personalizado en cada clase de Pilates, adaptando los ejercicios a las necesidades individuales de nuestras alumnas. Nuestro equipo de instructoras certificadas est√° comprometida con tu progreso y salud.</p>
                </div>
            </div>

            <div class="pilates-card" onclick="togglePilatesCard(this)">
                <img class="pilates-card-image" src="https://images.pexels.com/photos/6975235/pexels-photo-6975235.jpeg" alt="Pilates Practice">
                <div class="pilates-card-overlay">
                    <h3 class="pilates-card-title">Pilates Practice</h3>
                    <p class="pilates-card-text">Entrena con nosotras, mejora la flexibilidad, la fuerza y la postura. En Aura Studio, te ense√±amos c√≥mo estos beneficios pueden transformar tu vida diaria y ayudarte a lograr un equilibrio integral.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== 3. Booking Section ========== -->
    <section id="booking" class="booking-section">
        <div class="booking-container">
            <h2>Citas en L√≠nea</h2>
            
            <div class="plans-grid">
                <div class="plan-card">
                    <div class="bg"></div>
                    <div class="blob"></div>
                    <h3>1 Clase</h3>
                    <div class="price">$150</div>
                    <button type="button" class="plan-btn" data-title="1 Clases" data-price="150">Agendar Clase</button>
                </div>

                <div class="plan-card">
                    <div class="bg"></div>
                    <div class="blob"></div>
                    <h3>4 Clases</h3>
                    <div class="price">$540</div>
                    <div class="savings">Ahorras $60</div>
                    <button type="button" class="plan-btn" data-title="4 Clases" data-price="540">Agendar Clase</button>
                </div>

                <div class="plan-card">
                    <div class="bg"></div>
                    <div class="blob"></div>
                    <h3>8 Clases</h3>
                    <div class="price">$1000</div>
                    <div class="savings">Ahorras $200</div>
                    <button type="button" class="plan-btn" data-title="8 Clases" data-price="1000">Agendar Clase</button>
                </div>

                <div class="plan-card">
                    <div class="bg"></div>
                    <div class="blob"></div>
                    <h3>12 Clases</h3>
                    <div class="price">$1400</div>
                    <div class="savings">Ahorras $400</div>
                    <button type="button" class="plan-btn" data-title="12 Clases" data-price="1400">Agendar Clase</button>
                </div>
            </div>

            <div id="calendar-container">
                <div class="calendar-info">
                    <h3>üìÖ Selecciona tus Clases</h3>
                    <p><strong>Horarios Disponibles:</strong></p>
                    <p>üåÖ Ma√±ana: 6:00 AM - 11:00 AM</p>
                    <p>üåÜ Tarde: 5:00 PM - 7:00 PM</p>
                    <p><strong>D√≠as:</strong> Lunes a S√°bado</p>
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color legend-available"></div>
                            <span>Horarios Disponibles</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-booked"></div>
                            <span>Tus Clases Reservadas</span>
                        </div>
                    </div>
                </div>

                <!-- Contador de clases seleccionadas -->
                <div id="class-counter-display">
                    <h3>üìã Progreso de Selecci√≥n</h3>
                    <p class="counter-text">Has elegido <span class="counter-number" id="counter-current">0</span> de <span class="counter-number" id="counter-total">0</span> clases</p>
                </div>

                <div id="calendar"></div>

                <!-- Bot√≥n de pago (solo visible cuando se seleccionaron todas las clases) -->
                <div id="payment-button-container">
                    <button type="button" id="final-payment-btn">
                        üí≥ Pagar y confirmar mis <span id="payment-btn-count">0</span> clases
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== 3.5. My Classes Section ========== -->
    <section id="my-classes-section" class="my-classes-section">
        <h2 id="my-classes-greeting">Mis Clases</h2>
        <div class="my-classes-container">
            <!-- Loading state -->
            <div id="my-classes-loading" class="my-classes-loading" style="display: none;">
                <div class="my-classes-loading-spinner"></div>
                <p style="margin-top: 20px; font-size: 1.1rem;">Cargando tus clases...</p>
            </div>

            <!-- Empty state -->
            <div id="my-classes-empty" class="my-classes-empty" style="display: none;">
                <div class="my-classes-empty-icon">üìÖ</div>
                <p>No tienes clases agendadas a√∫n.</p>
                <p style="margin-top: 10px; font-size: 1rem; color: #999;">
                    <a href="#booking" style="color: #000000; text-decoration: underline;">Agenda tu primera clase aqu√≠</a>
                </p>
            </div>

            <!-- Classes grid -->
            <div id="my-classes-grid" class="my-classes-grid">
                <!-- Classes will be dynamically loaded here -->
            </div>

            <!-- WhatsApp button for sending class schedule -->
            <div id="my-classes-whatsapp" style="display: none;">
                <!-- WhatsApp button will be inserted here dynamically -->
            </div>
        </div>
    </section>

    <!-- ========== 4. Image Scroll Section ========== -->
    <section class="image-scroll-section">
        <h2>Nuestras Instalaciones</h2>
        <div class="image-scroll-container">
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO1.jpeg" alt="Studio 1" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO2.jpeg" alt="Studio 2" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO3.jpeg" alt="Studio 3" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO4.jpeg" alt="Studio 4" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO5.jpeg" alt="Studio 5" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO6.jpeg" alt="Studio 6" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO7.jpeg" alt="Studio 7" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO8.jpeg" alt="Studio 8" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO9.jpeg" alt="Studio 9" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO10.jpeg" alt="Studio 10" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO11.jpeg" alt="Studio 11" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO12.jpeg" alt="Studio 12" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
            <div class="image-wrapper" onclick="likeImage(this)">
                <img src="STUDIO13.jpeg" alt="Studio 13" class="scroll-image">
                <div class="heart-overlay">‚ô°</div>
            </div>
        </div>
    </section>

    <!-- ========== 5. Admin Login Section (Modal Style) ========== -->
    <div id="admin-login-modal" role="dialog" aria-labelledby="admin-login-modal-title" aria-modal="true" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #ffffff 0%, #EFE9E1 100%); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); max-width: 400px; width: 90%; border: 2px solid rgba(239, 233, 225, 0.3);">
            <h2 id="admin-login-modal-title" style="color: #333; margin-bottom: 10px; font-size: 1.8rem; font-weight: 600;">Acceso de Administrador</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.95rem;">Ingresa con tu cuenta de administrador</p>
            <div id="login-error" style="display: none; background: linear-gradient(135deg, #EFE9E1 0%, #EFE9E1 100%); color: #000; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-size: 0.9rem;"></div>
            <form id="admin-login-form" onsubmit="return false;">
                <div style="margin-bottom: 15px;">
                    <label for="admin-email" style="display: block; margin-bottom: 5px; color: #666; font-weight: 500; font-size: 0.95rem;">Correo Electr√≥nico</label>
                    <input type="email" id="admin-email" required autocomplete="username" style="width: 100%; padding: 12px; border: 1px solid rgba(239, 233, 225, 0.5); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="admin-password" style="display: block; margin-bottom: 5px; color: #666; font-weight: 500; font-size: 0.95rem;">Contrase√±a</label>
                    <input type="password" id="admin-password" required autocomplete="current-password" style="width: 100%; padding: 12px; border: 1px solid rgba(239, 233, 225, 0.5); border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; box-sizing: border-box;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1; background: #EFE9E1; color: #000; padding: 12px 20px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer;">
                        Iniciar Sesi√≥n
                    </button>
                    <button type="button" id="admin-login-cancel" style="flex: 1; background: #e0e0e0; color: #666; padding: 12px 20px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer;">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== 6. Admin Panel Section ========== -->
    <section id="admin-panel-section" class="contact-section" style="display: none;">
        <h2 style="font-size: 2rem; margin-bottom: 15px; font-weight: 700;">Panel de Administrador</h2>
        <p style="margin-bottom: 12px; font-size: 1.1rem; color: #666;">Hola <span id="admin-email-display" style="color: #1a1a1a; font-weight: 600;">Michel</span></p>
        <button type="button" id="admin-logout-btn" class="contact-btn" style="margin-bottom: 30px; padding: 14px 32px; font-size: 1.05rem; font-weight: 600; border-radius: 10px; background: linear-gradient(135deg, #f44336 0%, #c62828 100%); border: none; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3); transition: all 0.3s ease;">Cerrar Sesi√≥n</button>
        
        <!-- Contenedor principal: en m√≥vil, el calendario se separa para ocupar todo el ancho -->
        <div id="admin-panel-container" style="max-width: 1400px; margin: 0 auto; background: linear-gradient(135deg, #ffffff 0%, #EFE9E1 100%); padding: 50px; border-radius: 25px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.12); border: 2px solid rgba(239, 233, 225, 0.3);">
            <div style="margin-bottom: 40px;">
                <h3 style="color: #333; margin: 0; font-size: 2.2rem; font-weight: 600; text-align: center; letter-spacing: 1px;">üìÖ Calendario de Reservas</h3>
            </div>
            
            <div id="reservations-loading" style="text-align: center; padding: 40px; color: #666;">
                <p style="font-size: 1.1rem;">Cargando reservas...</p>
            </div>
            
            <!-- Statistics Summary -->
            <div id="admin-stats-section" style="display: none;">
                <div class="admin-stats-summary">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="stat-total-reservations">0</div>
                        <div class="stat-label">Total Reservas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-value" id="stat-this-week">0</div>
                        <div class="stat-label">Esta Semana</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-value" id="stat-unique-clients">0</div>
                        <div class="stat-label">Clientes √önicos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="stat-upcoming">0</div>
                        <div class="stat-label">Pr√≥ximas</div>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Controls -->
            <div id="admin-calendar-controls" style="display: none;">
                <div class="admin-calendar-controls">
                    <input type="text" id="search-client" placeholder="üîç Buscar por nombre o tel√©fono..." style="flex: 1; min-width: 200px;">
                    <input type="date" id="filter-date-start" placeholder="Desde">
                    <input type="date" id="filter-date-end" placeholder="Hasta">

                    <button type="button" id="btn-export-calendar">üì• Exportar</button>
                    <button type="button" id="btn-export-availability">üìä Exportar Disponibilidad</button>
                    <button type="button" id="btn-schedule-admin">üìÖ Agendar</button>
                </div>
            </div>
            
            <!-- Search Results Container for Mobile -->
            <div id="search-results-container" style="display: none; margin-bottom: 20px;">
                <h4 style="color: #333; font-size: 1.2rem; margin-bottom: 15px;">Participantes</h4>
                <div id="search-results-list"></div>
            </div>
            
            <!-- Calendar View for Admin -->
            <div id="admin-calendar-view" style="display: none;">
                <div class="calendar-scroll-hint">
                    <span>üí° Consejo:</span> Desliza horizontalmente para ver todos los d√≠as de la semana ‚Üí
                </div>
                <div id="admin-calendar"></div>
            </div>
            
            <div id="no-reservations" style="display: none; text-align: center; padding: 40px; color: #666;">
                <p style="font-size: 1.1rem;">No hay reservas en este momento.</p>
            </div>
        </div>
        
        <!-- Event Detail Modal -->
        <div id="event-detail-modal" class="event-detail-modal">
            <div class="event-detail-content">
                <div class="event-detail-header">
                    <h3>üë§ Detalle de Reserva</h3>
                    <button type="button" class="event-detail-close" id="event-detail-close">√ó</button>
                </div>
                <div class="event-detail-body">
                    <div class="event-detail-row">
                        <div class="event-detail-icon">üë§</div>
                        <div class="event-detail-info">
                            <div class="event-detail-label">Cliente</div>
                            <div class="event-detail-value" id="detail-client-name">-</div>
                        </div>
                    </div>
                    <div class="event-detail-row">
                        <div class="event-detail-icon">üì±</div>
                        <div class="event-detail-info">
                            <div class="event-detail-label">Tel√©fono</div>
                            <div class="event-detail-value" id="detail-client-email">-</div>
                        </div>
                    </div>
                    <div class="event-detail-row">
                        <div class="event-detail-icon">üìÖ</div>
                        <div class="event-detail-info">
                            <div class="event-detail-label">Fecha</div>
                            <div class="event-detail-value" id="detail-date">-</div>
                        </div>
                    </div>
                    <div class="event-detail-row">
                        <div class="event-detail-icon">üïê</div>
                        <div class="event-detail-info">
                            <div class="event-detail-label">Horario</div>
                            <div class="event-detail-value" id="detail-time">-</div>
                        </div>
                    </div>
                    <div class="event-detail-row" id="detail-notes-row" style="display: none;">
                        <div class="event-detail-icon">üìù</div>
                        <div class="event-detail-info">
                            <div class="event-detail-label">Notas</div>
                            <div class="event-detail-value" id="detail-notes">-</div>
                        </div>
                    </div>
                </div>
                <div class="event-detail-actions">
                    <button type="button" class="btn-secondary" id="detail-close-btn">Cerrar</button>
                    <button type="button" class="btn-edit" id="detail-edit-btn" style="display: none;">‚úèÔ∏è Editar</button>
                    <button type="button" class="btn-primary" id="detail-contact-btn">üìß Contactar</button>
                    <button type="button" class="btn-whatsapp" id="detail-whatsapp-btn">üì± Mandar clases por WhatsApp</button>
                </div>
            </div>
        </div>
        
        <!-- Edit Reservation Modal -->
        <div id="edit-reservation-modal" class="event-detail-modal">
            <div class="event-detail-content">
                <div class="event-detail-header">
                    <h3>‚úèÔ∏è Editar Reserva</h3>
                    <button type="button" class="event-detail-close" id="edit-reservation-close">√ó</button>
                </div>
                <div class="event-detail-body">
                    <div class="event-detail-row">
                        <div class="event-detail-icon">üë§</div>
                        <div class="event-detail-info">
                            <div class="event-detail-label">Cliente</div>
                            <div class="event-detail-value" id="edit-client-name">-</div>
                        </div>
                    </div>
                    <div class="event-detail-row">
                        <div class="event-detail-icon">üìÖ</div>
                        <div class="event-detail-info" style="width: 100%;">
                            <div class="event-detail-label">Nueva Fecha *</div>
                            <input type="date" id="edit-reservation-date" class="modal-input-field" required>
                        </div>
                    </div>
                    <div class="event-detail-row">
                        <div class="event-detail-icon">üïê</div>
                        <div class="event-detail-info" style="width: 100%;">
                            <div class="event-detail-label">Nueva Hora *</div>
                            <select id="edit-reservation-time" class="modal-input-field" required>
                                <option value="">Selecciona una hora</option>
                                <option value="06:00">06:00 AM</option>
                                <option value="07:00">07:00 AM</option>
                                <option value="08:00">08:00 AM</option>
                                <option value="09:00">09:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">01:00 PM</option>
                                <option value="14:00">02:00 PM</option>
                                <option value="15:00">03:00 PM</option>
                                <option value="16:00">04:00 PM</option>
                                <option value="17:00">05:00 PM</option>
                                <option value="18:00">06:00 PM</option>
                                <option value="19:00">07:00 PM</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="event-detail-actions">
                    <button type="button" class="btn-secondary" id="edit-reservation-cancel">Cancelar</button>
                    <button type="button" class="btn-danger" id="edit-reservation-delete">üóëÔ∏è Eliminar Clase</button>
                    <button type="button" class="btn-primary" id="edit-reservation-save">üíæ Guardar Cambios</button>
                </div>
            </div>
        </div>
        
        <!-- Unique Clients Modal -->
        <div id="unique-clients-modal" class="event-detail-modal">
            <div class="event-detail-content unique-clients-modal-content">
                <div class="event-detail-header">
                    <h3>üë• Clientes √önicos</h3>
                    <button type="button" class="event-detail-close" id="unique-clients-close" aria-label="Cerrar modal de clientes √∫nicos">√ó</button>
                </div>
                <div class="event-detail-body unique-clients-list-body" id="unique-clients-list">
                    <!-- Client list will be inserted here dynamically -->
                </div>
                <div class="event-detail-actions">
                    <button type="button" class="btn-secondary" id="unique-clients-close-btn">Cerrar</button>
                </div>
            </div>
        </div>
        
        <!-- Admin Schedule Modal - Multi-Step Interface -->
        <div id="admin-schedule-modal" class="event-detail-modal">
            <div class="event-detail-content" id="admin-schedule-modal-content">
                <!-- Step 1: Client Info & Package Selection -->
                <div id="admin-schedule-step1">
                    <div class="event-detail-header">
                        <h3>üìÖ Agendar Nueva Clase - Paso 1/2</h3>
                        <button type="button" class="event-detail-close" id="admin-schedule-close">√ó</button>
                    </div>
                    <div class="event-detail-body">
                        <div class="event-detail-row">
                            <div class="event-detail-icon">üë§</div>
                            <div class="event-detail-info" style="width: 100%;">
                                <div class="event-detail-label">Nombre del Cliente *</div>
                                <input type="text" id="admin-schedule-name" required style="width: 100%; padding: 10px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 8px; font-size: 1rem; margin-top: 5px;">
                            </div>
                        </div>
                        <div class="event-detail-row">
                            <div class="event-detail-icon">üì±</div>
                            <div class="event-detail-info" style="width: 100%;">
                                <div class="event-detail-label">Tel√©fono * (10 d√≠gitos)</div>
                                <input type="tel" id="admin-schedule-phone" required pattern="[0-9]{10}" placeholder="10 d√≠gitos sin guiones" style="width: 100%; padding: 10px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 8px; font-size: 1rem; margin-top: 5px;">
                            </div>
                        </div>
                        <div class="event-detail-row">
                            <div class="event-detail-icon">üì¶</div>
                            <div class="event-detail-info" style="width: 100%;">
                                <div class="event-detail-label">N√∫mero de Clases *</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <button type="button" class="admin-package-btn" data-classes="1">1 Clase</button>
                                    <button type="button" class="admin-package-btn" data-classes="4">4 Clases</button>
                                    <button type="button" class="admin-package-btn" data-classes="8">8 Clases</button>
                                    <button type="button" class="admin-package-btn" data-classes="12">12 Clases</button>
                                </div>
                                <input type="hidden" id="admin-schedule-package" required>
                            </div>
                        </div>
                    </div>
                    <div class="event-detail-actions">
                        <button type="button" class="btn-secondary" id="admin-schedule-cancel-step1">Cancelar</button>
                        <button type="button" class="btn-primary" id="admin-schedule-next">Siguiente ‚Üí</button>
                    </div>
                </div>
                
                <!-- Step 2: Calendar Selection -->
                <div id="admin-schedule-step2" style="display: none;">
                    <div class="event-detail-header">
                        <h3>üìÖ Seleccionar Horarios - Paso 2/2</h3>
                        <button type="button" class="event-detail-close" id="admin-schedule-close-step2">√ó</button>
                    </div>
                    <div class="event-detail-body">
                        <div style="background: linear-gradient(135deg, #B8A99A 0%, #D4C5B9 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                            <p style="margin: 0; color: #1a1a1a; font-size: 1.1rem; font-weight: 600;">
                                <strong id="admin-schedule-client-name-display" style="color: #1a1a1a;"></strong> - 
                                <span id="admin-schedule-selected-count" style="color: #1a1a1a; font-size: 1.3rem; font-weight: 700;">0</span> de 
                                <span id="admin-schedule-total-classes" style="color: #1a1a1a; font-size: 1.3rem; font-weight: 700;">0</span> clases seleccionadas
                            </p>
                        </div>
                        <!-- Horizontal container for calendar and selected times on desktop -->
                        <div class="admin-schedule-horizontal-container">
                            <!-- Calendar for admin scheduling -->
                            <div class="admin-schedule-calendar-wrapper">
                                <div id="admin-schedule-calendar"></div>
                            </div>
                            
                            <!-- Selected times list -->
                            <div id="admin-selected-times-container" class="admin-selected-times-wrapper" style="display: none;">
                                <h4 style="color: #1a1a1a; margin-bottom: 20px; font-size: 1.5rem; font-weight: 800; border-bottom: 3px solid #B8A99A; padding-bottom: 15px; text-align: center;">‚úÖ Horarios seleccionados:</h4>
                                <div id="admin-selected-times-list" style="max-height: 500px; overflow-y: auto; padding-right: 10px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="event-detail-actions">
                        <button type="button" class="btn-secondary" id="admin-schedule-back">‚Üê Atr√°s</button>
                        <button type="button" class="btn-primary" id="admin-schedule-confirm">‚úÖ Confirmar Reservas</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== 6.5. Admin Scheduling Section (Full Page) ========== -->
    <section id="admin-scheduling-section" class="admin-scheduling-section" style="display: none;">
        <div class="admin-scheduling-container">
            <!-- Back Button -->
            <div style="max-width: 1400px; margin: 0 auto; padding: 20px 20px 0 20px;">
                <button type="button" id="back-to-admin-panel" class="btn-secondary" style="margin-bottom: 20px;">‚Üê Volver al Panel</button>
            </div>
            
            <!-- Step 1: Client Info & Package Selection -->
            <div id="admin-schedule-step1-fullpage">
                <div class="admin-schedule-content">
                    <div class="admin-schedule-header">
                        <h2>üìÖ Agendar Nueva Clase - Paso 1/2</h2>
                    </div>
                    <div class="admin-schedule-body">
                        <div class="admin-schedule-row">
                            <div class="admin-schedule-icon">üë§</div>
                            <div class="admin-schedule-info" style="width: 100%;">
                                <div class="admin-schedule-label">Nombre del Cliente *</div>
                                <input type="text" id="admin-schedule-name-fullpage" required style="width: 100%; padding: 10px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 8px; font-size: 1rem; margin-top: 5px;">
                            </div>
                        </div>
                        <div class="admin-schedule-row">
                            <div class="admin-schedule-icon">üì±</div>
                            <div class="admin-schedule-info" style="width: 100%;">
                                <div class="admin-schedule-label">Tel√©fono * (10 d√≠gitos)</div>
                                <input type="tel" id="admin-schedule-phone-fullpage" required pattern="[0-9]{10}" placeholder="10 d√≠gitos sin guiones" style="width: 100%; padding: 10px; border: 2px solid rgba(239, 233, 225, 0.3); border-radius: 8px; font-size: 1rem; margin-top: 5px;">
                            </div>
                        </div>
                        <div class="admin-schedule-row">
                            <div class="admin-schedule-icon">üì¶</div>
                            <div class="admin-schedule-info" style="width: 100%;">
                                <div class="admin-schedule-label">N√∫mero de Clases *</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <button type="button" class="admin-package-btn-fullpage" data-classes="1">1 Clase</button>
                                    <button type="button" class="admin-package-btn-fullpage" data-classes="4">4 Clases</button>
                                    <button type="button" class="admin-package-btn-fullpage" data-classes="8">8 Clases</button>
                                    <button type="button" class="admin-package-btn-fullpage" data-classes="12">12 Clases</button>
                                </div>
                                <input type="hidden" id="admin-schedule-package-fullpage" required>
                            </div>
                        </div>
                    </div>
                    <div class="admin-schedule-actions">
                        <button type="button" class="btn-secondary" id="admin-schedule-cancel-step1-fullpage">Cancelar</button>
                        <button type="button" class="btn-primary" id="admin-schedule-next-fullpage">Siguiente ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Calendar Selection -->
            <div id="admin-schedule-step2-fullpage" style="display: none;">
                <div class="admin-schedule-content">
                    <div class="admin-schedule-header">
                        <h2>üìÖ Seleccionar Horarios - Paso 2/2</h2>
                    </div>
                    <div class="admin-schedule-body">
                        <div style="background: linear-gradient(135deg, #B8A99A 0%, #D4C5B9 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                            <p style="margin: 0; color: #1a1a1a; font-size: 1.1rem; font-weight: 600;">
                                <strong id="admin-schedule-client-name-display-fullpage" style="color: #1a1a1a;"></strong> - 
                                <span id="admin-schedule-selected-count-fullpage" style="color: #1a1a1a; font-size: 1.3rem; font-weight: 700;">0</span> de 
                                <span id="admin-schedule-total-classes-fullpage" style="color: #1a1a1a; font-size: 1.3rem; font-weight: 700;">0</span> clases seleccionadas
                            </p>
                        </div>
                        <!-- Horizontal container for calendar and selected times on desktop -->
                        <div class="admin-schedule-horizontal-container">
                            <!-- Calendar for admin scheduling -->
                            <div class="admin-schedule-calendar-wrapper">
                                <div id="admin-schedule-calendar-fullpage"></div>
                            </div>
                            
                            <!-- Selected times list -->
                            <div id="admin-selected-times-container-fullpage" class="admin-selected-times-wrapper" style="display: none;">
                                <h4 style="color: #1a1a1a; margin-bottom: 20px; font-size: 1.5rem; font-weight: 800; border-bottom: 3px solid #B8A99A; padding-bottom: 15px; text-align: center;">‚úÖ Horarios seleccionados:</h4>
                                <div id="admin-selected-times-list-fullpage" style="max-height: 500px; overflow-y: auto; padding-right: 10px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="admin-schedule-actions">
                        <button type="button" class="btn-secondary" id="admin-schedule-back-fullpage">‚Üê Atr√°s</button>
                        <button type="button" class="btn-primary" id="admin-schedule-confirm-fullpage">‚úÖ Confirmar Reservas</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== 7. Contact Section ========== -->
    <section class="contact-section">
        <h2>Comun√≠cate con Nosotros</h2>
        <p>WhatsApp</p>
        <p>¬øPreguntas?</p>
        <p>¬°Estamos aqu√≠ para ti!</p>
        <p>Escr√≠benos y nuestro equipo te dar√° seguimiento exclusivo.</p>
        <a href="#" class="contact-btn" target="_blank" onclick="event.preventDefault(); window.open('https://wa.me/+' + atob('NTI3MTUxNTk2NTg2'), '_blank');">Env√≠anos un mensaje</a>
        <p class="hours">Abre hoy: 06:00 a.m. ‚Äì 07:00 p.m. (√∫ltima clase)</p>
    </section>

    <!-- ========== 8. Reglamento Link Section ========== -->
    <section class="reglamento-link">
        <a id="reglamento-link" href="javascript:void(0);">Leer Reglamento Aura</a>
    </section>

    <!-- ========== Reglamento Modal ========== -->
    <div id="reglamento-modal" class="reglamento-modal">
        <div class="reglamento-content">
            <h2>REGLAMENTO</h2>
            <p>El objetivo de estas reglas es asegurar un ambiente seguro, respetuoso y √≥ptimo para la pr√°ctica de Pilates de todos nuestros alumnos.</p>
            
            <h3>Salud y seguridad Tu bienestar es lo primero!</h3>
            <p>Es obligatorio notificar a tu instructor sobre cualquier lesi√≥n, dolor cr√≥nico, embarazo o condici√≥n m√©dica antes de iniciar la clase. Esto permite adaptar los ejercicios a tus necesidades.</p>
            
            <h3>Escucha a tu cuerpo</h3>
            <p>Si sientes dolor, mareo o malestar, detente inmediatamente e informa a tu instructor. Los ejercicios no son obligatorios si causan incomodidad.</p>
            
            <h3>Uso del equipo</h3>
            <p>Utiliza el equipo siguiendo estrictamente las indicaciones del instructor para evitar accidentes y da√±os al material.</p>
            
            <h3>Calcetines antideslizantes</h3>
            <p>Es imprescindible usar calcetines antideslizantes en todo momento dentro del estudio, por motivos de higiene y seguridad.</p>
            
            <h3>Ropa adecuada</h3>
            <p>Asiste con ropa deportiva c√≥moda y limpia. Se recomienda ropa ajustada para que el instructor pueda observar mejor tu alineaci√≥n.</p>
            
            <h3>Limpieza del equipo</h3>
            <p>Al finalizar tu sesi√≥n, por favor limpia el equipo que utilizaste (Reformer, accesorios, etc.) con los productos de higiene que el estudio proporciona.</p>
            
            <h3>Toalla personal</h3>
            <p>Te sugerimos traer una toalla de mano para el sudor, y en algunos casos, para colocar sobre el equipo.</p>
            
            <h3>Hidrataci√≥n</h3>
            <p>Solo se permite ingresar al estudio con botellas de agua cerradas y con tapa.</p>
            
            <h3>Locker y pertenencias</h3>
            <p>Los lockers se pueden usar durante el tiempo que el alumno permanezca en las instalaciones del estudio. No se permite dejar objetos personales despu√©s de finalizar su clase. De lo contrario, Aura Studio no se hace responsable por p√©rdidas.</p>
            
            <h3>Ingreso exclusivo para usuarios inscritos</h3>
            <p>Es obligatorio registrar la entrada y no se permite el ingreso de acompa√±antes, para mayor comodidad de todos.</p>
            
            <h3>Reservaciones</h3>
            <p>Al momento de reservar se debe depositar el pago de la clase/paquete, de lo contrario no se tomar√° en cuenta su reservaci√≥n. Reserva de clases Es obligatorio reservar las clases con antelaci√≥n.</p>
            
            <h3>CLASES NO TRANSFERIBLES</h3>
            <p>Las reservas y las cuotas suelen ser personales e intransferibles, por ninguna circunstancia.</p>
            
            <h3>Pago Anticipado</h3>
            <p>Los pagos de nuevos paquetes deben ser cubiertos en un lapso de 1-2 d√≠as antes de que este inicie.</p>
            
            <h3>Clases NO Reembolsables</h3>
            <p>Las clases no son reembolsables ni transferibles, en dado caso de no asistir, clase perdida.</p>
            
            <h3>Clases no modificables</h3>
            <p>Responsabilidad a la hora de agendar, porque los horarios no pueden ser modificados.</p>
            
            <h3>Tel√©fono M√≥vil</h3>
            <p>Debe estar en silencio o apagado durante toda la sesi√≥n, para evitar interrupciones y fomentar la concentraci√≥n.</p>
            
            <h3>Respeto</h3>
            <p>Mantener comportamiento respetuoso hacia los instructores, personal y dem√°s clientes.</p>
            
            <h3>Equipos y espacios</h3>
            <p>Cuida los aparatos, NO azotar las m√°quinas ni dejar caer el material de entrenamiento.</p>
            
            <h3>Sanciones</h3>
            <p>El incumplimiento del reglamento puede acarrear llamados de atenci√≥n, suspensi√≥n temporal o cancelaci√≥n de la membres√≠a.</p>
            
            <h3>Grabaciones</h3>
            <p>Por respeto a la privacidad y derechos de autor, no se permite grabar las clases completas.</p>
            
            <h3>Tolerancia</h3>
            <p>Las clases comienzan a la hora establecida. Tolerancia de 5 minutos para ingresar, y no se permite el acceso despu√©s de ese tiempo para evitar interrupciones y, lo m√°s importante, asegurar que el alumno realice el calentamiento completo para prevenir lesiones.</p>
            
            <p style="text-align: center; margin-top: 30px; font-weight: 600;">Agradecemos su comprensi√≥n.<br>Aura Studio</p>
            
            <button type="button" class="reglamento-close" id="reglamento-close">Cerrar</button>
        </div>
    </div>

    <!-- FullCalendar v6.1.15 JS desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <!-- FullCalendar locales para espa√±ol -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales/es.global.min.js"></script>
    
    <!-- ========== Hamburger Menu Functionality ========== -->
    <script>
        /*
         * Funcionalidad del Men√∫ Hamburguesa
         * - Toggle para mostrar/ocultar men√∫
         * - Navegaci√≥n a modales de registro y login
         * - Bot√≥n de logout visible solo cuando hay sesi√≥n activa
         * - Accesibilidad con ARIA labels
         * - Responsive y funcional en m√≥viles
         */
        
        document.addEventListener('DOMContentLoaded', () => {
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const menuDropdown = document.getElementById('menu-dropdown');
            const menuRegister = document.getElementById('menu-register');
            const menuMyClasses = document.getElementById('menu-my-classes');
            const menuAdminLogin = document.getElementById('menu-admin-login');
            const menuLogout = document.getElementById('menu-logout');
            
            const registerModal = document.getElementById('register-modal');
            const userLoginModal = document.getElementById('user-login-modal');
            const userLoginCancel = document.getElementById('user-login-cancel');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminLoginCancel = document.getElementById('admin-login-cancel');
            
            // Toggle hamburger menu
            hamburgerBtn.addEventListener('click', () => {
                const isOpen = menuDropdown.style.display === 'block';
                menuDropdown.style.display = isOpen ? 'none' : 'block';
                hamburgerBtn.setAttribute('aria-expanded', !isOpen);
                menuDropdown.setAttribute('aria-hidden', isOpen);
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!hamburgerBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
                    menuDropdown.style.display = 'none';
                    hamburgerBtn.setAttribute('aria-expanded', 'false');
                    menuDropdown.setAttribute('aria-hidden', 'true');
                }
            });
            
            // Hover effects for menu items
            const menuItems = [menuRegister, menuMyClasses, menuAdminLogin, menuLogout];
            const menuBack = document.getElementById('menu-back');
            if (menuBack) {
                menuItems.push(menuBack);
            }
            menuItems.forEach(item => {
                if (item) {
                    item.addEventListener('mouseenter', () => {
                        item.style.background = 'linear-gradient(135deg, #EFE9E1 0%, #EFE9E1 100%)';
                    });
                    item.addEventListener('mouseleave', () => {
                        item.style.background = 'transparent';
                    });
                }
            });
            
            // Show register modal
            menuRegister.addEventListener('click', () => {
                menuDropdown.style.display = 'none';
                hamburgerBtn.setAttribute('aria-expanded', 'false');
                menuDropdown.setAttribute('aria-hidden', 'true');
                registerModal.style.display = 'flex';
                document.getElementById('quick-name').focus();
            });
            
            // Show user login modal (Iniciar Sesi√≥n)
            menuMyClasses.addEventListener('click', () => {
                menuDropdown.style.display = 'none';
                hamburgerBtn.setAttribute('aria-expanded', 'false');
                menuDropdown.setAttribute('aria-hidden', 'true');
                userLoginModal.style.display = 'flex';
                document.getElementById('user-login-phone').focus();
            });
            
            // Handle "Volver Atr√°s" button - go back to main page
            if (menuBack) {
                menuBack.addEventListener('click', () => {
                    menuDropdown.style.display = 'none';
                    hamburgerBtn.setAttribute('aria-expanded', 'false');
                    menuDropdown.setAttribute('aria-hidden', 'true');
                    
                    // Show all sections again
                    if (typeof window.showAllSectionsExceptAdmin === 'function') {
                        window.showAllSectionsExceptAdmin();
                    }
                    
                    // Hide "Mis Clases" section
                    hideUserClasses();
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // Close user login modal
            userLoginCancel.addEventListener('click', () => {
                userLoginModal.style.display = 'none';
                document.getElementById('user-login-form').reset();
                document.getElementById('user-login-error').style.display = 'none';
            });
            
            // Close user login modal when clicking outside
            userLoginModal.addEventListener('click', (e) => {
                if (e.target === userLoginModal) {
                    userLoginModal.style.display = 'none';
                    document.getElementById('user-login-form').reset();
                    document.getElementById('user-login-error').style.display = 'none';
                }
            });
            
            // Handle user login form submission (Mis Clases)
            document.getElementById('user-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const phoneDigits = document.getElementById('user-login-phone').value.trim();
                const errorDiv = document.getElementById('user-login-error');
                
                // Validate phone number
                if (!phoneDigits || !/^\d{10}$/.test(phoneDigits)) {
                    errorDiv.textContent = '‚ö†Ô∏è Ingresa 10 d√≠gitos del tel√©fono';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const phoneWithCountryCode = '+52' + phoneDigits;
                
                // Check if Firebase is ready
                if (!window.firebaseReady || !window.auth) {
                    errorDiv.textContent = '‚ö†Ô∏è Sistema inicializando. Por favor, espera unos segundos e intenta nuevamente.';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Use Firebase Phone Authentication
                try {
                    const { signInWithPhoneNumber, RecaptchaVerifier } = window.firebaseAuthExports || {};
                    
                    if (!signInWithPhoneNumber || !RecaptchaVerifier) {
                        console.error('‚ùå Firebase Auth functions not available');
                        throw new Error('Sistema de autenticaci√≥n no disponible');
                    }
                    
                    // Ensure reCAPTCHA verifier exists - reuse global instance
                    if (!window.recaptchaVerifier) {
                        console.error('‚ùå reCAPTCHA verifier no est√° inicializado');
                        throw new Error('Sistema de autenticaci√≥n no est√° listo. Por favor, espera unos segundos e intenta nuevamente.');
                    }
                    
                    console.log('‚úÖ Usando reCAPTCHA verifier global existente');
                    
                    console.log('üì± Enviando c√≥digo de verificaci√≥n para login:', phoneWithCountryCode);
                    
                    // Send verification code
                    const confirmationResult = await signInWithPhoneNumber(window.auth, phoneWithCountryCode, window.recaptchaVerifier);
                    
                    // Store confirmation result and phone data for verification step
                    window.phoneLoginData = {
                        confirmationResult,
                        phoneDigits,
                        phoneWithCountryCode
                    };
                    
                    console.log('‚úÖ C√≥digo enviado para login');
                    
                    // Hide login modal
                    userLoginModal.style.display = 'none';
                    document.getElementById('user-login-form').reset();
                    errorDiv.style.display = 'none';
                    
                    // Show verification code modal for login
                    document.getElementById('verification-code-modal-login').style.display = 'flex';
                    document.getElementById('verification-code-input-login').focus();
                    
                } catch (error) {
                    console.error('Error during user login:', error);
                    
                    // Handle Firebase Authentication errors
                    let errorMessage = '‚ùå ';
                    
                    if (error.code === 'auth/invalid-phone-number') {
                        errorMessage += 'N√∫mero de tel√©fono no v√°lido. Verifica que sea correcto.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage += 'Demasiados intentos. Por favor, espera unos minutos e intenta nuevamente.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage += 'Error de conexi√≥n. Verifica tu internet e intenta nuevamente.';
                    } else if (error.message) {
                        errorMessage += error.message;
                    } else {
                        errorMessage += 'Error al enviar c√≥digo. Intenta nuevamente.';
                    }
                    
                    errorDiv.textContent = errorMessage;
                    errorDiv.style.display = 'block';
                    
                    // Note: We don't clear the reCAPTCHA verifier on error
                    // to allow the user to retry without reloading the page.
                    // The global verifier will be reused on the next attempt.
                }
            });
            
            // ========== PHONE VERIFICATION HANDLERS FOR LOGIN ==========
            
            const verifyBtnLogin = document.getElementById('verify-code-btn-login');
            const cancelBtnLogin = document.getElementById('cancel-verification-btn-login');
            const resendBtnLogin = document.getElementById('resend-code-btn-login');
            const codeInputLogin = document.getElementById('verification-code-input-login');
            const errorDivLogin = document.getElementById('verification-error-login');
            const modalLogin = document.getElementById('verification-code-modal-login');
            
            if (verifyBtnLogin) {
                verifyBtnLogin.addEventListener('click', async () => {
                    const code = codeInputLogin.value.trim();
                    
                    if (!code || code.length !== 6) {
                        errorDivLogin.textContent = '‚ö†Ô∏è Ingresa el c√≥digo de 6 d√≠gitos';
                        errorDivLogin.style.display = 'block';
                        return;
                    }
                    
                    if (!window.phoneLoginData || !window.phoneLoginData.confirmationResult) {
                        errorDivLogin.textContent = '‚ùå Error: Sesi√≥n expirada. Por favor, intenta iniciar sesi√≥n nuevamente.';
                        errorDivLogin.style.display = 'block';
                        return;
                    }
                    
                    try {
                        console.log('üîê Verificando c√≥digo de login...');
                        
                        // Verify the code
                        const result = await window.phoneLoginData.confirmationResult.confirm(code);
                        const user = result.user;
                        
                        console.log('‚úÖ Login exitoso! UID:', user.uid);
                        console.log('üì± Tel√©fono:', user.phoneNumber);
                        
                        // Get user data
                        const { phoneDigits, phoneWithCountryCode } = window.phoneLoginData;
                        const userName = localStorage.getItem('userName_' + phoneDigits) || 'Usuario';
                        
                        // Store user info in localStorage
                        localStorage.setItem('userNombre', userName);
                        localStorage.setItem('userTelefono', phoneWithCountryCode);
                        localStorage.setItem('userLoggedIn', 'true');
                        
                        // Close verification modal
                        modalLogin.style.display = 'none';
                        codeInputLogin.value = '';
                        errorDivLogin.style.display = 'none';
                        
                        // Clear login data
                        window.phoneLoginData = null;
                        
                        // Update UI for logged in user
                        if (typeof window.updateUIForLoggedInUser === 'function') {
                            window.updateUIForLoggedInUser();
                        }
                        
                        // Load user's classes
                        if (typeof window.loadUserClasses === 'function') {
                            await window.loadUserClasses(phoneWithCountryCode);
                            
                            // Scroll to My Classes section
                            const myClassesSection = document.getElementById('my-classes-section');
                            if (myClassesSection) {
                                setTimeout(() => {
                                    myClassesSection.scrollIntoView({ behavior: 'smooth' });
                                }, 300);
                            }
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error al verificar c√≥digo de login:', error);
                        
                        let errorMessage = '‚ùå ';
                        if (error.code === 'auth/invalid-verification-code') {
                            errorMessage += 'C√≥digo incorrecto. Verifica e intenta nuevamente.';
                        } else if (error.code === 'auth/code-expired') {
                            errorMessage += 'C√≥digo expirado. Por favor, solicita un nuevo c√≥digo.';
                        } else if (error.message) {
                            errorMessage += error.message;
                        } else {
                            errorMessage += 'Error al verificar c√≥digo. Intenta nuevamente.';
                        }
                        
                        errorDivLogin.textContent = errorMessage;
                        errorDivLogin.style.display = 'block';
                    }
                });
            }
            
            if (cancelBtnLogin) {
                cancelBtnLogin.addEventListener('click', () => {
                    modalLogin.style.display = 'none';
                    codeInputLogin.value = '';
                    errorDivLogin.style.display = 'none';
                    window.phoneLoginData = null;
                    
                    // Show login modal again
                    userLoginModal.style.display = 'flex';
                });
            }
            
            if (resendBtnLogin) {
                resendBtnLogin.addEventListener('click', async () => {
                    if (!window.phoneLoginData) {
                        errorDivLogin.textContent = '‚ùå Error: Sesi√≥n expirada. Por favor, cierra e intenta iniciar sesi√≥n nuevamente.';
                        errorDivLogin.style.display = 'block';
                        return;
                    }
                    
                    try {
                        const { phoneWithCountryCode } = window.phoneLoginData;
                        
                        // Ensure reCAPTCHA verifier exists - reuse global instance
                        if (!window.recaptchaVerifier) {
                            console.error('‚ùå reCAPTCHA verifier no est√° inicializado');
                            errorDivLogin.textContent = '‚ùå Error: Sistema no est√° listo. Por favor, espera unos segundos e intenta nuevamente.';
                            errorDivLogin.style.display = 'block';
                            return;
                        }
                        
                        console.log('üì± Reenviando c√≥digo de login a:', phoneWithCountryCode);
                        console.log('‚úÖ Usando reCAPTCHA verifier global existente');
                        
                        // Resend code
                        const { signInWithPhoneNumber } = window.firebaseAuthExports || {};
                        const confirmationResult = await signInWithPhoneNumber(window.auth, phoneWithCountryCode, window.recaptchaVerifier);
                        
                        // Update confirmation result
                        window.phoneLoginData.confirmationResult = confirmationResult;
                        
                        console.log('‚úÖ C√≥digo reenviado');
                        errorDivLogin.textContent = '‚úÖ C√≥digo reenviado exitosamente';
                        errorDivLogin.style.display = 'block';
                        errorDivLogin.style.background = 'rgba(76, 175, 80, 0.1)';
                        errorDivLogin.style.color = '#4CAF50';
                        
                        // Reset error styling after 3 seconds
                        setTimeout(() => {
                            errorDivLogin.style.display = 'none';
                            errorDivLogin.style.background = 'rgba(197, 17, 98, 0.1)';
                            errorDivLogin.style.color = '#C51162';
                        }, 3000);
                        
                    } catch (error) {
                        console.error('‚ùå Error al reenviar c√≥digo:', error);
                        errorDivLogin.textContent = '‚ùå Error al reenviar c√≥digo. Intenta nuevamente.';
                        errorDivLogin.style.display = 'block';
                    }
                });
            }
            
            // Password visibility toggle for registration form
            const toggleRegisterPassword = document.getElementById('toggle-register-password');
            const registerPasswordInput = document.getElementById('quick-password');
            if (toggleRegisterPassword && registerPasswordInput) {
                toggleRegisterPassword.addEventListener('click', () => {
                    const type = registerPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    registerPasswordInput.setAttribute('type', type);
                    // Toggle icon between eye and eye-slash
                    toggleRegisterPassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                    toggleRegisterPassword.setAttribute('aria-label', type === 'password' ? 'Mostrar contrase√±a' : 'Ocultar contrase√±a');
                });
            }
            
            // Password visibility toggle for login form
            const toggleLoginPassword = document.getElementById('toggle-login-password');
            const loginPasswordInput = document.getElementById('user-login-password');
            if (toggleLoginPassword && loginPasswordInput) {
                toggleLoginPassword.addEventListener('click', () => {
                    const type = loginPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    loginPasswordInput.setAttribute('type', type);
                    // Toggle icon between eye and eye-slash
                    toggleLoginPassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                    toggleLoginPassword.setAttribute('aria-label', type === 'password' ? 'Mostrar contrase√±a' : 'Ocultar contrase√±a');
                });
            }
            
            // Password visibility toggle for reservation modal
            const toggleReservationPassword = document.getElementById('toggle-reservation-password');
            const reservationPasswordInput = document.getElementById('reservation-password');
            if (toggleReservationPassword && reservationPasswordInput) {
                toggleReservationPassword.addEventListener('click', () => {
                    const type = reservationPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    reservationPasswordInput.setAttribute('type', type);
                    // Toggle icon between eye and eye-slash
                    toggleReservationPassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                    toggleReservationPassword.setAttribute('aria-label', type === 'password' ? 'Mostrar contrase√±a' : 'Ocultar contrase√±a');
                });
            }
            
            // Password visibility toggle for legacy password modal
            const toggleLegacyPassword = document.getElementById('toggle-legacy-password');
            const legacyPasswordInput = document.getElementById('legacy-new-password');
            if (toggleLegacyPassword && legacyPasswordInput) {
                toggleLegacyPassword.addEventListener('click', () => {
                    const type = legacyPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    legacyPasswordInput.setAttribute('type', type);
                    // Toggle icon between eye and eye-slash
                    toggleLegacyPassword.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                    toggleLegacyPassword.setAttribute('aria-label', type === 'password' ? 'Mostrar contrase√±a' : 'Ocultar contrase√±a');
                });
            }
            
            // Setup legacy password creation modal handlers
            const legacyPasswordModal = document.getElementById('create-password-modal');
            const legacyPasswordConfirm = document.getElementById('legacy-password-confirm');
            const legacyPasswordCancel = document.getElementById('legacy-password-cancel');
            const legacyPasswordError = document.getElementById('legacy-password-error');
            
            if (legacyPasswordCancel) {
                legacyPasswordCancel.addEventListener('click', () => {
                    legacyPasswordModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    legacyPasswordInput.value = '';
                    legacyPasswordError.style.display = 'none';
                });
            }
            
            // Close legacy password modal on background click
            if (legacyPasswordModal) {
                legacyPasswordModal.addEventListener('click', (e) => {
                    if (e.target === legacyPasswordModal) {
                        legacyPasswordModal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        legacyPasswordInput.value = '';
                        legacyPasswordError.style.display = 'none';
                    }
                });
            }
            
            // Show admin login modal
            menuAdminLogin.addEventListener('click', () => {
                menuDropdown.style.display = 'none';
                hamburgerBtn.setAttribute('aria-expanded', 'false');
                menuDropdown.setAttribute('aria-hidden', 'true');
                adminLoginModal.style.display = 'flex';
                document.body.classList.add('modal-open');
                document.getElementById('admin-email').focus();
            });
            
            // Close admin login modal
            adminLoginCancel.addEventListener('click', () => {
                adminLoginModal.style.display = 'none';
                document.body.classList.remove('modal-open');
                document.getElementById('admin-login-form').reset();
                document.getElementById('login-error').style.display = 'none';
            });
            
            // Close time selection modal
            const timeCancel = document.getElementById('time-cancel');
            const timeModal = document.getElementById('time-selection-modal');
            
            timeCancel.addEventListener('click', () => {
                // Clear the time slots container to prevent any potential duplication issues
                const slotsContainer = document.getElementById('time-slots-container');
                if (slotsContainer) {
                    slotsContainer.innerHTML = '';
                }
                timeModal.style.display = 'none';
                document.body.style.overflow = ''; // Restore scrolling
            });

            // ========== Reglamento Modal Functionality ==========
            const reglamentoLink = document.getElementById('reglamento-link');
            const reglamentoModal = document.getElementById('reglamento-modal');
            const reglamentoClose = document.getElementById('reglamento-close');

            // Open reglamento modal
            reglamentoLink.addEventListener('click', () => {
                reglamentoModal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            });

            // Close reglamento modal
            reglamentoClose.addEventListener('click', () => {
                reglamentoModal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            });

            // Close modal when clicking outside the content
            reglamentoModal.addEventListener('click', (e) => {
                if (e.target === reglamentoModal) {
                    reglamentoModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });

            // Close modal with ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && reglamentoModal.style.display === 'flex') {
                    reglamentoModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
            
            // Close modals on ESC key
            const reservationModal = document.getElementById('reservation-modal');
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Check if time-selection-modal or reservation-modal is visible before closing
                    if (timeModal.style.display === 'flex' || reservationModal.style.display === 'flex') {
                        document.body.style.overflow = ''; // Restore scrolling
                        // Clear the time slots container when closing
                        const slotsContainer = document.getElementById('time-slots-container');
                        if (slotsContainer && timeModal.style.display === 'flex') {
                            slotsContainer.innerHTML = '';
                        }
                    }
                    registerModal.style.display = 'none';
                    // Reset user login modal when closing with ESC
                    if (userLoginModal.style.display === 'flex') {
                        document.getElementById('user-login-form').reset();
                        document.getElementById('user-login-error').style.display = 'none';
                    }
                    userLoginModal.style.display = 'none';
                    adminLoginModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    timeModal.style.display = 'none';
                    reservationModal.style.display = 'none';
                    menuDropdown.style.display = 'none';
                    hamburgerBtn.setAttribute('aria-expanded', 'false');
                    menuDropdown.setAttribute('aria-hidden', 'true');
                }
            });
            
            // Close modals when clicking outside
            registerModal.addEventListener('click', (e) => {
                if (e.target === registerModal) {
                    registerModal.style.display = 'none';
                    // Clear input fields
                    document.getElementById('quick-name').value = '';
                    document.getElementById('quick-phone-digits').value = '';
                    document.getElementById('quick-password').value = '';
                }
            });
            
            adminLoginModal.addEventListener('click', (e) => {
                if (e.target === adminLoginModal) {
                    adminLoginModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    document.getElementById('admin-login-form').reset();
                    document.getElementById('login-error').style.display = 'none';
                }
            });
            
            timeModal.addEventListener('click', (e) => {
                if (e.target === timeModal) {
                    timeModal.style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling
                }
            });
            
            // Close reservation modal when clicking outside
            reservationModal.addEventListener('click', (e) => {
                if (e.target === reservationModal) {
                    reservationModal.style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling
                }
            });
            
            // Hover effects for buttons
            const submitButtons = document.querySelectorAll('button[type="submit"]');
            submitButtons.forEach(btn => {
                if (btn.style.background && btn.style.background.includes('f6c8c7')) {
                    btn.addEventListener('mouseenter', () => {
                        btn.style.transform = 'translateY(-2px)';
                        btn.style.boxShadow = '0 8px 20px rgba(239, 233, 225, 0.5)';
                    });
                    btn.addEventListener('mouseleave', () => {
                        btn.style.transform = 'translateY(0)';
                        btn.style.boxShadow = '0 4px 15px rgba(239, 233, 225, 0.3)';
                    });
                }
            });
            
            // Hover effect for hamburger button
            hamburgerBtn.addEventListener('mouseenter', () => {
                hamburgerBtn.style.transform = 'scale(1.1)';
                hamburgerBtn.style.transition = 'transform 0.2s ease';
            });
            hamburgerBtn.addEventListener('mouseleave', () => {
                hamburgerBtn.style.transform = 'scale(1)';
            });
        });
    </script>

    <!-- ========== Instagram-style Like Functionality for Images ========== -->
    <script>
        /**
         * Like/Unlike functionality for facility images
         * Instagram-style animation with heart burst effect
         */
        function likeImage(imageWrapper) {
            const heartOverlay = imageWrapper.querySelector('.heart-overlay');
            const isLiked = heartOverlay.classList.contains('liked');
            
            if (isLiked) {
                // Unlike: change back to outline
                heartOverlay.classList.remove('liked');
                heartOverlay.textContent = '‚ô°'; // Outline heart
            } else {
                // Like: fill the heart with animation
                heartOverlay.classList.add('liked');
                heartOverlay.textContent = '‚ô•'; // Filled heart
                
                // Create and show burst animation
                const burst = document.createElement('div');
                burst.className = 'like-burst';
                burst.textContent = '‚ô•';
                imageWrapper.appendChild(burst);
                
                // Remove burst element after animation completes
                setTimeout(() => {
                    burst.remove();
                }, 800);
            }
        }

        /**
         * Toggle Pilates card to show/hide text overlay
         * When clicked, shows text overlay on the image
         * Click again to hide the text
         */
        function togglePilatesCard(card) {
            // Close all other cards first
            const allCards = document.querySelectorAll('.pilates-card');
            allCards.forEach(c => {
                if (c !== card) {
                    c.classList.remove('active');
                }
            });
            
            // Toggle current card
            card.classList.toggle('active');
        }
    </script>
    
    <script>
        /*
         * ========== FULLCALENDAR v6.1.15 + FIREBASE INTEGRATION ==========
         * 
         * Implementaci√≥n de FullCalendar para AURA Studio con integraci√≥n Firebase:
         * - Vista mensual inicial (dayGridMonth) con opci√≥n a vista semanal (timeGridWeek)
         * - Calendario en espa√±ol (locale: 'es')
         * - Carga din√°mica de eventos desde Firestore colecci√≥n 'reservas'
         * - Al hacer clic en una fecha: mostrar formulario de reservas
         * - Filtrado admin vs p√∫blico: el admin ve todo, otros usuarios ven clases p√∫blicas
         * - Guarda reservas en Firestore y actualiza calendario en tiempo real
         * - Responsive y centrado con m√°ximo 900px de ancho
         * 
         * FORMATO DE FECHAS (REQUISITO):
         * - fechaHora se guarda en formato ISO: YYYY-MM-DDTHH:mm:ss
         * - Ejemplo: "2025-11-15T10:00:00"
         * - En la tabla de admin se formatea a texto legible en espa√±ol
         * - Compatible con parseo est√°ndar de JavaScript Date
         * 
         * DEBUGGING:
         * - Verifica que el CDN de FullCalendar v6.1.15 est√© cargado
         * - Verifica que Firebase est√© inicializado correctamente
         * - Verifica que el div #calendar exista en el DOM
         * - Revisa la consola para errores de red o permisos de Firestore
         * - Verifica que fechaHora est√© en formato ISO en Firestore
         */
        
        let calendar;
        let selectedPlan = {
            classes: 0,
            price: 0,
            bookedClasses: 0,
            bookedEvents: [],
            userInfo: null  // Guardar√° info del cliente (nombre, email, notas)
        };
        
        // Variable global para saber si el usuario es admin
        let isAdmin = false;

        // Helper function to detect payment return parameters
        function isPaymentReturnFromMercadoPago() {
            const params = new URLSearchParams(location.search);
            return params.has('success') || 
                   params.has('payment_id') || 
                   params.has('collection_id') || 
                   params.has('status') ||
                   params.has('error') ||
                   params.has('pending');
        }
        
        // FIX #1: Hacer selectPlan global (window.selectPlan)
        // NUEVO FLUJO: Mostrar calendario inmediatamente, pedir datos por reserva
        window.selectPlan = async function(classes, price, options = {}) {
            console.log(`üìÖ selectPlan llamado: ${classes} clases x $${price}`);
            
            // IMPORTANTE: No limpiar tempReservations si hay un pago pendiente de procesar
            // Esto evita perder las reservas cuando el usuario retorna de MercadoPago
            if (isPaymentReturnFromMercadoPago()) {
                console.log('‚ö†Ô∏è Retorno de pago detectado, no limpiar tempReservations');
                return; // Dejar que detectarRetorno maneje esto
            }
            
            // Limpiar cualquier estado previo de reservas temporales (solo si no es retorno de pago)
            localStorage.removeItem('tempReservations');
            localStorage.removeItem('tempPlanClasses');
            localStorage.removeItem('tempPlanPrice');
            localStorage.removeItem('firstClassDate'); // Limpiar fecha de primera clase
            
            // Guardar plan seleccionado en localStorage (sobrevive al reload)
            localStorage.setItem('tempPlanClasses', classes);
            localStorage.setItem('tempPlanPrice', price);
            
            selectedPlan.classes = classes;
            selectedPlan.price = price;
            selectedPlan.bookedClasses = 0;
            selectedPlan.bookedEvents = [];
            selectedPlan.userInfo = null;
            selectedPlan.firstClassDate = null; // Reset first class date

            // Show calendar immediately WITHOUT requiring login
            const calendarContainer = document.getElementById('calendar-container');
            if (calendarContainer) {
                calendarContainer.style.display = 'block';
                console.log('üìÖ Calendario container mostrado');
            }
            
            // Initialize or update calendar
            if (!calendar) {
                console.log('üìÖ Inicializando calendario...');
                initCalendar();
            } else {
                console.log('üìÖ Calendario ya existe, limpiando eventos temporales...');
                // Limpiar eventos temporales
                selectedPlan.bookedEvents.forEach(eventObj => {
                    const event = calendar.getEventById(eventObj.eventId);
                    if (event) event.remove();
                });
                selectedPlan.bookedEvents = [];
                selectedPlan.bookedClasses = 0;
            }

            // Actualizar el mensaje informativo
            updateCalendarInfo();
            
            // Actualizar contador
            updateClassCounter();
            
            // Ocultar bot√≥n de pago
            hidePaymentButton();

            // Scroll to calendar
            console.log('üìú Scrolling al calendario...');
            setTimeout(() => {
                if (calendarContainer) {
                    calendarContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        };
        
        // Mantener referencia local para compatibilidad
        const selectPlan = window.selectPlan;

        /**
         * Calcular d√≠as h√°biles desde una fecha dada
         * @param {Date} startDate - Fecha de inicio
         * @param {number} businessDays - N√∫mero de d√≠as h√°biles a agregar (puede ser 0)
         * @returns {Date} Fecha final despu√©s de agregar d√≠as h√°biles
         */
        function addBusinessDays(startDate, businessDays) {
            // Validaci√≥n de entrada
            if (!startDate || !(startDate instanceof Date) || isNaN(startDate.getTime())) {
                throw new Error('startDate debe ser un objeto Date v√°lido');
            }
            if (typeof businessDays !== 'number' || businessDays < 0 || !Number.isInteger(businessDays)) {
                throw new Error('businessDays debe ser un n√∫mero entero no negativo');
            }
            
            let currentDate = new Date(startDate);
            let daysAdded = 0;
            
            while (daysAdded < businessDays) {
                currentDate.setDate(currentDate.getDate() + 1);
                // Saltar domingos (0) - los domingos no cuentan como d√≠as h√°biles
                if (currentDate.getDay() !== 0) {
                    daysAdded++;
                }
            }
            
            return currentDate;
        }

        /**
         * Calcular la fecha de expiraci√≥n seg√∫n el paquete seleccionado
         * @param {Date} firstClassDate - Fecha de la primera clase
         * @param {number} classes - N√∫mero de clases del paquete (esperados: 4, 8, 12, 15)
         * @returns {Date} Fecha de expiraci√≥n
         */
        function calculateExpirationDate(firstClassDate, classes) {
            const expirationDate = new Date(firstClassDate);
            
            // Para paquetes de 4 y 8 clases: 14 d√≠as calendario (2 semanas)
            if (classes === 4 || classes === 8) {
                expirationDate.setDate(expirationDate.getDate() + 14);
            }
            // Para paquetes de 12 clases: 24 d√≠as calendario
            else if (classes === 12) {
                expirationDate.setDate(expirationDate.getDate() + 24);
            }
            // Para cualquier otro tama√±o de paquete: 30 d√≠as calendario
            else {
                expirationDate.setDate(expirationDate.getDate() + 30);
            }
            
            return expirationDate;
        }

        /**
         * Obtener informaci√≥n de plazo seg√∫n n√∫mero de clases
         * @param {number} classes - N√∫mero de clases del paquete
         * @returns {Object} Objeto con daysType y daysCount
         */
        function getExpirationInfo(classes) {
            if (classes === 4 || classes === 8) {
                return { daysType: 'd√≠as', daysCount: 14 };
            } else if (classes === 12) {
                return { daysType: 'd√≠as', daysCount: 24 };
            } else {
                return { daysType: 'd√≠as', daysCount: 30 };
            }
        }

        /**
         * Actualizar el validRange del calendario seg√∫n la primera clase seleccionada
         * @param {Date} firstClassDate - Fecha de la primera clase seleccionada
         */
        function updateCalendarValidRange(firstClassDate) {
            if (!calendar) return;
            
            const expirationDate = calculateExpirationDate(firstClassDate, selectedPlan.classes);
            const { daysType, daysCount } = getExpirationInfo(selectedPlan.classes);
            
            // Configurar el rango v√°lido del calendario
            calendar.setOption('validRange', {
                start: new Date(), // Hoy como m√≠nimo
                end: expirationDate // Hasta la fecha de expiraci√≥n
            });
            
            console.log(`üìÖ Rango del calendario actualizado: hasta ${expirationDate.toLocaleDateString('es-ES')}`);
            
            // Mostrar mensaje informativo al usuario
            showCustomAlert(
                `Tienes ${daysCount} ${daysType} desde tu primera clase (${firstClassDate.toLocaleDateString('es-ES')}) para completar todas tus clases.\n\nFecha l√≠mite: ${expirationDate.toLocaleDateString('es-ES')}`,
                'info',
                'üìÖ Importante'
            );
        }

        // Funci√≥n para actualizar el mensaje informativo del calendario
        function updateCalendarInfo() {
            const infoDiv = document.querySelector('.calendar-info h3');
            if (infoDiv && selectedPlan.classes > 0) {
                const remaining = selectedPlan.classes - selectedPlan.bookedClasses;
                const classNumber = selectedPlan.bookedClasses + 1; // Pr√≥xima clase a seleccionar
                
                let infoText = '';
                if (selectedPlan.bookedClasses === 0) {
                    infoText = `üìÖ Selecciona tu Primera Clase (0/${selectedPlan.classes} seleccionadas)`;
                } else if (remaining > 0) {
                    infoText = `üìÖ Selecciona tu Clase ${classNumber}/${selectedPlan.classes} (${selectedPlan.bookedClasses} seleccionadas, ${remaining} restantes)`;
                } else {
                    infoText = `‚úÖ Todas las clases seleccionadas (${selectedPlan.bookedClasses}/${selectedPlan.classes})`;
                }
                
                // Si hay una primera clase seleccionada, mostrar la fecha de expiraci√≥n
                if (selectedPlan.firstClassDate) {
                    const expirationDate = calculateExpirationDate(selectedPlan.firstClassDate, selectedPlan.classes);
                    const { daysType, daysCount } = getExpirationInfo(selectedPlan.classes);
                    infoText += `<br><small style="color: #666;">‚è∞ Tienes hasta el ${expirationDate.toLocaleDateString('es-ES')} (${daysCount} ${daysType})</small>`;
                }
                
                infoDiv.innerHTML = infoText;
            }
        }

        /**
         * Actualizar el contador visible de clases seleccionadas
         */
        function updateClassCounter() {
            const counterDisplay = document.getElementById('class-counter-display');
            const counterCurrent = document.getElementById('counter-current');
            const counterTotal = document.getElementById('counter-total');
            
            if (counterDisplay && counterCurrent && counterTotal) {
                if (selectedPlan.classes > 0) {
                    counterDisplay.style.display = 'block';
                    counterCurrent.textContent = selectedPlan.bookedClasses;
                    counterTotal.textContent = selectedPlan.classes;
                } else {
                    counterDisplay.style.display = 'none';
                }
            }
        }

        /**
         * Mostrar el bot√≥n de pago cuando se hayan seleccionado todas las clases
         */
        function showPaymentButton() {
            const paymentContainer = document.getElementById('payment-button-container');
            const paymentBtn = document.getElementById('final-payment-btn');
            const paymentCount = document.getElementById('payment-btn-count');
            
            if (paymentContainer && paymentBtn && paymentCount) {
                paymentCount.textContent = selectedPlan.classes;
                paymentContainer.style.display = 'block';
                
                // Scroll hacia el bot√≥n para que sea visible
                setTimeout(() => {
                    paymentBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }

        /**
         * Ocultar el bot√≥n de pago
         */
        function hidePaymentButton() {
            const paymentContainer = document.getElementById('payment-button-container');
            if (paymentContainer) {
                paymentContainer.style.display = 'none';
            }
        }

        // ========== MERCADO PAGO PAYMENT FLOW ==========
        // Todo el flujo de pago est√° ahora al final del HTML en un solo bloque <script>
        // Incluye: iniciarPagoAura, guardarRegistroLocalYPagar, crearPreferenciaYRedirigir, detectarRetornoDePago
        // ========== FIN MERCADO PAGO PAYMENT FLOW ==========

        let calendarInitRetries = 0;
        const MAX_CALENDAR_INIT_RETRIES = 20;
        
        function initCalendar() {
            console.log('Inicializando FullCalendar v6.1.15...');
            
            // Verificar que FullCalendar est√© cargado
            if (typeof FullCalendar === 'undefined') {
                calendarInitRetries++;
                if (calendarInitRetries >= MAX_CALENDAR_INIT_RETRIES) {
                    console.error('‚ùå ERROR: FullCalendar no se pudo cargar despu√©s de varios intentos');
                    return;
                }
                console.warn(`‚ö†Ô∏è FullCalendar no est√° cargado a√∫n. Intento ${calendarInitRetries}/${MAX_CALENDAR_INIT_RETRIES}...`);
                setTimeout(initCalendar, 500);
                return;
            }
            
            const calendarEl = document.getElementById('calendar');
            
            // DEBUG: Verificar que el elemento exista
            if (!calendarEl) {
                console.error('‚ùå ERROR: Div #calendar no encontrado en el DOM');
                alert('Error: No se pudo inicializar el calendario. Verifica que el div #calendar exista.');
                return;
            }
            
            try {
                // Initialize FullCalendar v6 with Spanish locale and monthly view
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth', // Vista mensual inicial
                    locale: 'es', // Configurar el calendario en espa√±ol
                    headerToolbar: {
                        left: 'prev,next today', // Botones de navegaci√≥n
                        center: 'title',
                        right: '' // Solo vista mensual
                    },
                    dayHeaderFormat: {
                        weekday: 'short'
                    },
                    hiddenDays: [0], // Hide Sunday
                    selectable: false, // Deshabilitamos el drag-to-select
                    nowIndicator: true,
                    height: 'auto',
                    expandRows: true,
                    fixedWeekCount: false,
                    
                    // Al hacer clic en una fecha: mostrar selector de horario
                    dateClick: function(info) {
                        handleDateClick(info);
                    },
                    
                    // Al hacer clic en un evento existente: mostrar detalles o permitir eliminar
                    eventClick: function(info) {
                        handleEventClick(info);
                    },
                    
                    validRange: {
                        start: new Date()
                    },
                    
                    // Los eventos se cargar√°n din√°micamente desde Firestore
                    events: []
                });
                
                calendar.render();
                
                // Hacer el calendario globalmente accesible
                window.calendar = calendar;
                console.log('‚úÖ FullCalendar v6.1.15 inicializado correctamente y disponible globalmente');
                
                // Cargar eventos desde Firestore
                loadEventsFromFirestore();
                
            } catch (error) {
                console.error('‚ùå ERROR al inicializar FullCalendar:', error);
                alert('Error al inicializar el calendario. Por favor, recarga la p√°gina.');
            }
        }

        /**
         * Cargar eventos desde Firebase Firestore
         * REQUISITO: Si admin, mostrar todos los eventos; si no, clases p√∫blicas fijas
         * 
         * - Si el usuario es admin: muestra todas las reservas desde Firestore
         * - Si no es admin: muestra solo clases p√∫blicas fijas de pilates (recurrentes)
         * 
         * Las reservas se cargan con fechaHora en formato ISO (YYYY-MM-DDTHH:mm:ss)
         */
        async function loadEventsFromFirestore() {
            if (!calendar) {
                console.warn('‚ö†Ô∏è Calendario no inicializado a√∫n');
                return;
            }
            
            console.log('Cargando eventos desde Firestore...');
            
            try {
                // Verificar si Firebase est√° disponible
                if (typeof window.db === 'undefined') {
                    console.warn('‚ö†Ô∏è Firebase Firestore no est√° disponible a√∫n. Esperando inicializaci√≥n...');
                    
                    // Intentar de nuevo despu√©s de 1 segundo
                    setTimeout(loadEventsFromFirestore, 1000);
                    return;
                }
                
                // Limpiar eventos existentes
                calendar.getEvents().forEach(event => event.remove());
                
                // Si es admin, cargar todas las reservas desde Firestore
                if (isAdmin) {
                    console.log('Usuario admin: cargando todas las reservas desde Firestore');
                    
                    const { getDocs, collection, query, orderBy } = window.firestoreExports;
                    const q = query(collection(window.db, 'reservas'), orderBy('timestamp', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        
                        // Intentar parsear fechaHora para obtener start date
                        // Formato esperado: "lunes, 15 de noviembre de 2025 a las 10:00"
                        let startDate = null;
                        
                        if (data.fechaHora) {
                            // Intentar diferentes formatos
                            startDate = parseFechaHora(data.fechaHora);
                        }
                        
                        // Si no se pudo parsear, usar timestamp como fallback
                        if (!startDate && data.timestamp) {
                            startDate = data.timestamp.toDate();
                        }
                        
                        if (startDate) {
                            calendar.addEvent({
                                id: doc.id,
                                title: data.nombre || 'Reserva',
                                start: startDate,
                                backgroundColor: '#EFE9E1',
                                borderColor: '#EFE9E1',
                                textColor: '#333',
                                extendedProps: {
                                    email: data.email,
                                    notas: data.notas,
                                    firebaseId: doc.id
                                }
                            });
                        }
                    });
                    
                    console.log(`‚úÖ ${querySnapshot.size} reservas cargadas desde Firestore`);
                    
                } else {
                    // Usuario no admin: no mostrar eventos en el calendario p√∫blico
                    // Solo se muestra el calendario limpio y al hacer clic se abre el selector de horarios
                    console.log('Usuario p√∫blico: calendario limpio sin eventos');
                    // Usuario no admin: calendario vac√≠o para seleccionar d√≠as y horarios disponibles
                    // El flujo correcto es: cliente elige paquete ‚Üí ve calendario ‚Üí hace clic en d√≠a ‚Üí aparecen horarios disponibles
                    console.log('Usuario p√∫blico: calendario vac√≠o para selecci√≥n de horarios');
                }
                
            } catch (error) {
                console.error('‚ùå ERROR al cargar eventos desde Firestore:', error);
                console.error('Detalles del error:', error.message);
                
                // Si es un error de permisos, mostrar mensaje espec√≠fico
                if (error.code === 'permission-denied') {
                    console.error('Error de permisos: verifica las reglas de seguridad de Firestore');
                }
            }
        }

        /**
         * Parsear fechaHora a objeto Date
         * REQUISITO: Formato esperado es ISO (YYYY-MM-DDTHH:mm:ss)
         * 
         * Prioridad de parseo:
         * 1. ISO format (YYYY-MM-DDTHH:mm:ss) - formato requerido y est√°ndar
         * 2. Formato espa√±ol legacy - compatibilidad con datos antiguos (fallback)
         * 
         * Ejemplos de formato ISO v√°lido:
         * - "2025-11-15T10:00:00"
         * - "2025-12-25T18:30:00"
         */
        function parseFechaHora(fechaHoraStr) {
            try {
                // Validar entrada
                if (!fechaHoraStr || typeof fechaHoraStr !== 'string') {
                    console.warn('‚ö†Ô∏è fechaHora inv√°lido o vac√≠o:', fechaHoraStr);
                    return null;
                }
                
                // Intentar parsear como ISO date primero (formato preferido)
                // Formato: YYYY-MM-DDTHH:mm:ss o YYYY-MM-DDTHH:mm:ss.sssZ
                const isoDate = new Date(fechaHoraStr);
                if (!isNaN(isoDate.getTime())) {
                    console.log('‚úÖ Fecha parseada en formato ISO:', fechaHoraStr, '‚Üí', isoDate);
                    return isoDate;
                }
                
                // Fallback: intentar parsear formato espa√±ol legacy
                // Ejemplo: "lunes, 15 de noviembre de 2025 a las 10:00"
                const regex = /(\d+)\s+de\s+(\w+)\s+de\s+(\d{4})\s+a\s+las\s+(\d{1,2}):(\d{2})/i;
                const match = fechaHoraStr.match(regex);
                
                if (match) {
                    const day = parseInt(match[1]);
                    const monthName = match[2].toLowerCase();
                    const year = parseInt(match[3]);
                    const hour = parseInt(match[4]);
                    const minute = parseInt(match[5]);
                    
                    // Mapear nombres de meses en espa√±ol a n√∫meros
                    const months = {
                        'enero': 0, 'febrero': 1, 'marzo': 2, 'abril': 3,
                        'mayo': 4, 'junio': 5, 'julio': 6, 'agosto': 7,
                        'septiembre': 8, 'octubre': 9, 'noviembre': 10, 'diciembre': 11
                    };
                    
                    const month = months[monthName];
                    
                    if (month !== undefined) {
                        const date = new Date(year, month, day, hour, minute);
                        console.log('‚úÖ Fecha parseada en formato espa√±ol:', fechaHoraStr, '‚Üí', date);
                        return date;
                    }
                }
                
                console.error('‚ùå No se pudo parsear fechaHora:', fechaHoraStr);
                return null;
                
            } catch (error) {
                console.error('‚ùå Error al parsear fechaHora:', fechaHoraStr, error);
                return null;
            }
        }

        /**
         * Manejar click en una fecha del calendario
         * NUEVO FLUJO: No requiere autenticaci√≥n previa
         */
        function handleDateClick(info) {
            console.log('Fecha clickeada:', info.dateStr);
            
            const clickedDate = new Date(info.dateStr + 'T00:00:00');
            const day = clickedDate.getDay();
            
            // Check if Sunday
            if (day === 0) {
                alert('‚ùå No hay clases los domingos');
                return;
            }

            // Check if date is in the past
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (clickedDate < today) {
                alert('‚ùå No puedes seleccionar fechas pasadas');
                return;
            }

            // Check if plan is selected
            if (selectedPlan.classes === 0) {
                alert('‚ö†Ô∏è Por favor, selecciona un plan primero');
                return;
            }

            // Check if limit reached
            if (selectedPlan.bookedClasses >= selectedPlan.classes) {
                alert('‚úÖ Ya has reservado todas las clases de tu plan.\n\nSi deseas cambiar una clase, haz clic en ella para cancelarla.');
                return;
            }

            // Mostrar modal de selecci√≥n de horario
            showTimeSelectionModal(info.dateStr);
        }

        /**
         * Manejar click en un evento existente
         */
        function handleEventClick(info) {
            const event = info.event;
            const startTime = event.start ? event.start.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }) : '';
            
            let message = `Evento: ${event.title}\nHora: ${startTime}`;
            
            // Si es admin, mostrar m√°s informaci√≥n
            if (isAdmin && event.extendedProps) {
                if (event.extendedProps.email) {
                    message += `\nEmail: ${event.extendedProps.email}`;
                }
                if (event.extendedProps.notas) {
                    message += `\nNotas: ${event.extendedProps.notas}`;
                }
                alert(message);
            } else {
                // Si es un evento temporal del usuario, permitir eliminarlo
                const userEventIndex = selectedPlan.bookedEvents.findIndex(e => e.eventId === event.id);
                if (userEventIndex !== -1) {
                    const confirmDelete = confirm(`${message}\n\n¬øDeseas eliminar esta clase reservada?`);
                    if (confirmDelete) {
                        event.remove();
                        selectedPlan.bookedClasses--;
                        selectedPlan.bookedEvents.splice(userEventIndex, 1);
                        
                        // Actualizar contador
                        updateClassCounter();
                        
                        // Ocultar bot√≥n de pago si ya no est√°n todas las clases seleccionadas
                        if (selectedPlan.bookedClasses < selectedPlan.classes) {
                            hidePaymentButton();
                        }
                        
                        // Si se eliminaron todas las clases, resetear el rango del calendario
                        if (selectedPlan.bookedClasses === 0) {
                            selectedPlan.firstClassDate = null;
                            localStorage.removeItem('firstClassDate');
                            
                            // Restaurar validRange a solo "desde hoy"
                            if (calendar) {
                                calendar.setOption('validRange', {
                                    start: new Date()
                                });
                            }
                            console.log('üìÖ Rango del calendario restaurado (sin l√≠mite de expiraci√≥n)');
                        } else {
                            // Si a√∫n hay clases, recalcular la primera clase
                            // Encontrar la clase m√°s temprana
                            let earliestDate = null;
                            selectedPlan.bookedEvents.forEach(booking => {
                                const bookingDate = new Date(booking.fechaHora);
                                if (!earliestDate || bookingDate < earliestDate) {
                                    earliestDate = bookingDate;
                                }
                            });
                            
                            if (earliestDate) {
                                earliestDate.setHours(0, 0, 0, 0); // Normalizar a medianoche
                                selectedPlan.firstClassDate = earliestDate;
                                localStorage.setItem('firstClassDate', earliestDate.toISOString());
                                
                                // Actualizar el rango del calendario
                                const expirationDate = calculateExpirationDate(earliestDate, selectedPlan.classes);
                                if (calendar) {
                                    calendar.setOption('validRange', {
                                        start: new Date(),
                                        end: expirationDate
                                    });
                                }
                                console.log(`üìÖ Primera clase actualizada a: ${earliestDate.toLocaleDateString('es-ES')}`);
                            }
                        }
                        
                        // Actualizar localStorage
                        saveTempReservations();
                        updateCalendarInfo();
                    }
                }
                // No mostrar ning√∫n alert para otros eventos (calendario limpio para usuarios p√∫blicos)
            }
        }

        /**
         * Contar cu√°ntas reservas existen para una fecha y hora espec√≠fica
         * @param {string} dateStr - Fecha en formato YYYY-MM-DD
         * @param {string} time - Hora en formato HH:mm
         * @returns {Promise<number>} N√∫mero de reservas para ese horario
         */
        async function getReservationCountForTimeSlot(dateStr, time) {
            try {
                // Si Firestore no est√° disponible, asumir 0 reservas
                if (!window.db) {
                    console.warn('Firestore no disponible, asumiendo 0 reservas');
                    return 0;
                }
                
                const { getDocs, collection, query } = window.firestoreExports;
                const q = query(collection(window.db, 'reservas'));
                const querySnapshot = await getDocs(q);
                
                // Construir el fechaHora objetivo en formato ISO
                const targetDateTime = `${dateStr}T${time}:00`;
                
                // Contar cu√°ntas reservas coinciden con esta fecha y hora
                let count = 0;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Comparar fechaHora en formato ISO
                    if (data.fechaHora === targetDateTime) {
                        count++;
                    }
                });
                
                console.log(`üîç Cupo para ${targetDateTime}: ${count}/5 personas`);
                return count;
            } catch (error) {
                console.error('Error al contar reservas:', error);
                // En caso de error, asumir 0 para no bloquear reservas
                return 0;
            }
        }

        /**
         * Mostrar modal de selecci√≥n de horario
         * Version: 2.0 - Fixed time slot display (2025-12-17)
         */
        async function showTimeSelectionModal(dateStr) {
            const modal = document.getElementById('time-selection-modal');
            const dateDisplay = document.getElementById('time-modal-date');
            const slotsContainer = document.getElementById('time-slots-container');
            
            // Formatear fecha para mostrar
            const date = new Date(dateStr + 'T00:00:00');
            const dateFormatted = date.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            dateDisplay.textContent = dateFormatted;
            
            // IMPORTANTE: Limpiar completamente el contenedor antes de regenerar
            // Esto previene duplicaci√≥n de horarios si la funci√≥n se llama m√∫ltiples veces
            slotsContainer.innerHTML = '';
            
            // Horarios de ma√±ana: 6:00 AM - 11:00 AM (en orden)
            const morningSlots = ['06:00', '07:00', '08:00', '09:00', '10:00', '11:00'];
            // Horarios de tarde: 5:00 PM - 7:00 PM (en orden)
            const eveningSlots = ['17:00', '18:00', '19:00'];
            
            // Agregar horarios de ma√±ana
            const morningTitle = document.createElement('div');
            morningTitle.className = 'time-section-title morning-title';
            morningTitle.style.cssText = 'grid-column: 1 / -1; padding: 8px; font-weight: 600; color: #EFE9E1; text-align: center; background: rgba(239, 233, 225, 0.1); border-radius: 8px; margin-bottom: 5px;';
            morningTitle.textContent = 'üåÖ Ma√±ana';
            slotsContainer.appendChild(morningTitle);
            
            // Verificar capacidad para cada horario de ma√±ana
            for (const time of morningSlots) {
                const count = await getReservationCountForTimeSlot(dateStr, time);
                const button = createTimeSlotButton(dateStr, time, count);
                button.setAttribute('data-period', 'morning');
                button.setAttribute('data-time', time);
                slotsContainer.appendChild(button);
            }
            
            // Agregar horarios de tarde
            const eveningTitle = document.createElement('div');
            eveningTitle.className = 'time-section-title evening-title';
            eveningTitle.style.cssText = 'grid-column: 1 / -1; padding: 8px; font-weight: 600; color: #EFE9E1; text-align: center; background: rgba(239, 233, 225, 0.1); border-radius: 8px; margin: 10px 0 5px 0;';
            eveningTitle.textContent = 'üåÜ Tarde';
            slotsContainer.appendChild(eveningTitle);
            
            // Verificar capacidad para cada horario de tarde
            for (const time of eveningSlots) {
                const count = await getReservationCountForTimeSlot(dateStr, time);
                const button = createTimeSlotButton(dateStr, time, count);
                button.setAttribute('data-period', 'evening');
                button.setAttribute('data-time', time);
                slotsContainer.appendChild(button);
            }
            
            // Mostrar modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        /**
         * Convertir hora de formato 24h a formato 12h con AM/PM
         * @param {string} time - Hora en formato HH:mm (ej: "06:00", "17:00")
         * @returns {string} Hora en formato 12h con AM/PM (ej: "6 AM", "5 PM")
         * 
         * Ejemplos:
         * - "06:00" -> "6 AM"
         * - "08:00" -> "8 AM"
         * - "11:00" -> "11 AM"
         * - "12:00" -> "12 PM"
         * - "17:00" -> "5 PM"
         * - "19:00" -> "7 PM"
         */
        function formatTimeTo12Hour(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const hour12 = hours % 12 || 12;
            return `${hour12} ${period}`;
        }

        /**
         * Crear bot√≥n de horario
         * @param {string} dateStr - Fecha en formato YYYY-MM-DD
         * @param {string} time - Hora en formato HH:mm
         * @param {number} currentCount - N√∫mero actual de reservas para este horario
         */
        function createTimeSlotButton(dateStr, time, currentCount = 0) {
            const button = document.createElement('button');
            const isFull = currentCount >= MAX_CAPACITY;
            const time12h = formatTimeTo12Hour(time);
            
            // Mostrar hora y disponibilidad en l√≠neas separadas
            if (isFull) {
                button.innerHTML = `<span style="display: block; font-weight: bold;">${time12h}</span><span style="display: block; font-size: 0.85rem; white-space: nowrap;">(Completo)</span>`;
                // Estilo gris cuando est√° completo
                button.style.cssText = 'padding: 15px; background: #cccccc; color: #666; border: 1px solid #999; font-size: 1rem; cursor: not-allowed; opacity: 0.6; text-align: center;';
                button.disabled = true;
                
                // Mostrar mensaje al intentar hacer clic
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert(`‚ö†Ô∏è Lo sentimos, este horario (${time12h}) ya est√° completo.\n\nCapacidad m√°xima: ${MAX_CAPACITY} personas\nDisponibilidad: ${MAX_CAPACITY}/${MAX_CAPACITY}\n\nPor favor, selecciona otro horario disponible.`);
                });
            } else {
                const available = MAX_CAPACITY - currentCount;
                button.innerHTML = `<span style="display: block; font-weight: bold;">${time12h}</span><span style="display: block; font-size: 0.85rem; white-space: nowrap;">(${available} disponibles)</span>`;
                // Estilo normal cuando hay disponibilidad
                button.style.cssText = 'padding: 15px; background: #EFE9E1; color: #000; border: 1px solid #ccc; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; text-align: center;';
                
                // Efecto hover
                button.addEventListener('mouseenter', () => {
                    button.style.background = '#EFE9E1';
                });
                button.addEventListener('mouseleave', () => {
                    button.style.background = '#EFE9E1';
                });
                
                button.addEventListener('click', () => {
                    selectTimeSlot(dateStr, time);
                });
            }
            
            return button;
        }

        /**
         * Seleccionar horario y reservar UNA clase
         * NUEVO FLUJO: Agregar la clase directamente al contador y calendario SIN pedir datos
         * Solo pedir datos al final cuando todas las clases est√©n seleccionadas
         */
        async function selectTimeSlot(dateStr, time) {
            // Cerrar modal de selecci√≥n de horario
            document.getElementById('time-selection-modal').style.display = 'none';
            document.body.style.overflow = '';
            
            // Verificar que no hayamos excedido el l√≠mite
            if (selectedPlan.bookedClasses >= selectedPlan.classes) {
                alert('‚úÖ Ya has reservado todas las clases de tu plan.');
                return;
            }
            
            // Verificar capacidad para este horario espec√≠fico
            const currentCount = await getReservationCountForTimeSlot(dateStr, time);
            
            if (currentCount >= MAX_CAPACITY) {
                const date = new Date(dateStr + 'T00:00:00');
                const dateFormatted = date.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                alert(`‚ö†Ô∏è Lo sentimos, el horario del ${dateFormatted} a las ${formatTimeTo12Hour(time)} ya est√° completo.\n\nPor favor, selecciona otro horario o fecha.`);
                // Reabrir modal de selecci√≥n de horario
                showTimeSelectionModal(dateStr);
                return;
            }
            
            // Crear fecha y hora en formato ISO
            const dateTimeStr = `${dateStr}T${time}:00`;
            const dateTime = new Date(dateTimeStr);
            const endDateTime = new Date(dateTime.getTime() + 60 * 60 * 1000); // +1 hora
            
            // Agregar evento al calendario temporalmente (sin nombre a√∫n)
            const eventId = `temp-${Date.now()}`;
            calendar.addEvent({
                id: eventId,
                title: `‚úì Clase ${selectedPlan.bookedClasses + 1}`,
                start: dateTime,
                end: endDateTime,
                backgroundColor: '#EFE9E1',
                borderColor: '#EFE9E1',
                textColor: '#333',
                extendedProps: {
                    fechaHora: dateTimeStr,
                    temporal: true
                }
            });
            
            // Guardar esta fecha seleccionada en selectedPlan
            selectedPlan.bookedEvents.push({
                eventId: eventId,
                fechaHora: dateTimeStr,
                dateStr: dateStr,
                time: time
            });
            
            selectedPlan.bookedClasses += 1;
            
            // Establecer la primera fecha de clase si es necesario
            if (selectedPlan.bookedClasses === 1) {
                selectedPlan.firstClassDate = new Date(dateStr + 'T00:00:00');
                selectedPlan.firstClassDate.setHours(0, 0, 0, 0);
                localStorage.setItem('firstClassDate', selectedPlan.firstClassDate.toISOString());
                updateCalendarValidRange(selectedPlan.firstClassDate);
            }
            
            // Actualizar contador visible
            updateClassCounter();
            
            // Guardar en localStorage (temporal, hasta pago exitoso)
            saveTempReservations();
            
            // Actualizar informaci√≥n del calendario
            updateCalendarInfo();
            
            const remaining = selectedPlan.classes - selectedPlan.bookedClasses;
            
            // Verificar si complet√≥ todas las reservas
            if (selectedPlan.bookedClasses >= selectedPlan.classes) {
                // Todas las clases seleccionadas -> mostrar bot√≥n de pago
                showPaymentButton();
                alert(`‚úÖ ¬°Has seleccionado todas tus ${selectedPlan.classes} clases!\n\nAhora haz clic en el bot√≥n "Pagar y confirmar mis ${selectedPlan.classes} clases" para continuar.`);
            } else {
                // Continuar seleccionando
                const nextClassNumber = selectedPlan.bookedClasses + 1;
                alert(`‚úÖ Clase ${selectedPlan.bookedClasses}/${selectedPlan.classes} agregada!\n\nüìÖ ${dateTime.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\nüïê ${dateTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}\n\n‚û°Ô∏è Ahora selecciona tu Clase ${nextClassNumber}/${selectedPlan.classes}\n\nContin√∫a seleccionando en el calendario.`);
            }
        }

        // Constants for phone number handling
        const MEXICO_COUNTRY_CODE = '52';
        const PHONE_DIGITS_LENGTH = 10;
        const PHONE_WITH_COUNTRY_CODE_LENGTH = MEXICO_COUNTRY_CODE.length + PHONE_DIGITS_LENGTH; // 52 + 10 digits = 12
        
        /**
         * Show modal for legacy users to create a password
         * @param {string} phoneDigits - User's phone number (10 digits)
         * @param {string} storedName - User's stored name
         */
        function showLegacyPasswordCreationModal(phoneDigits, storedName) {
            const modal = document.getElementById('create-password-modal');
            const passwordInput = document.getElementById('legacy-new-password');
            const errorDiv = document.getElementById('legacy-password-error');
            const confirmBtn = document.getElementById('legacy-password-confirm');
            
            // Clear previous state
            passwordInput.value = '';
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            // Setup confirm handler
            const handleConfirm = async () => {
                const newPassword = passwordInput.value;
                
                // Validate password
                if (!newPassword || newPassword.length < 4) {
                    errorDiv.textContent = '‚ö†Ô∏è La contrase√±a debe tener al menos 4 caracteres';
                    errorDiv.style.display = 'block';
                    passwordInput.focus();
                    return;
                }
                
                try {
                    // Hash the new password
                    const encoder = new TextEncoder();
                    const data = encoder.encode(newPassword);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    // Save the password
                    localStorage.setItem('userPassword_' + phoneDigits, hashedPassword);
                    if (storedName) {
                        localStorage.setItem('userName_' + phoneDigits, storedName);
                    }
                    
                    // Close modal
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Show success message
                    alert('‚úÖ Contrase√±a creada exitosamente.\n\nAhora puedes iniciar sesi√≥n con tu nueva contrase√±a.');
                    
                    // Focus on login form
                    const loginPhoneInput = document.getElementById('user-login-phone');
                    if (loginPhoneInput) {
                        loginPhoneInput.focus();
                    }
                    
                    // Clean up
                    passwordInput.value = '';
                    errorDiv.style.display = 'none';
                    
                    // Remove event listeners to prevent memory leaks
                    passwordInput.removeEventListener('keypress', handleEnterKey);
                } catch (error) {
                    console.error('Error creating password:', error);
                    errorDiv.textContent = '‚ùå Error al crear contrase√±a. Por favor, intenta nuevamente.';
                    errorDiv.style.display = 'block';
                }
            };
            
            // Handle Enter key submission
            const handleEnterKey = (e) => {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
            };
            
            // Remove old event listeners before adding new ones
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', handleConfirm);
            
            // Remove existing keypress listener if any
            const newPasswordInput = passwordInput.cloneNode(true);
            passwordInput.parentNode.replaceChild(newPasswordInput, passwordInput);
            newPasswordInput.addEventListener('keypress', handleEnterKey);
            
            // Show modal
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            newPasswordInput.focus();
        }
        
        /**
         * Mostrar modal de confirmaci√≥n final cuando el usuario hace clic en el bot√≥n de pago
         * Pide nombre y tel√©fono una sola vez al final, antes de proceder al pago
         */
        function showFinalReservationModal() {
            const modal = document.getElementById('reservation-modal');
            const dateDisplay = document.getElementById('reservation-date-display');
            const timeDisplay = document.getElementById('reservation-time-display');
            const nameInput = document.getElementById('reservation-name');
            const phoneInput = document.getElementById('reservation-phone');
            const progressDisplay = document.getElementById('reservation-progress');
            const confirmBtn = document.getElementById('reservation-confirm');
            const cancelBtn = document.getElementById('reservation-cancel');
            
            // Construir resumen de todas las clases seleccionadas
            let datesSummary = '';
            selectedPlan.bookedEvents.forEach((event, index) => {
                const dateTime = new Date(event.fechaHora);
                const dateFormatted = dateTime.toLocaleDateString('es-ES', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short' 
                });
                const timeFormatted = dateTime.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                datesSummary += `${index + 1}. ${dateFormatted} - ${timeFormatted}\n`;
            });
            
            // Mostrar el resumen completo
            const classWord = selectedPlan.bookedClasses === 1 ? 'clase seleccionada' : 'clases seleccionadas';
            dateDisplay.textContent = `${selectedPlan.bookedClasses} ${classWord}`;
            
            // Use textContent to avoid XSS vulnerabilities
            const summaryDiv = document.createElement('div');
            summaryDiv.style.whiteSpace = 'pre-line';
            summaryDiv.style.textAlign = 'left';
            summaryDiv.style.fontSize = '0.95rem';
            summaryDiv.textContent = datesSummary;
            timeDisplay.innerHTML = ''; // Clear existing content
            timeDisplay.appendChild(summaryDiv);
            
            // Mostrar progreso
            progressDisplay.textContent = `${selectedPlan.bookedClasses} de ${selectedPlan.classes} clases seleccionadas`;
            
            // Pre-llenar con datos si ya est√°n en localStorage
            const savedName = localStorage.getItem('userNombre') || '';
            const savedPhone = localStorage.getItem('userTelefono') || '';
            nameInput.value = savedName;
            if (savedPhone.startsWith(MEXICO_COUNTRY_CODE) && savedPhone.length > MEXICO_COUNTRY_CODE.length) {
                phoneInput.value = savedPhone.substring(MEXICO_COUNTRY_CODE.length);
            } else {
                phoneInput.value = savedPhone;
            }
            
            // Show/hide password field based on whether user already has an account
            const passwordContainer = document.getElementById('reservation-password-container');
            const passwordInput = document.getElementById('reservation-password');
            
            // Check if we have a saved phone and if it has a password
            const phoneDigitsFromStorage = savedPhone.startsWith(MEXICO_COUNTRY_CODE) 
                ? savedPhone.substring(MEXICO_COUNTRY_CODE.length) 
                : savedPhone;
            
            const hasExistingPassword = phoneDigitsFromStorage && localStorage.getItem('userPassword_' + phoneDigitsFromStorage);
            
            if (hasExistingPassword) {
                // User already has an account, hide password field
                passwordContainer.style.display = 'none';
                passwordInput.value = ''; // Clear password field
            } else {
                // New user, show password field
                passwordContainer.style.display = 'block';
            }
            
            // Also check phone input changes to toggle password field visibility
            // Only check when phone number reaches exactly 10 digits to avoid excessive localStorage lookups
            // Use named function to avoid duplicate listeners
            const handlePhoneInput = () => {
                const phoneDigits = phoneInput.value.trim().replace(/\D/g, '');
                // Only perform check when we have exactly 10 digits
                if (phoneDigits.length === PHONE_DIGITS_LENGTH) {
                    const hasPassword = localStorage.getItem('userPassword_' + phoneDigits);
                    if (hasPassword) {
                        passwordContainer.style.display = 'none';
                        passwordInput.value = '';
                    } else {
                        passwordContainer.style.display = 'block';
                    }
                } else if (phoneDigits.length < PHONE_DIGITS_LENGTH) {
                    // Show password field for incomplete phone numbers (new users)
                    passwordContainer.style.display = 'block';
                }
            };
            
            // Remove existing listener if any and add new one
            phoneInput.removeEventListener('input', handlePhoneInput);
            phoneInput.addEventListener('input', handlePhoneInput);
            
            // Event handlers
            confirmBtn.onclick = () => {
                confirmFinalPayment();
            };
            
            cancelBtn.onclick = () => {
                // Simplemente cerrar el modal, no cancelar las clases seleccionadas
                modal.style.display = 'none';
                document.body.style.overflow = '';
            };
            
            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            nameInput.focus();
        }
        
        /**
         * Confirmar el pago final despu√©s de ingresar nombre, tel√©fono y contrase√±a
         */
        async function confirmFinalPayment() {
            const nameInput = document.getElementById('reservation-name');
            const phoneInput = document.getElementById('reservation-phone');
            const passwordInput = document.getElementById('reservation-password');
            
            const nombre = nameInput.value.trim();
            const phoneDigits = phoneInput.value.trim().replace(/\D/g, '');
            const password = passwordInput.value;
            
            // Validar campos
            if (!nombre) {
                alert('‚ö†Ô∏è Por favor ingresa tu nombre completo');
                nameInput.focus();
                return;
            }
            
            if (phoneDigits.length !== PHONE_DIGITS_LENGTH) {
                alert(`‚ö†Ô∏è Por favor ingresa ${PHONE_DIGITS_LENGTH} d√≠gitos de tel√©fono (sin espacios ni guiones)`);
                phoneInput.focus();
                return;
            }
            
            // Check if user already has a password
            const existingPassword = localStorage.getItem('userPassword_' + phoneDigits);
            
            // If no existing password, require password creation
            if (!existingPassword) {
                if (!password || password.length < 4) {
                    alert('‚ö†Ô∏è Por favor crea una contrase√±a de al menos 4 caracteres.\n\nEsto te permitir√° ver tus clases despu√©s.');
                    passwordInput.focus();
                    return;
                }
                
                // Hash password for secure storage
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                // Store hashed password associated with phone number
                localStorage.setItem('userPassword_' + phoneDigits, hashedPassword);
                // Store user name associated with phone number
                localStorage.setItem('userName_' + phoneDigits, nombre);
            }
            
            const telefono = MEXICO_COUNTRY_CODE + phoneDigits;
            
            // Guardar datos del cliente
            localStorage.setItem('userNombre', nombre);
            localStorage.setItem('userTelefono', telefono);
            localStorage.setItem('registered', 'true');
            
            selectedPlan.userInfo = {
                nombre: nombre,
                telefono: telefono,
                notas: ''
            };
            
            // Actualizar todos los eventos del calendario con el nombre
            selectedPlan.bookedEvents.forEach((booking, index) => {
                booking.nombre = nombre;
                booking.telefono = telefono;
                
                // Actualizar el evento en el calendario visual
                const event = calendar.getEventById(booking.eventId);
                if (event) {
                    event.setProp('title', `‚úì ${nombre}`);
                    event.setExtendedProp('nombre', nombre);
                    event.setExtendedProp('telefono', telefono);
                }
            });
            
            // Cerrar modal
            document.getElementById('reservation-modal').style.display = 'none';
            document.body.style.overflow = '';
            
            // Guardar estado en localStorage y verificar
            const guardadoExitoso = saveTempReservations();
            
            if (!guardadoExitoso) {
                alert('‚ùå Error al guardar las reservas.\n\nPor favor, intenta nuevamente.');
                return;
            }
            
            // Proceder al pago
            alert(`‚úÖ Perfecto ${nombre}!\n\nAhora ser√°s redirigido a MercadoPago para completar tu pago de $${selectedPlan.price} por ${selectedPlan.classes} clases.`);
            
            setTimeout(() => {
                proceedToPayment();
            }, 1000);
        }
        
        /**
         * Mostrar modal de confirmaci√≥n para las clases seleccionadas hasta ahora
         * Muestra un resumen de todas las clases que el usuario ha elegido manualmente
         */
        function showReservationModalForAllClasses() {
            const modal = document.getElementById('reservation-modal');
            const dateDisplay = document.getElementById('reservation-date-display');
            const timeDisplay = document.getElementById('reservation-time-display');
            const nameInput = document.getElementById('reservation-name');
            const phoneInput = document.getElementById('reservation-phone');
            const progressDisplay = document.getElementById('reservation-progress');
            const confirmBtn = document.getElementById('reservation-confirm');
            const cancelBtn = document.getElementById('reservation-cancel');
            
            // Construir resumen de todas las clases seleccionadas
            let datesSummary = '';
            selectedPlan.bookedEvents.forEach((event, index) => {
                const dateTime = new Date(event.fechaHora);
                const dateFormatted = dateTime.toLocaleDateString('es-ES', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short' 
                });
                const timeFormatted = dateTime.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                datesSummary += `${index + 1}. ${dateFormatted} - ${timeFormatted}\n`;
            });
            
            // Mostrar el resumen completo
            const classWord = selectedPlan.bookedClasses === 1 ? 'clase seleccionada' : 'clases seleccionadas';
            dateDisplay.textContent = `${selectedPlan.bookedClasses} ${classWord}`;
            
            // Use textContent to avoid XSS vulnerabilities
            const summaryDiv = document.createElement('div');
            summaryDiv.style.whiteSpace = 'pre-line';
            summaryDiv.style.textAlign = 'left';
            summaryDiv.style.fontSize = '0.95rem';
            summaryDiv.textContent = datesSummary;
            timeDisplay.innerHTML = ''; // Clear existing content
            timeDisplay.appendChild(summaryDiv);
            
            // Mostrar progreso
            progressDisplay.textContent = `${selectedPlan.bookedClasses} de ${selectedPlan.classes} clases seleccionadas`;
            
            // Pre-llenar con datos si ya est√°n en localStorage
            const savedName = localStorage.getItem('userNombre') || '';
            const savedPhone = localStorage.getItem('userTelefono') || '';
            nameInput.value = savedName;
            if (savedPhone.startsWith(MEXICO_COUNTRY_CODE) && savedPhone.length > MEXICO_COUNTRY_CODE.length) {
                phoneInput.value = savedPhone.substring(MEXICO_COUNTRY_CODE.length);
            } else {
                phoneInput.value = savedPhone;
            }
            
            // Event handlers
            confirmBtn.onclick = () => {
                confirmAllReservations();
            };
            
            cancelBtn.onclick = () => {
                // Cancelar todas las reservas temporales
                if (confirm('¬øDeseas cancelar la reserva de estas clases?')) {
                    selectedPlan.bookedEvents = [];
                    selectedPlan.bookedClasses = 0;
                    selectedPlan.firstClassDate = null;
                    localStorage.removeItem('firstClassDate');
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    updateCalendarInfo();
                }
            };
            
            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            nameInput.focus();
        }
        
        /**
         * Confirmar todas las reservas y agregar eventos al calendario
         */
        function confirmAllReservations() {
            const nameInput = document.getElementById('reservation-name');
            const phoneInput = document.getElementById('reservation-phone');
            
            const nombre = nameInput.value.trim();
            const phoneDigits = phoneInput.value.trim().replace(/\D/g, '');
            
            // Validar campos
            if (!nombre) {
                alert('‚ö†Ô∏è Por favor ingresa tu nombre completo');
                nameInput.focus();
                return;
            }
            
            if (phoneDigits.length !== PHONE_DIGITS_LENGTH) {
                alert(`‚ö†Ô∏è Por favor ingresa ${PHONE_DIGITS_LENGTH} d√≠gitos de tel√©fono (sin espacios ni guiones)`);
                phoneInput.focus();
                return;
            }
            
            const telefono = MEXICO_COUNTRY_CODE + phoneDigits;
            
            // Guardar datos del cliente
            localStorage.setItem('userNombre', nombre);
            localStorage.setItem('userTelefono', telefono);
            
            selectedPlan.userInfo = {
                nombre: nombre,
                telefono: telefono,
                notas: ''
            };
            
            // Agregar todos los eventos al calendario
            let eventCounter = 0;
            selectedPlan.bookedEvents.forEach((booking) => {
                if (!booking.tempAdded) {
                    const dateTime = new Date(booking.fechaHora);
                    const endDateTime = new Date(dateTime.getTime() + 60 * 60 * 1000); // +1 hora
                    
                    const eventId = `temp-${Date.now()}-${eventCounter++}`;
                    booking.eventId = eventId;
                    booking.nombre = nombre;
                    booking.telefono = telefono;
                    booking.tempAdded = true;
                    
                    calendar.addEvent({
                        id: eventId,
                        title: `‚úì ${nombre}`,
                        start: dateTime,
                        end: endDateTime,
                        backgroundColor: '#EFE9E1',
                        borderColor: '#EFE9E1',
                        textColor: '#333',
                        extendedProps: {
                            fechaHora: booking.fechaHora,
                            temporal: true,
                            nombre: nombre,
                            telefono: telefono
                        }
                    });
                }
            });
            
            // Cerrar modal
            document.getElementById('reservation-modal').style.display = 'none';
            document.body.style.overflow = '';
            
            // Guardar estado en localStorage
            localStorage.setItem('reservationState', JSON.stringify({
                reservations: selectedPlan.bookedEvents,
                userInfo: selectedPlan.userInfo,
                firstClassDate: selectedPlan.firstClassDate ? selectedPlan.firstClassDate.toISOString() : null
            }));
            
            // Actualizar informaci√≥n del calendario
            updateCalendarInfo();
            
            // Mostrar mensaje de √©xito y proceder al pago
            alert(`‚úÖ ¬°Has seleccionado todas tus ${selectedPlan.classes} clases!\n\nAhora ser√°s redirigido al pago...`);
            
            // Proceder al pago
            setTimeout(() => {
                proceedToPayment();
            }, 1000);
        }
        
        /**
         * Mostrar modal de confirmaci√≥n de reserva con datos del cliente
         * FLUJO ANTIGUO: Pedir nombre y tel√©fono por cada horario (mantenido para compatibilidad)
         */
        function showReservationModal(dateStr, time, dateFormatted, timeFormatted, dateTimeStr) {
            const modal = document.getElementById('reservation-modal');
            const dateDisplay = document.getElementById('reservation-date-display');
            const timeDisplay = document.getElementById('reservation-time-display');
            const nameInput = document.getElementById('reservation-name');
            const phoneInput = document.getElementById('reservation-phone');
            const progressDisplay = document.getElementById('reservation-progress');
            const confirmBtn = document.getElementById('reservation-confirm');
            const cancelBtn = document.getElementById('reservation-cancel');
            
            // Mostrar fecha y hora seleccionada
            dateDisplay.textContent = dateFormatted;
            timeDisplay.textContent = timeFormatted;
            
            // Mostrar progreso
            const currentCount = selectedPlan.bookedClasses + 1;
            progressDisplay.textContent = `${currentCount} de ${selectedPlan.classes} clases seleccionadas`;
            
            // Pre-llenar con datos si ya est√°n en localStorage (de pago previo)
            const savedName = localStorage.getItem('userNombre') || '';
            const savedPhone = localStorage.getItem('userTelefono') || '';
            nameInput.value = savedName;
            // Remove country code prefix if present (supports any length country code)
            if (savedPhone.startsWith(MEXICO_COUNTRY_CODE) && savedPhone.length > MEXICO_COUNTRY_CODE.length) {
                phoneInput.value = savedPhone.substring(MEXICO_COUNTRY_CODE.length);
            } else {
                phoneInput.value = savedPhone;
            }
            
            // Event handlers
            confirmBtn.onclick = () => {
                confirmReservation(dateStr, time, dateTimeStr);
            };
            
            cancelBtn.onclick = () => {
                modal.style.display = 'none';
                // Volver a mostrar el modal de selecci√≥n de horario
                document.getElementById('time-selection-modal').style.display = 'flex';
            };
            
            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            nameInput.focus();
        }

        /**
         * Confirmar reserva y agregar temporalmente al calendario
         * NUEVO FLUJO: Guardar en localStorage y continuar o proceder al pago
         */
        function confirmReservation(dateStr, time, dateTimeStr) {
            const nameInput = document.getElementById('reservation-name');
            const phoneInput = document.getElementById('reservation-phone');
            
            const nombre = nameInput.value.trim();
            const phoneDigits = phoneInput.value.trim().replace(/\D/g, '');
            
            // Validar campos
            if (!nombre) {
                alert('‚ö†Ô∏è Por favor ingresa tu nombre completo');
                nameInput.focus();
                return;
            }
            
            if (phoneDigits.length !== PHONE_DIGITS_LENGTH) {
                alert(`‚ö†Ô∏è Por favor ingresa ${PHONE_DIGITS_LENGTH} d√≠gitos de tel√©fono (sin espacios ni guiones)`);
                phoneInput.focus();
                return;
            }
            
            const telefono = MEXICO_COUNTRY_CODE + phoneDigits; // Agregar c√≥digo de pa√≠s
            
            // Guardar datos del cliente (se usar√°n para todas las reservas)
            localStorage.setItem('userNombre', nombre);
            localStorage.setItem('userTelefono', telefono);
            
            // Store in selectedPlan if not already set
            if (!selectedPlan.userInfo) {
                selectedPlan.userInfo = {
                    nombre: nombre,
                    telefono: telefono,
                    notas: ''
                };
            }
            
            // Cerrar modal
            document.getElementById('reservation-modal').style.display = 'none';
            document.body.style.overflow = ''; // Restore scrolling
            
            // Crear fecha y hora en formato ISO
            const dateTime = new Date(dateTimeStr);
            const endDateTime = new Date(dateTime.getTime() + 60 * 60 * 1000); // +1 hora
            
            // Si es la primera clase, establecer la fecha y actualizar el rango del calendario
            if (selectedPlan.bookedClasses === 0) {
                selectedPlan.firstClassDate = new Date(dateTime);
                selectedPlan.firstClassDate.setHours(0, 0, 0, 0); // Normalizar a medianoche
                localStorage.setItem('firstClassDate', selectedPlan.firstClassDate.toISOString());
                
                // Actualizar el rango v√°lido del calendario
                updateCalendarValidRange(selectedPlan.firstClassDate);
            }
            
            // Agregar evento al calendario temporalmente
            const eventId = `temp-${Date.now()}`;
            calendar.addEvent({
                id: eventId,
                title: `‚úì ${nombre}`,
                start: dateTime,
                end: endDateTime,
                backgroundColor: '#EFE9E1',
                borderColor: '#EFE9E1',
                textColor: '#333',
                extendedProps: {
                    fechaHora: dateTimeStr, // ISO format
                    temporal: true,
                    nombre: nombre,
                    telefono: telefono
                }
            });
            
            // Agregar a la lista de reservas seleccionadas
            selectedPlan.bookedClasses++;
            selectedPlan.bookedEvents.push({
                eventId: eventId,
                fechaHora: dateTimeStr, // ISO format: YYYY-MM-DDTHH:mm:ss
                nombre: nombre,
                telefono: telefono
            });
            
            // Guardar en localStorage (temporal, hasta pago exitoso)
            saveTempReservations();
            
            // Actualizar contador
            updateCalendarInfo();
            
            const remaining = selectedPlan.classes - selectedPlan.bookedClasses;
            
            // Verificar si complet√≥ todas las reservas
            if (selectedPlan.bookedClasses >= selectedPlan.classes) {
                // Todas las clases seleccionadas -> proceder al pago
                alert(`‚úÖ ¬°Has seleccionado todas tus ${selectedPlan.classes} clases!\n\nAhora ser√°s redirigido al pago...`);
                setTimeout(() => {
                    proceedToPayment();
                }, 1000);
            } else {
                // Continuar seleccionando - Mostrar progreso con n√∫mero de clase
                const classNumber = selectedPlan.bookedClasses;
                const nextClassNumber = selectedPlan.bookedClasses + 1;
                alert(`‚úÖ Clase ${classNumber}/${selectedPlan.classes} agregada!\n\nüìÖ ${dateTime.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\nüïê ${dateTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}\n\n‚û°Ô∏è Ahora selecciona tu Clase ${nextClassNumber}/${selectedPlan.classes}\n\nContin√∫a seleccionando en el calendario.`);
            }
        }

        /**
         * Guardar reservas temporales en localStorage
         */
        function saveTempReservations() {
            // Check if localStorage is available
            if (!window.localStorage) {
                console.error('‚ùå localStorage no est√° disponible en este navegador');
                alert('‚ö†Ô∏è Tu navegador no soporta almacenamiento local.\n\nPor favor, usa un navegador moderno o desactiva el modo inc√≥gnito.');
                return false;
            }
            
            const tempData = {
                reservations: selectedPlan.bookedEvents,
                userInfo: selectedPlan.userInfo,
                firstClassDate: selectedPlan.firstClassDate ? selectedPlan.firstClassDate.toISOString() : null
            };
            
            try {
                localStorage.setItem('tempReservations', JSON.stringify(tempData));
                console.log('üíæ Reservas temporales guardadas en localStorage');
                console.log('üìã Datos guardados:', {
                    reservas: tempData.reservations.length,
                    usuario: tempData.userInfo?.nombre || 'Sin nombre',
                    telefono: tempData.userInfo?.telefono || 'Sin tel√©fono'
                });
                
                // Verificar que se guard√≥ correctamente
                const verificacion = localStorage.getItem('tempReservations');
                if (!verificacion) {
                    console.error('‚ùå Error: No se pudo guardar en localStorage');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('‚ùå Error al guardar en localStorage:', error);
                // Check for QuotaExceededError (localStorage full)
                if (error.name === 'QuotaExceededError') {
                    alert('‚ö†Ô∏è El almacenamiento local est√° lleno.\n\nPor favor, limpia el cach√© de tu navegador e intenta nuevamente.');
                } else {
                    alert('‚ö†Ô∏è Error al guardar las reservas.\n\nVerifica que tu navegador permita almacenamiento local.');
                }
                return false;
            }
        }

        /**
         * Proceder al pago con MercadoPago
         */
        async function proceedToPayment() {
            const nombre = selectedPlan.userInfo.nombre;
            const telefono = selectedPlan.userInfo.telefono;
            const classes = selectedPlan.classes;
            const precio = selectedPlan.price;
            
            console.log(`üí≥ Procesando pago: ${classes} clases x $${precio} para ${nombre}`);
            
            // Crear preferencia de MercadoPago y redirigir
            await crearPreferenciaYRedirigir(nombre, telefono);
        }

        /**
         * Guardar todas las reservas en Firestore
         * Guarda fechaHora en formato ISO (YYYY-MM-DDTHH:mm:ss) como especificado en los requisitos
         * REQUISITO: Solo usuarios autenticados pueden guardar reservas (currentUser no nulo)
         */
        async function saveAllReservations() {
            if (!selectedPlan.userInfo || selectedPlan.bookedEvents.length === 0) {
                alert('‚ùå No hay reservas para guardar');
                return;
            }
            
            try {
                console.log('üîç Verificando disponibilidad de Firebase...');
                
                // REQUISITO: Verificar que el usuario est√© autenticado
                if (!window.auth || !window.auth.currentUser) {
                    console.error('‚ùå Usuario no autenticado');
                    alert('‚ùå Error: Debes iniciar sesi√≥n o registrarte para hacer reservas.\n\nPor favor, usa el men√∫ (‚ò∞) en la esquina superior derecha para registrarte o iniciar sesi√≥n.');
                    return;
                }
                
                console.log('‚úÖ Usuario autenticado:', window.auth.currentUser.email);
                
                // Verificar que Firebase est√© disponible
                if (!window.firebaseReady) {
                    console.error('‚ùå Firebase no est√° listo');
                    alert('‚ùå Error: Sistema de reservas no est√° listo. Por favor, espera unos segundos y vuelve a intentarlo.');
                    return;
                }
                
                if (typeof window.saveReservationToFirestore !== 'function') {
                    console.error('‚ùå Funci√≥n saveReservationToFirestore no est√° disponible');
                    alert('‚ùå Error: Sistema de reservas no disponible. Por favor, recarga la p√°gina.');
                    return;
                }
                
                if (!window.db) {
                    console.error('‚ùå Firestore DB no est√° disponible');
                    alert('‚ùå Error: Base de datos no disponible. Por favor, recarga la p√°gina.');
                    return;
                }
                
                const { nombre, telefono, notas } = selectedPlan.userInfo;
                
                console.log(`üìù Guardando ${selectedPlan.bookedEvents.length} reservas para ${nombre}...`);
                
                // Guardar cada reserva en Firestore con fechaHora en formato ISO
                const savedReservations = [];
                const failedReservations = [];
                
                for (let i = 0; i < selectedPlan.bookedEvents.length; i++) {
                    const booking = selectedPlan.bookedEvents[i];
                    try {
                        console.log(`üíæ Guardando reserva ${i + 1}/${selectedPlan.bookedEvents.length}...`);
                        
                        // booking.fechaHora ya est√° en formato ISO (YYYY-MM-DDTHH:mm:ss)
                        const reservaId = await window.saveReservationToFirestore(
                            nombre, 
                            telefono, 
                            booking.fechaHora, // ISO format: YYYY-MM-DDTHH:mm:ss
                            notas
                        );
                        savedReservations.push(reservaId);
                        console.log(`‚úÖ Reserva ${i + 1} guardada con ID:`, reservaId, '- fechaHora:', booking.fechaHora);
                    } catch (reservaError) {
                        console.error(`‚ùå Error al guardar reserva ${i + 1}:`, reservaError);
                        failedReservations.push({
                            booking,
                            error: reservaError.message
                        });
                    }
                }
                
                // Mostrar resultados
                if (savedReservations.length === selectedPlan.bookedEvents.length) {
                    // Todo se guard√≥ exitosamente
                    alert(`‚úÖ ¬°Reservas Completadas y Guardadas!\n\n${savedReservations.length} clases reservadas para ${nombre}\n\nTe contactaremos al ${telefono}`);
                } else if (savedReservations.length > 0) {
                    // Algunas reservas fallaron
                    alert(`‚ö†Ô∏è Reservas Parcialmente Guardadas\n\n${savedReservations.length} de ${selectedPlan.bookedEvents.length} clases guardadas para ${nombre}\n\n${failedReservations.length} reservas fallaron. Por favor, contacta con nosotros para completar tu reserva.`);
                } else {
                    // Todas las reservas fallaron
                    throw new Error('No se pudo guardar ninguna reserva');
                }
                
                // Si el usuario es admin, recargar el panel de admin
                if (isAdmin && typeof window.loadReservationsFromFirestore === 'function') {
                    await window.loadReservationsFromFirestore();
                }
                
                // Recargar eventos del calendario para mostrar las reservas guardadas
                if (calendar) {
                    loadEventsFromFirestore();
                }
                
                // Recargar Mis Clases despu√©s de guardar
                const savedTelefono = localStorage.getItem('userTelefono');
                if (window.loadUserClasses && savedTelefono) {
                    window.loadUserClasses(savedTelefono);
                }
                
                // Resetear el plan seleccionado solo si se guard√≥ al menos una reserva
                if (savedReservations.length > 0) {
                    selectedPlan.classes = 0;
                    selectedPlan.price = 0;
                    selectedPlan.bookedClasses = 0;
                    selectedPlan.bookedEvents = [];
                    selectedPlan.userInfo = null;
                    
                    // Ocultar calendario
                    document.getElementById('calendar-container').style.display = 'none';
                }
                
            } catch (error) {
                console.error('‚ùå Error al guardar las reservas:', error);
                console.error('‚ùå Detalles completos del error:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack,
                    firebaseReady: window.firebaseReady,
                    dbAvailable: !!window.db,
                    functionAvailable: typeof window.saveReservationToFirestore === 'function'
                });
                
                // Proporcionar un mensaje de error m√°s espec√≠fico
                let errorMessage = '‚ùå Error al guardar las reservas.\n\n';
                
                if (!window.firebaseReady) {
                    errorMessage += 'El sistema a√∫n se est√° inicializando. Por favor, espera unos segundos y vuelve a intentarlo.\n\n';
                } else if (error.code === 'permission-denied') {
                    errorMessage += 'Error de permisos. Por favor, contacta con el administrador.\n\n';
                } else if (error.code === 'unavailable') {
                    errorMessage += 'Servicio temporalmente no disponible. Por favor, verifica tu conexi√≥n a internet.\n\n';
                } else if (error.message) {
                    errorMessage += `Error: ${error.message}\n\n`;
                }
                
                errorMessage += 'Si el problema persiste, por favor contacta con nosotros.';
                
                alert(errorMessage);
            }
        }
    </script>

    <!-- Firebase SDK v10 via CDN -->
    <script type="module">
        /*
         * ========== FIREBASE CONFIGURATION ==========
         * 
         * INSTRUCCIONES PARA CONFIGURAR FIREBASE:
         * 
         * 1. Crear proyecto Firebase:
         *    - Ve a https://console.firebase.google.com/
         *    - Haz clic en "Agregar proyecto"
         *    - Nombre del proyecto: "AURA Studio" (o el que prefieras)
         *    - Sigue los pasos para completar la creaci√≥n
         * 
         * 2. Habilitar Authentication:
         *    - En el men√∫ lateral, ve a "Authentication" > "Get started"
         *    - En la pesta√±a "Sign-in method", habilita "Correo electr√≥nico/contrase√±a"
         *    - Guarda los cambios
         * 
         * 3. Crear usuario administrador:
         *    - En Authentication, ve a la pesta√±a "Users"
         *    - Haz clic en "Add user"
         *    - Email: admin@aura.com (ofuscado en c√≥digo como _adm)
         *    - Contrase√±a: admin123 (ofuscado en c√≥digo como _pwd)
         *    - Haz clic en "Add user"
         * 
         * 4. Habilitar Firestore:
         *    - En el men√∫ lateral, ve a "Firestore Database" > "Create database"
         *    - Elige "Start in test mode" (temporalmente para pruebas)
         *    - Selecciona la ubicaci√≥n m√°s cercana
         *    - Haz clic en "Enable"
         * 
         * 5. Configurar reglas de seguridad de Firestore:
         *    - En Firestore, ve a la pesta√±a "Rules"
         *    - Reemplaza las reglas existentes con:
         * 
         *    rules_version = '2';
         *    service cloud.firestore {
         *      match /databases/{database}/documents {
         *        // Colecci√≥n de reservas: lectura solo para admin, escritura p√∫blica
         *        match /reservas/{document=**} {
         *          allow read: if request.auth != null && request.auth.token.email == '[ADMIN_EMAIL]';
         *          allow write: if true;
         *        }
         *      }
         *    }
         * 
         *    - Haz clic en "Publish"
         * 
         * 6. Obtener configuraci√≥n de Firebase:
         *    - Ve a la configuraci√≥n del proyecto (√≠cono de engranaje junto a "Project Overview")
         *    - En "Your apps", selecciona "Web" (</>) 
         *    - Registra la app con un nombre (ej: "AURA Web")
         *    - Copia el objeto "firebaseConfig"
         *    - Reemplaza el objeto firebaseConfig de abajo con tus valores
         * 
         * 7. Desplegar en GitHub Pages:
         *    - Aseg√∫rate de que el archivo index.html est√© en la rama main
         *    - Ve a Settings > Pages en tu repositorio
         *    - Selecciona la rama main y carpeta root
         *    - Guarda y espera a que se despliegue
         */

        // ========== IMPORTAR FIREBASE SDK v10 ==========
        // Importar Firebase con manejo de errores para debugging
        console.log('Importando Firebase SDK v10...');
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithCustomToken, signInWithPhoneNumber, RecaptchaVerifier, PhoneAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        console.log('‚úÖ Firebase SDK v10 importado correctamente');

        // ========== CONFIGURACI√ìN ==========
        // Studio phone number for WhatsApp contact (loaded from /api/config)
        // Default value used as fallback if API fails
        let STUDIO_PHONE = '527151596586';
        
        // Load configuration from server
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    STUDIO_PHONE = config.studioPhone || STUDIO_PHONE;
                    window.STUDIO_PHONE = STUDIO_PHONE;
                    console.log('‚úÖ Configuraci√≥n cargada desde servidor');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo cargar config del servidor, usando valores por defecto');
            }
        }
        
        // Load config immediately
        loadConfig();
        
        // Admin email is now validated server-side via /api/admin-login
        // The authenticated admin email is stored here after successful login
        let _adminEmail = null;

        // ========== CONFIGURACI√ìN DE FIREBASE ==========
        // Firebase API keys are designed to be public - security comes from Firestore Rules
        // See: https://firebase.google.com/docs/projects/api-keys
        const firebaseConfig = {
            apiKey: 'AIzaSyAi-MTJrl1I9RIexZQ9xYtN_pr1HdVvkbo',
            authDomain: 'aura-studio-2751b.firebaseapp.com',
            projectId: 'aura-studio-2751b',
            storageBucket: 'aura-studio-2751b.firebasestorage.app',
            messagingSenderId: '869187232401',
            appId: '1:869187232401:web:03e68b9502abe41c651530',
            measurementId: 'G-NE444Q9W5F'
        };

        // ========== INICIALIZAR FIREBASE ==========
        let app, auth, db, analytics;
        try {
            console.log('Inicializando Firebase con configuraci√≥n...');
            
            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Exponer variables globalmente para acceso desde otros scripts
            window.db = db;
            window.auth = auth;
            window.STUDIO_PHONE = STUDIO_PHONE; // Expose phone for WhatsApp functions
            
            // Exponer funciones de Firestore para el calendario
            window.firestoreExports = {
                collection,
                addDoc,
                query,
                where,
                orderBy,
                getDocs,
                serverTimestamp
            };
            
            // Exponer funciones de Firebase Auth para script.js
            window.firebaseAuthExports = {
                createUserWithEmailAndPassword,
                signInWithEmailAndPassword,
                signInWithCustomToken,
                signInWithPhoneNumber,
                RecaptchaVerifier,
                PhoneAuthProvider,
                onAuthStateChanged,
                signOut
            };
            
            // Helper function to create reCAPTCHA verifier with proper expired handling
            // This function is intentionally recursive - when a verifier expires,
            // it creates a new one with the same callback structure, allowing
            // seamless handling of multiple expirations without page reload.
            function createRecaptchaVerifier() {
                return new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('‚úÖ reCAPTCHA resuelto');
                    },
                    'expired-callback': () => {
                        console.log('‚ö†Ô∏è reCAPTCHA expir√≥');
                        // Clear the expired verifier
                        if (window.recaptchaVerifier) {
                            try {
                                window.recaptchaVerifier.clear();
                            } catch (e) {
                                console.log('‚ö†Ô∏è No se pudo limpiar el verifier expirado:', e);
                            }
                        }
                        // Recreate the verifier for the next attempt
                        try {
                            window.recaptchaVerifier = createRecaptchaVerifier();
                            console.log('‚úÖ reCAPTCHA verifier recreado despu√©s de expiraci√≥n');
                        } catch (e) {
                            console.error('‚ùå Error al recrear reCAPTCHA:', e);
                            window.recaptchaVerifier = null;
                        }
                    }
                });
            }
            
            // Initialize reCAPTCHA verifier (invisible)
            console.log('üîê Inicializando reCAPTCHA verifier...');
            try {
                window.recaptchaVerifier = createRecaptchaVerifier();
                console.log('‚úÖ reCAPTCHA verifier inicializado');
            } catch (error) {
                console.error('‚ùå Error al inicializar reCAPTCHA:', error);
            }
            
            console.log('‚úÖ Firebase inicializado correctamente');
            console.log('‚úÖ Firestore DB disponible globalmente');
            
            // Set a flag to indicate Firebase is ready
            window.firebaseReady = true;
            console.log('‚úÖ Firebase est√° listo para guardar reservas (window.firebaseReady = true)');
            
        } catch (error) {
            console.error('‚ùå Error al inicializar Firebase:', error);
            console.error('Detalles:', error.message);
            alert('Error al conectar con Firebase. Por favor, recarga la p√°gina o contacta al administrador.');
            window.firebaseReady = false;
        }

        // ========== VARIABLES GLOBALES ==========
        let currentUser = null;

        /**
         * Normalize phone number for comparison
         * Removes all non-digits and returns just the digits
         * @param {string} phone - Phone number to normalize
         * @returns {string} - Normalized phone (digits only)
         */
        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            // Remove all non-digit characters
            return phone.replace(/\D/g, '');
        }

        /**
         * Check if two phone numbers match
         * Handles different formats:
         * - With or without country code (52)
         * - With or without spaces, dashes, parentheses
         * @param {string} phone1 - First phone number
         * @param {string} phone2 - Second phone number
         * @returns {boolean} - True if phones match
         */
        function phonesMatch(phone1, phone2) {
            if (!phone1 || !phone2) return false;
            
            // Normalize both phones (digits only)
            const normalized1 = normalizePhoneNumber(phone1);
            const normalized2 = normalizePhoneNumber(phone2);
            
            // Direct match
            if (normalized1 === normalized2) return true;
            
            // Try matching with/without country code
            // If one has country code and other doesn't
            if (normalized1.startsWith(MEXICO_COUNTRY_CODE) && normalized1.length === PHONE_WITH_COUNTRY_CODE_LENGTH) {
                // phone1 has country code, try matching without it
                const phone1WithoutCode = normalized1.substring(MEXICO_COUNTRY_CODE.length);
                if (phone1WithoutCode === normalized2) return true;
            }
            
            if (normalized2.startsWith(MEXICO_COUNTRY_CODE) && normalized2.length === PHONE_WITH_COUNTRY_CODE_LENGTH) {
                // phone2 has country code, try matching without it
                const phone2WithoutCode = normalized2.substring(MEXICO_COUNTRY_CODE.length);
                if (phone2WithoutCode === normalized1) return true;
            }
            
            // If phone1 doesn't have country code (exactly 10 digits), try adding it
            if (normalized1.length === PHONE_DIGITS_LENGTH) {
                const phone1WithCode = MEXICO_COUNTRY_CODE + normalized1;
                if (phone1WithCode === normalized2) return true;
            }
            
            // If phone2 doesn't have country code (exactly 10 digits), try adding it
            if (normalized2.length === PHONE_DIGITS_LENGTH) {
                const phone2WithCode = MEXICO_COUNTRY_CODE + normalized2;
                if (phone2WithCode === normalized1) return true;
            }
            
            return false;
        }

        /**
         * Manejar el env√≠o del formulario de login de administrador
         * SECURE: Credentials validated server-side via /api/admin-login
         */
        function setupAdminLogin() {
            const loginForm = document.getElementById('admin-login-form');
            const loginError = document.getElementById('login-error');

            if (!loginForm) {
                console.error('‚ùå Admin login form not found');
                return;
            }

            loginForm.addEventListener('submit', async (e) => {
                // CRITICAL: Prevent form submission FIRST
                e.preventDefault();
                e.stopPropagation();
                
                console.log('üîê Admin login form submitted');
                
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                
                // Validate inputs
                if (!email || !password) {
                    loginError.textContent = 'Por favor, ingresa tu email y contrase√±a.';
                    loginError.style.display = 'block';
                    return false;
                }
                
                // Ocultar error previo
                loginError.style.display = 'none';
                
                // Check if Firebase Auth is available
                if (!auth || typeof signInWithCustomToken !== 'function') {
                    console.error('‚ùå Firebase Auth not available');
                    loginError.textContent = 'Error: Sistema de autenticaci√≥n no disponible. Por favor, recarga la p√°gina.';
                    loginError.style.display = 'block';
                    return false;
                }
                
                try {
                    console.log('üîê Validating credentials via secure API...');
                    
                    // SECURE: Validate credentials server-side
                    const response = await fetch('/api/admin-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || 'Error de autenticaci√≥n');
                    }
                    
                    console.log('‚úÖ Server validated credentials, signing in with custom token...');
                    
                    // Store the admin email for verification in onAuthStateChanged
                    _adminEmail = result.email;
                    
                    // Sign in to Firebase with the custom token from server
                    const userCredential = await signInWithCustomToken(auth, result.customToken);
                    
                    console.log('‚úÖ Firebase authentication successful');
                    
                    // Cerrar modal de login - el onAuthStateChanged se encargar√° del resto
                    const adminLoginModal = document.getElementById('admin-login-modal');
                    if (adminLoginModal) {
                        adminLoginModal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                    }
                    
                    // Limpiar formulario
                    loginForm.reset();
                    loginError.style.display = 'none';
                    
                    return false; // Ensure form doesn't submit
                    
                } catch (error) {
                    console.error('‚ùå Error de autenticaci√≥n:', error);
                    
                    // Mostrar mensaje de error
                    let errorMessage = error.message || 'Credenciales incorrectas. Por favor, verifica tu email y contrase√±a.';
                    
                    loginError.textContent = errorMessage;
                    loginError.style.display = 'block';
                    
                    return false; // Ensure form doesn't submit
                }
            });
            
            console.log('‚úÖ Admin login event listener attached');
        }

        /**
         * Configurar el bot√≥n de cerrar sesi√≥n
         * SISTEMA SUPER SIMPLE: Borrar tel√©fono y nombre de localStorage
         */
        function setupLogout() {
            // Bot√≥n de logout en el men√∫ hamburguesa (usuarios regulares)
            const menuLogoutBtn = document.getElementById('menu-logout');
            
            menuLogoutBtn.addEventListener('click', () => {
                // Borrar tel√©fono y nombre de localStorage
                localStorage.removeItem('userTelefono');
                localStorage.removeItem('userNombre');
                currentUser = null;
                
                console.log('Sesi√≥n cerrada correctamente');
                
                // Ocultar secci√≥n "Mis Clases"
                hideUserClasses();
                
                // Actualizar UI
                updateUIForLoggedOutUser();
                
                // Cerrar el men√∫
                document.getElementById('menu-dropdown').style.display = 'none';
                document.getElementById('hamburger-btn').setAttribute('aria-expanded', 'false');
                document.getElementById('menu-dropdown').setAttribute('aria-hidden', 'true');
            });
            
            // Bot√≥n de logout admin en el men√∫ hamburguesa
            const menuAdminLogoutBtn = document.getElementById('menu-admin-logout');
            if (menuAdminLogoutBtn) {
                menuAdminLogoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        console.log('Sesi√≥n de admin cerrada correctamente');
                        
                        // Cerrar el men√∫
                        document.getElementById('menu-dropdown').style.display = 'none';
                        document.getElementById('hamburger-btn').setAttribute('aria-expanded', 'false');
                        document.getElementById('menu-dropdown').setAttribute('aria-hidden', 'true');
                    } catch (error) {
                        console.error('Error al cerrar sesi√≥n:', error);
                        alert('Error al cerrar sesi√≥n. Por favor, int√©ntalo de nuevo.');
                    }
                });
            }
            
            // Bot√≥n de logout en el panel de admin (si existe)
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        console.log('Sesi√≥n cerrada correctamente');
                    } catch (error) {
                        console.error('Error al cerrar sesi√≥n:', error);
                        alert('Error al cerrar sesi√≥n. Por favor, int√©ntalo de nuevo.');
                    }
                });
            }
        }

        /**
         * Actualizar UI para usuario logueado
         * When logged in: Show only "Mis Clases" section, hide other sections, show "Volver Atr√°s"
         */
        function updateUIForLoggedInUser() {
            const menuLogout = document.getElementById('menu-logout');
            const menuRegister = document.getElementById('menu-register');
            const menuMyClasses = document.getElementById('menu-my-classes');
            const menuBack = document.getElementById('menu-back');
            const menuAdminLogin = document.getElementById('menu-admin-login');
            
            // Mostrar bot√≥n de logout y "Volver Atr√°s"
            if (menuLogout) menuLogout.style.display = 'block';
            if (menuBack) menuBack.style.display = 'block';
            
            // Ocultar opciones de registro, iniciar sesi√≥n y admin login
            if (menuRegister) menuRegister.style.display = 'none';
            if (menuMyClasses) menuMyClasses.style.display = 'none';
            if (menuAdminLogin) menuAdminLogin.style.display = 'none';
            
            // Hide all sections except "Mis Clases"
            hideAllSectionsExceptMyClasses();
        }
        
        /**
         * Actualizar UI para usuario no logueado
         * When logged out: Show all sections, show "Iniciar Sesi√≥n", hide "Volver Atr√°s"
         */
        function updateUIForLoggedOutUser() {
            const menuLogout = document.getElementById('menu-logout');
            const menuRegister = document.getElementById('menu-register');
            const menuMyClasses = document.getElementById('menu-my-classes');
            const menuBack = document.getElementById('menu-back');
            const menuAdminLogin = document.getElementById('menu-admin-login');
            
            // Ocultar bot√≥n de logout y "Volver Atr√°s"
            if (menuLogout) menuLogout.style.display = 'none';
            if (menuBack) menuBack.style.display = 'none';
            
            // Mostrar opciones de registro, iniciar sesi√≥n y admin login
            if (menuRegister) menuRegister.style.display = 'block';
            if (menuMyClasses) {
                menuMyClasses.style.display = 'block';
                menuMyClasses.textContent = 'Iniciar Sesi√≥n'; // Ensure text is correct
            }
            if (menuAdminLogin) menuAdminLogin.style.display = 'block';
            
            // Show all sections (restore normal view)
            showAllSectionsExceptAdmin();
        }
        
        /**
         * Hide all sections except "Mis Clases" section
         * Used when user logs in to show only their classes
         */
        function hideAllSectionsExceptMyClasses() {
            const sections = [
                'hero-section',
                'about-section',
                'booking-section',
                'contact-section'
            ];
            
            sections.forEach(className => {
                const section = document.querySelector('.' + className);
                if (section) section.style.display = 'none';
            });
            
            // Ensure "Mis Clases" section is visible
            const myClassesSection = document.getElementById('my-classes-section');
            if (myClassesSection) myClassesSection.style.display = 'block';
        }
        
        /**
         * Show all sections except admin panel
         * Used when user clicks "Volver Atr√°s" or logs out
         */
        function showAllSectionsExceptAdmin() {
            const sections = [
                { className: 'hero-section', display: 'flex' },
                { className: 'about-section', display: 'block' },
                { className: 'booking-section', display: 'block' },
                { className: 'contact-section', display: 'block' }
            ];
            
            sections.forEach(({ className, display }) => {
                const section = document.querySelector('.' + className);
                if (section) section.style.display = display;
            });
            
            // Hide admin panel
            const adminPanel = document.getElementById('admin-panel-section');
            if (adminPanel) adminPanel.style.display = 'none';
        }
        
        // ========== EXPOSE UI FUNCTIONS GLOBALLY ==========
        // These functions need to be accessible from other script blocks
        window.updateUIForLoggedInUser = updateUIForLoggedInUser;
        window.updateUIForLoggedOutUser = updateUIForLoggedOutUser;
        window.hideAllSectionsExceptMyClasses = hideAllSectionsExceptMyClasses;
        window.showAllSectionsExceptAdmin = showAllSectionsExceptAdmin;
        
        // ========== MOBILE ADMIN VIEW CONSTANTS ==========
        const MOBILE_BREAKPOINT = 768; // Max width for mobile view
        
        /**
         * Apply mobile-admin-view class to body on mobile devices
         * This hides all sections except admin panel, header, and hamburger menu
         */
        function applyMobileAdminView() {
            // Check if we're on a mobile device
            if (window.innerWidth <= MOBILE_BREAKPOINT) {
                document.body.classList.add('mobile-admin-view');
                console.log('‚úÖ Mobile admin view applied - hiding non-admin sections');
            }
        }
        
        /**
         * Remove mobile-admin-view class from body
         * This restores visibility of all sections
         */
        function removeMobileAdminView() {
            document.body.classList.remove('mobile-admin-view');
            console.log('‚úÖ Mobile admin view removed - showing all sections');
        }
        
        /**
         * Observar cambios en el estado de autenticaci√≥n
         * SISTEMA SUPER SIMPLE: Verificar localStorage al cargar la p√°gina
         */
        function setupAuthObserver() {
            // Verificar si hay un tel√©fono guardado en localStorage
            const savedTelefono = localStorage.getItem('userTelefono');
            const savedNombre = localStorage.getItem('userNombre');
            if (savedTelefono) {
                console.log('Usuario ya logueado con tel√©fono:', savedTelefono, 'nombre:', savedNombre);
                currentUser = { telefono: savedTelefono, nombre: savedNombre || '' };
                updateUIForLoggedInUser();
                loadUserClasses(savedTelefono);
            } else {
                console.log('No hay usuario logueado');
                currentUser = null;
                updateUIForLoggedOutUser();
                hideUserClasses();
            }
            
            // Mantener la autenticaci√≥n de Firebase para admin
            onAuthStateChanged(auth, async (user) => {
                const adminLoginModal = document.getElementById('admin-login-modal');
                const adminPanel = document.getElementById('admin-panel-section');
                const loginForm = document.getElementById('admin-login-form');
                const loginError = document.getElementById('login-error');
                const menuAdminLogin = document.getElementById('menu-admin-login');
                const menuAdminLogout = document.getElementById('menu-admin-logout');
                
                if (user) {
                    // Si es admin, mostrar panel y cerrar modal
                    // Check if this is an admin user (authenticated via /api/admin-login)
                    // Custom token auth uses uid = email, or we check the _adminEmail set during login
                    const isAdminUser = _adminEmail && (user.uid === _adminEmail || user.email === _adminEmail);
                    
                    if (isAdminUser) {
                        console.log('‚úÖ Admin autenticado, mostrando panel...');
                        
                        // Establecer flag de admin globalmente para el calendario
                        window.isAdmin = true;
                        isAdmin = true;
                        
                        // Cerrar modal de login de manera segura
                        if (adminLoginModal) {
                            adminLoginModal.style.display = 'none';
                        }
                        // Restore page scrolling by removing modal-open class and resetting overflow
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = ''; // Explicitly reset overflow
                        
                        // Mostrar panel de admin
                        if (adminPanel) {
                            adminPanel.style.display = 'block';
                            console.log('‚úÖ Panel de admin mostrado');
                        } else {
                            console.error('‚ùå No se encontr√≥ el panel de admin');
                        }
                        
                        // Apply mobile-admin-view class on mobile devices
                        applyMobileAdminView();
                        
                        // Mostrar nombre del admin
                        document.getElementById('admin-email-display').textContent = 'Michel';
                        
                        // Limpiar formulario de login
                        if (loginForm) {
                            loginForm.reset();
                        }
                        if (loginError) {
                            loginError.style.display = 'none';
                        }
                        
                        // Cargar reservas (que inicializa el calendario autom√°ticamente)
                        try {
                            await loadReservations();
                        } catch (error) {
                            console.error('Error al cargar reservas en auth observer:', error);
                            // Fallback: Initialize calendar directly if reservation loading fails
                            if (!window.adminCalendar) {
                                try {
                                    initAdminCalendar();
                                } catch (calError) {
                                    console.error('Error al inicializar calendario:', calError);
                                }
                            }
                        }
                        
                        // Recargar eventos del calendario si est√° inicializado
                        if (typeof calendar !== 'undefined' && calendar) {
                            console.log('Recargando eventos del calendario como admin...');
                            try {
                                loadEventsFromFirestore();
                            } catch (error) {
                                console.error('Error al cargar eventos del calendario:', error);
                            }
                        }
                        
                        // Scroll to admin panel - ensure this always happens
                        setTimeout(() => {
                            if (adminPanel) {
                                adminPanel.scrollIntoView({ behavior: 'smooth' });
                                console.log('‚úÖ Scroll al panel de admin completado');
                            }
                        }, 300);
                        
                        // Ocultar login de admin y mostrar logout de admin en el men√∫
                        if (menuAdminLogin) menuAdminLogin.style.display = 'none';
                        if (menuAdminLogout) menuAdminLogout.style.display = 'block';
                    }
                } else {
                    // No hay admin autenticado
                    window.isAdmin = false;
                    isAdmin = false;
                    _adminEmail = null; // Clear admin email on logout
                    
                    // Remove mobile-admin-view class
                    removeMobileAdminView();
                    
                    // Ocultar panel de admin
                    adminPanel.style.display = 'none';
                    
                    // Mostrar login de admin y ocultar logout de admin en el men√∫
                    if (menuAdminLogin) menuAdminLogin.style.display = 'block';
                    if (menuAdminLogout) menuAdminLogout.style.display = 'none';
                    
                    // Recargar eventos del calendario como usuario no autenticado
                    if (typeof calendar !== 'undefined' && calendar) {
                        console.log('Recargando eventos del calendario sin autenticaci√≥n...');
                        loadEventsFromFirestore();
                    }
                }
            });
        }

        // ========== FUNCIONES DE FIRESTORE ==========

        /**
         * Guardar reserva en Firestore
         * @param {string} nombre - Nombre del cliente
         * @param {string} telefono - Tel√©fono del cliente (nuevo sistema)
         * @param {string} fechaHora - Fecha y hora en formato ISO (YYYY-MM-DDTHH:mm:ss)
         * @param {string} notas - Notas adicionales (opcional)
         * @returns {Promise<string>} ID del documento creado
         */
        async function saveReservation(nombre, telefono, fechaHora, notas = '') {
            try {
                console.log('üíæ Intentando guardar reserva:', { nombre, telefono, fechaHora, notas });
                
                // Validar que Firebase est√© inicializado
                if (!db) {
                    throw new Error('‚ùå Firebase Firestore no est√° inicializado. Por favor, recarga la p√°gina.');
                }
                
                // Validar que fechaHora est√© en formato ISO
                const dateTest = new Date(fechaHora);
                if (isNaN(dateTest.getTime())) {
                    throw new Error('‚ùå Formato de fecha inv√°lido. Se requiere formato ISO (YYYY-MM-DDTHH:mm:ss)');
                }
                
                // Validar datos requeridos
                if (!nombre || !telefono) {
                    throw new Error('‚ùå Nombre y tel√©fono son requeridos');
                }
                
                const docRef = await addDoc(collection(db, 'reservas'), {
                    nombre: nombre,
                    telefono: telefono.trim(),
                    fechaHora: fechaHora, // Formato ISO: YYYY-MM-DDTHH:mm:ss
                    notas: notas || '',
                    timestamp: serverTimestamp()
                });
                
                console.log('‚úÖ Reserva guardada con ID:', docRef.id, '- fechaHora (ISO):', fechaHora);
                return docRef.id;
                
            } catch (error) {
                console.error('‚ùå Error al guardar reserva:', error);
                console.error('‚ùå Detalles del error:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                throw error;
            }
        }
        
        // Exponer funci√≥n globalmente inmediatamente despu√©s de definirla
        // Esto asegura que est√© disponible antes de que el usuario intente usarla
        window.saveReservationToFirestore = saveReservation;
        console.log('‚úÖ Funci√≥n saveReservationToFirestore expuesta globalmente');

        /**
         * Obtener perfil del usuario desde Firestore
         * @param {string} email - Email del usuario
         * @returns {Promise<Object|null>} Perfil del usuario o null si no existe
         */
        async function getUserProfile(email) {
            try {
                const emailLower = email.toLowerCase().trim();
                console.log('üîç Buscando perfil de usuario para:', emailLower);
                
                const q = query(collection(db, 'usuarios'), where('email', '==', emailLower));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    // Si hay m√∫ltiples perfiles (duplicados), usar el primero
                    if (querySnapshot.docs.length > 1) {
                        console.warn(`‚ö†Ô∏è Se encontraron ${querySnapshot.docs.length} perfiles para ${emailLower}. Usando el primero.`);
                    }
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    console.log('‚úÖ Perfil encontrado:', userData.nombre);
                    return userData;
                } else {
                    console.log('‚ÑπÔ∏è No se encontr√≥ perfil para:', emailLower);
                }
                return null;
            } catch (error) {
                console.error('‚ùå Error al obtener perfil de usuario:', error);
                console.error('Detalles del error:', error.message);
                return null;
            }
        }
        
        // Exponer funci√≥n globalmente
        window.getUserProfile = getUserProfile;

        /**
         * Cargar todas las reservas desde Firestore
         * Carga directamente en el calendario de administrador
         */
        async function loadReservations() {
            const loadingDiv = document.getElementById('reservations-loading');
            const noReservationsDiv = document.getElementById('no-reservations');
            
            // Mostrar loading
            loadingDiv.style.display = 'block';
            noReservationsDiv.style.display = 'none';
            
            try {
                // Consultar todas las reservas ordenadas por timestamp descendente
                const q = query(collection(db, 'reservas'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                // Always initialize calendar and show controls, regardless of whether there are reservations
                if (!window.adminCalendar) {
                    initAdminCalendar();
                } else {
                    await loadAdminCalendarReservations();
                }
                
                // Hide loading
                loadingDiv.style.display = 'none';
                
                // Show "no reservations" message if empty, but calendar controls remain visible
                if (querySnapshot.empty) {
                    noReservationsDiv.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error al cargar reservas:', error);
                loadingDiv.innerHTML = '<p style="color: #EFE9E1;">Error al cargar reservas. Por favor, recarga la p√°gina.</p>';
            }
        }

        /**
         * Extraer el primer nombre de un nombre completo
         * Ejemplo: "Ketzy Gallegos" -> "Ketzy"
         */
        function extractFirstName(fullName) {
            if (!fullName || typeof fullName !== 'string') {
                return '';
            }
            const trimmed = fullName.trim();
            const parts = trimmed.split(/\s+/);
            return parts[0] || trimmed;
        }

        /**
         * Inicializar calendario del panel de administrador
         */
        let adminCalendar = null;
        
        function initAdminCalendar() {
            console.log('Inicializando calendario de administrador...');
            
            const calendarEl = document.getElementById('admin-calendar');
            
            if (!calendarEl) {
                console.error('‚ùå ERROR: Div #admin-calendar no encontrado');
                return;
            }
            
            try {
                // Detect if mobile device (max-width: 768px)
                const isMobile = window.innerWidth <= 768;
                const initialView = isMobile ? 'timeGridDay' : 'timeGridWeek';
                
                console.log(`üì± Dispositivo: ${isMobile ? 'M√≥vil' : 'Escritorio'} - Vista inicial: ${initialView}`);
                
                adminCalendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: initialView,
                    locale: 'es',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    slotMinTime: '06:00:00',
                    slotMaxTime: '20:00:00',
                    allDaySlot: false,
                    expandRows: true,
                    contentHeight: 'auto',
                    height: 'auto',
                    nowIndicator: true,
                    slotDuration: '00:30:00',
                    slotLabelInterval: '01:00',
                    editable: false,
                    selectable: false,
                    
                    // Enhanced visual configuration
                    buttonText: {
                        today: 'Hoy',
                        month: 'Mes',
                        week: 'Semana',
                        day: 'D√≠a'
                    },
                    
                    // Custom day header format - show only first letter (L M M J V S D)
                    dayHeaderFormat: { weekday: 'narrow' },
                    
                    eventClick: function(info) {
                        showEventDetailModal(info.event);
                    },
                    
                    eventDidMount: function(info) {
                        // Add icon to event title
                        const title = info.el.querySelector('.fc-event-title');
                        if (title && !title.querySelector('.event-icon')) {
                            const icon = document.createElement('span');
                            icon.className = 'event-icon';
                            icon.textContent = 'üë§ ';
                            title.prepend(icon);
                        }
                    },
                    
                    events: []
                });
                
                adminCalendar.render();
                console.log('‚úÖ Calendario de administrador inicializado');
                
                // Show calendar view and controls
                document.getElementById('admin-calendar-view').style.display = 'block';
                document.getElementById('admin-calendar-controls').style.display = 'block';
                document.getElementById('admin-stats-section').style.display = 'block';
                
                // Setup calendar controls
                setupAdminCalendarControls();
                
                // Cargar reservas
                loadAdminCalendarReservations();
                
            } catch (error) {
                console.error('‚ùå ERROR al inicializar calendario de admin:', error);
            }
        }

        /**
         * Cargar reservas en el calendario de administrador
         */
        let allReservationsData = []; // Store all reservations for filtering
        
        async function loadAdminCalendarReservations() {
            if (!adminCalendar) {
                console.warn('‚ö†Ô∏è Calendario de admin no inicializado');
                return;
            }
            
            console.log('Cargando reservas en calendario de admin...');
            
            try {
                // Limpiar eventos existentes
                adminCalendar.getEvents().forEach(event => event.remove());
                allReservationsData = [];
                
                const q = query(collection(db, 'reservas'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                // First, collect all reservations
                const reservations = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Parsear fechaHora
                    let startDate = null;
                    if (data.fechaHora) {
                        startDate = parseFechaHora(data.fechaHora);
                    }
                    
                    if (!startDate && data.timestamp) {
                        startDate = data.timestamp.toDate();
                    }
                    
                    if (startDate) {
                        // Extraer solo el primer nombre
                        const firstName = extractFirstName(data.nombre);
                        
                        // Calcular hora de fin (1 hora despu√©s)
                        const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                        
                        reservations.push({
                            id: doc.id,
                            firstName: firstName || 'Reserva',
                            start: startDate,
                            end: endDate,
                            fullName: data.nombre,
                            telefono: data.telefono || data.email, // Soportar ambos por compatibilidad
                            notas: data.notas,
                            firebaseId: doc.id
                        });
                    }
                });
                
                // Group reservations by date and time slot
                const groupedReservations = new Map();
                
                reservations.forEach((reservation) => {
                    // Create a key based on start time (year-month-day-hour-minute)
                    const key = `${reservation.start.getFullYear()}-${reservation.start.getMonth()}-${reservation.start.getDate()}-${reservation.start.getHours()}-${reservation.start.getMinutes()}`;
                    
                    if (!groupedReservations.has(key)) {
                        groupedReservations.set(key, []);
                    }
                    groupedReservations.get(key).push(reservation);
                });
                
                // Create calendar events from grouped reservations
                groupedReservations.forEach((group, key) => {
                    const firstReservation = group[0];
                    
                    let eventData;
                    if (group.length === 1) {
                        // Single reservation - keep existing format
                        eventData = {
                            id: firstReservation.id,
                            title: firstReservation.firstName,
                            start: firstReservation.start,
                            end: firstReservation.end,
                            backgroundColor: '#EFE9E1',
                            borderColor: '#EFE9E1',
                            textColor: '#333',
                            overlap: true, // Allow overlapping reservations
                            extendedProps: {
                                fullName: firstReservation.fullName,
                                telefono: firstReservation.telefono,
                                notas: firstReservation.notas,
                                firebaseId: firstReservation.firebaseId,
                                isGrouped: false
                            }
                        };
                    } else {
                        // Multiple reservations at same time - create grouped event
                        // Show all names in admin calendar (e.g., "Rosa, Ketzy, Carolina")
                        const names = group
                            .map(r => extractFirstName(r.fullName))
                            .filter(name => name.length > 0) // Filter out empty names
                            .join(', ');
                        eventData = {
                            id: key,
                            title: names || `${group.length} Personas`, // Fallback if no valid names
                            start: firstReservation.start,
                            end: firstReservation.end,
                            backgroundColor: '#EFE9E1',
                            borderColor: '#EFE9E1',
                            textColor: '#333',
                            overlap: true, // Allow overlapping reservations
                            extendedProps: {
                                isGrouped: true,
                                count: group.length,
                                participants: group.map(r => ({
                                    fullName: r.fullName,
                                    telefono: r.telefono,
                                    notas: r.notas,
                                    firebaseId: r.firebaseId
                                }))
                            }
                        };
                    }
                    
                    // Store for filtering
                    allReservationsData.push(eventData);
                    
                    // Add to calendar
                    adminCalendar.addEvent(eventData);
                });
                
                console.log(`‚úÖ ${querySnapshot.size} reservas cargadas en calendario de admin (${groupedReservations.size} eventos)`);
                
                // Update statistics
                updateAdminStatistics();
                
            } catch (error) {
                console.error('‚ùå Error al cargar reservas en calendario de admin:', error);
            }
        }
        
        /**
         * Update admin statistics
         */
        function updateAdminStatistics() {
            if (!allReservationsData || allReservationsData.length === 0) {
                return;
            }
            
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay() + 1); // Monday
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Sunday
            endOfWeek.setHours(23, 59, 59, 999);
            
            // Count total reservations (including grouped participants)
            let totalReservations = 0;
            let thisWeekCount = 0;
            let upcomingCount = 0;
            const uniqueEmails = new Set();
            
            allReservationsData.forEach(event => {
                const eventDate = new Date(event.start);
                
                if (event.extendedProps.isGrouped && event.extendedProps.participants) {
                    // Count each participant in grouped events
                    const participantCount = event.extendedProps.participants.length;
                    totalReservations += participantCount;
                    
                    // Count this week
                    if (eventDate >= startOfWeek && eventDate <= endOfWeek) {
                        thisWeekCount += participantCount;
                    }
                    
                    // Count upcoming
                    if (eventDate >= now) {
                        upcomingCount += participantCount;
                    }
                    
                    // Add unique telefonos
                    event.extendedProps.participants.forEach(p => {
                        if (p.telefono) uniqueEmails.add(p.telefono);
                    });
                } else {
                    // Single reservation
                    totalReservations += 1;
                    
                    if (eventDate >= startOfWeek && eventDate <= endOfWeek) {
                        thisWeekCount += 1;
                    }
                    
                    if (eventDate >= now) {
                        upcomingCount += 1;
                    }
                    
                    if (event.extendedProps.telefono) {
                        uniqueEmails.add(event.extendedProps.telefono);
                    }
                }
            });
            
            // Update UI
            document.getElementById('stat-total-reservations').textContent = totalReservations;
            document.getElementById('stat-this-week').textContent = thisWeekCount;
            document.getElementById('stat-unique-clients').textContent = uniqueEmails.size;
            document.getElementById('stat-upcoming').textContent = upcomingCount;
        }
        
        /**
         * Show unique clients modal with list of all unique clients and their data
         */
        function showUniqueClientsModal() {
            if (!allReservationsData || allReservationsData.length === 0) {
                showCustomAlert('No hay clientes para mostrar', 'info', 'Informaci√≥n');
                return;
            }
            
            // Helper function to update client statistics
            function updateClientStats(client, eventDate) {
                client.totalClasses += 1;
                const now = new Date();
                if (eventDate >= now) {
                    client.upcomingClasses += 1;
                } else {
                    client.pastClasses += 1;
                }
            }
            
            // Collect unique clients with their data
            const clientsMap = new Map();
            
            allReservationsData.forEach(event => {
                const eventDate = new Date(event.start);
                
                if (event.extendedProps.isGrouped && event.extendedProps.participants) {
                    // Process grouped events
                    event.extendedProps.participants.forEach(p => {
                        if (p.telefono) {
                            if (!clientsMap.has(p.telefono)) {
                                clientsMap.set(p.telefono, {
                                    nombre: p.fullName || 'Sin nombre',
                                    telefono: p.telefono,
                                    totalClasses: 0,
                                    upcomingClasses: 0,
                                    pastClasses: 0
                                });
                            }
                            const client = clientsMap.get(p.telefono);
                            updateClientStats(client, eventDate);
                        }
                    });
                } else {
                    // Process single reservation
                    const telefono = event.extendedProps.telefono;
                    if (telefono) {
                        if (!clientsMap.has(telefono)) {
                            clientsMap.set(telefono, {
                                nombre: event.extendedProps.fullName || 'Sin nombre',
                                telefono: telefono,
                                totalClasses: 0,
                                upcomingClasses: 0,
                                pastClasses: 0
                            });
                        }
                        const client = clientsMap.get(telefono);
                        updateClientStats(client, eventDate);
                    }
                }
            });
            
            // Convert to array and sort by total classes (descending)
            const clientsArray = Array.from(clientsMap.values());
            clientsArray.sort((a, b) => b.totalClasses - a.totalClasses);
            
            // Build HTML for client list
            const clientsList = document.getElementById('unique-clients-list');
            if (clientsArray.length === 0) {
                clientsList.innerHTML = '<p style="text-align: center; color: #666;">No hay clientes registrados</p>';
            } else {
                let html = '<div class="unique-clients-grid">';
                
                clientsArray.forEach((client, index) => {
                    // Sanitize data for HTML (including numeric index for consistency)
                    const safeNombre = escapeHtml(client.nombre);
                    const safeTelefono = escapeHtml(client.telefono);
                    const safeIndex = parseInt(index, 10); // Ensure index is a valid integer
                    
                    html += `
                        <div class="unique-client-card" data-index="${safeIndex}">
                            <div class="unique-client-header">
                                <div class="unique-client-icon">üë§</div>
                                <div class="unique-client-info">
                                    <div class="unique-client-name">${safeNombre}</div>
                                    <div class="unique-client-phone">üì± ${safeTelefono}</div>
                                </div>
                            </div>
                            <div class="unique-client-stats">
                                <div class="unique-client-stat">
                                    <div class="unique-client-stat-value">${client.totalClasses}</div>
                                    <div class="unique-client-stat-label">Total Clases</div>
                                </div>
                                <div class="unique-client-stat">
                                    <div class="unique-client-stat-value">${client.upcomingClasses}</div>
                                    <div class="unique-client-stat-label">Pr√≥ximas</div>
                                </div>
                            </div>
                            <div class="unique-client-actions">
                                <button type="button" class="unique-client-btn unique-client-btn-whatsapp" 
                                    data-client-index="${safeIndex}">
                                    üì± WhatsApp
                                </button>
                                <button type="button" class="unique-client-btn unique-client-btn-classes" 
                                    data-client-index="${safeIndex}">
                                    üìÖ Ver Clases
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                clientsList.innerHTML = html;
                
                // Add event listeners to all buttons
                attachClientButtonListeners(clientsArray);
            }
            
            // Show modal
            document.getElementById('unique-clients-modal').style.display = 'flex';
        }
        
        /**
         * Helper function to validate and get client from index attribute
         */
        function getClientFromIndexAttribute(element, clientsArray) {
            const indexStr = element.getAttribute('data-client-index');
            if (!indexStr) {
                console.error('Missing data-client-index attribute');
                return null;
            }
            
            const index = parseInt(indexStr, 10);
            if (isNaN(index) || index < 0 || index >= clientsArray.length) {
                console.error('Invalid client index:', indexStr);
                return null;
            }
            
            return clientsArray[index];
        }
        
        /**
         * Attach event listeners to client action buttons
         */
        function attachClientButtonListeners(clientsArray) {
            // WhatsApp buttons
            document.querySelectorAll('.unique-client-btn-whatsapp').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const client = getClientFromIndexAttribute(this, clientsArray);
                    if (client) {
                        await contactClientFromList(client.telefono, client.nombre);
                    }
                });
            });
            
            // View Classes buttons
            document.querySelectorAll('.unique-client-btn-classes').forEach(btn => {
                btn.addEventListener('click', function() {
                    const client = getClientFromIndexAttribute(this, clientsArray);
                    if (client) {
                        searchClientReservations(client.telefono);
                    }
                });
            });
        }
        
        /**
         * Close unique clients modal
         */
        function closeUniqueClientsModal() {
            document.getElementById('unique-clients-modal').style.display = 'none';
        }
        
        /**
         * Helper function to detect if device is mobile
         * Uses both user agent and screen width for better detection
         */
        function isMobileDevice() {
            // Check user agent first (most reliable for actual mobile devices)
            const mobileUserAgent = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // If user agent indicates mobile, trust it
            if (mobileUserAgent) {
                return true;
            }
            
            // For non-mobile user agents, check if it's a touch device with small screen
            // This catches tablets and edge cases
            const narrowScreen = window.innerWidth <= 768;
            
            // Check if matchMedia is supported (for older browsers)
            if (window.matchMedia) {
                const hasCoarsePointer = window.matchMedia('(pointer: coarse)').matches;
                return narrowScreen && hasCoarsePointer;
            }
            
            // Fallback for older browsers: just check screen width
            return narrowScreen;
        }
        
        /**
         * Helper function to open WhatsApp link (mobile-compatible)
         * Handles both mobile navigation and desktop new tab behavior
         */
        function openWhatsAppLink(url) {
            // Timeout to check if popup was blocked
            const POPUP_CHECK_DELAY_MS = 100;
            
            if (isMobileDevice()) {
                // On mobile, use location.href for better compatibility
                // This navigates away but WhatsApp will open, user can return with back button
                window.location.href = url;
            } else {
                // On desktop, try to open in new tab
                const newWindow = window.open(url, '_blank');
                
                // Check if popup was blocked (with small delay for popup to initialize)
                setTimeout(() => {
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        // Popup was blocked, provide feedback and use fallback
                        console.warn('‚ö†Ô∏è Popup blocked. Redirecting in same window...');
                        window.location.href = url;
                    }
                }, POPUP_CHECK_DELAY_MS);
            }
        }
        
        /**
         * Contact client from unique clients list
         */
        async function contactClientFromList(telefono, nombre) {
            if (!telefono) {
                showCustomAlert('No hay tel√©fono disponible para este cliente', 'warning', 'Atenci√≥n');
                return;
            }
            
            const normalizedPhone = normalizePhoneForWhatsApp(telefono);
            if (!normalizedPhone) {
                showCustomAlert('N√∫mero de tel√©fono inv√°lido.\n\nSe requiere un n√∫mero mexicano de 10 d√≠gitos.', 'warning', 'Atenci√≥n');
                return;
            }
            
            // Generate personalized message with client's schedule
            const mensajePersonalizado = await generateAdminToClientMessage(telefono, nombre || 'Cliente');
            
            if (!mensajePersonalizado) {
                // Fallback to generic message if generation fails
                const mensaje = encodeURIComponent(`¬°Hola ${nombre || 'Cliente'}!\n\nSomos AURA Studio. ¬øEn qu√© podemos ayudarte? üòä`);
                openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
                return;
            }
            
            const mensaje = encodeURIComponent(mensajePersonalizado);
            openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
        }
        
        /**
         * Search client reservations by phone number
         */
        function searchClientReservations(telefono) {
            // Close the unique clients modal
            closeUniqueClientsModal();
            
            // Set the search input to the client's phone number
            const searchInput = document.getElementById('search-client');
            if (searchInput) {
                searchInput.value = telefono;
                // Trigger the search
                applyFilters();
                
                // Scroll to the calendar view
                setTimeout(() => {
                    const calendarView = document.getElementById('admin-calendar-view');
                    if (calendarView && calendarView.style.display !== 'none') {
                        calendarView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 300);
            }
        }
        
        /**
         * Setup unique clients stat card click handler
         */
        function setupUniqueClientsStatCard() {
            const uniqueClientsStatValue = document.getElementById('stat-unique-clients');
            if (uniqueClientsStatValue) {
                const uniqueClientsCard = uniqueClientsStatValue.closest('.stat-card');
                if (uniqueClientsCard) {
                    uniqueClientsCard.style.cursor = 'pointer';
                    uniqueClientsCard.addEventListener('click', showUniqueClientsModal);
                } else {
                    console.warn('Could not find parent .stat-card element for unique clients stat');
                }
            } else {
                console.warn('Could not find #stat-unique-clients element');
            }
        }
        
        /**
         * Setup admin calendar controls
         */
        function setupAdminCalendarControls() {
            // Search by client
            const searchInput = document.getElementById('search-client');
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            });
            
            // Filter buttons (removed filter/clear/refresh buttons, keeping only export and schedule)
            document.getElementById('btn-export-calendar').addEventListener('click', exportCalendarData);
            document.getElementById('btn-export-availability').addEventListener('click', exportAvailabilityData);
            document.getElementById('btn-schedule-admin').addEventListener('click', openAdminScheduleModal);
            
            // Setup unique clients stat card
            setupUniqueClientsStatCard();
            
            // Unique clients modal controls
            document.getElementById('unique-clients-close').addEventListener('click', closeUniqueClientsModal);
            document.getElementById('unique-clients-close-btn').addEventListener('click', closeUniqueClientsModal);
            document.getElementById('unique-clients-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUniqueClientsModal();
                }
            });
            
            // Event detail modal controls
            document.getElementById('event-detail-close').addEventListener('click', closeEventDetailModal);
            document.getElementById('detail-close-btn').addEventListener('click', closeEventDetailModal);
            document.getElementById('detail-contact-btn').addEventListener('click', contactClient);
            document.getElementById('detail-whatsapp-btn').addEventListener('click', sendClassScheduleToClient);
            document.getElementById('detail-edit-btn').addEventListener('click', openEditReservationModal);
            
            // Edit reservation modal controls
            document.getElementById('edit-reservation-close').addEventListener('click', closeEditReservationModal);
            document.getElementById('edit-reservation-cancel').addEventListener('click', closeEditReservationModal);
            document.getElementById('edit-reservation-save').addEventListener('click', saveEditedReservation);
            document.getElementById('edit-reservation-delete').addEventListener('click', deleteReservation);
            
            // Close edit modal on background click
            document.getElementById('edit-reservation-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditReservationModal();
                }
            });
            
            // Event delegation for participant contact buttons
            document.getElementById('event-detail-modal').addEventListener('click', async function(e) {
                if (e.target.classList.contains('btn-participant-contact')) {
                    const telefono = e.target.getAttribute('data-telefono');
                    const nombre = e.target.getAttribute('data-nombre');
                    
                    if (!telefono) {
                        alert('‚ö†Ô∏è No hay tel√©fono disponible para este participante');
                        return;
                    }
                    
                    const normalizedPhone = normalizePhoneForWhatsApp(telefono);
                    if (!normalizedPhone) {
                        alert('‚ö†Ô∏è N√∫mero de tel√©fono inv√°lido.\n\nSe requiere un n√∫mero mexicano de 10 d√≠gitos.');
                        return;
                    }
                    
                    // Generate personalized message with client's schedule
                    const mensajePersonalizado = await generateAdminToClientMessage(telefono, nombre || 'Cliente');
                    
                    if (!mensajePersonalizado) {
                        // Fallback to generic message if generation fails
                        const mensaje = encodeURIComponent(`¬°Hola ${nombre || 'Cliente'}!\n\nSomos AURA Studio. ¬øEn qu√© podemos ayudarte? üòä`);
                        openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
                        return;
                    }
                    
                    const mensaje = encodeURIComponent(mensajePersonalizado);
                    openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
                }
                
                // Event delegation for participant edit buttons
                if (e.target.classList.contains('btn-participant-edit')) {
                    const telefono = e.target.getAttribute('data-telefono');
                    const nombre = e.target.getAttribute('data-nombre');
                    const firebaseId = e.target.getAttribute('data-firebase-id');
                    
                    if (!firebaseId) {
                        alert('‚ö†Ô∏è No se encontr√≥ informaci√≥n para editar este participante');
                        return;
                    }
                    
                    // Find the participant's individual event from allReservationsData
                    // Since grouped events still have individual reservations, search for the single event by firebaseId
                    let participantEvent = allReservationsData.find(event => 
                        event.extendedProps && 
                        event.extendedProps.firebaseId === firebaseId
                    );
                    
                    // If not found in single events, it might be stored in a grouped event's participants
                    if (!participantEvent) {
                        // Search through grouped events
                        for (const event of allReservationsData) {
                            if (event.extendedProps && event.extendedProps.isGrouped && event.extendedProps.participants) {
                                const participant = event.extendedProps.participants.find(p => p.firebaseId === firebaseId);
                                if (participant) {
                                    // Create a pseudo-event for this participant with the same time slot
                                    participantEvent = {
                                        start: event.start,
                                        end: event.end,
                                        title: participant.fullName,
                                        extendedProps: {
                                            fullName: participant.fullName,
                                            telefono: participant.telefono,
                                            notas: participant.notas,
                                            firebaseId: participant.firebaseId
                                        }
                                    };
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (!participantEvent) {
                        alert('‚ùå No se encontr√≥ informaci√≥n del evento para editar');
                        return;
                    }
                    
                    // Set the current event and open edit modal
                    window.currentEvent = participantEvent;
                    window.currentEventTelefono = telefono;
                    window.currentEventNombre = nombre;
                    openEditReservationModal();
                }
            });
            
            // Close modal on background click
            document.getElementById('event-detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEventDetailModal();
                }
            });
            
            // Admin schedule modal controls - Multi-step
            setupAdminScheduleModalHandlers();
        }
        
        // Global variable to store admin scheduling state
        let adminScheduleState = {
            clientName: '',
            clientPhone: '',
            packageSize: 0,
            selectedDates: [],
            scheduleCalendar: null
        };
        
        /**
         * Setup admin schedule modal event handlers
         */
        function setupAdminScheduleModalHandlers() {
            // Package selection buttons (fullpage version)
            document.querySelectorAll('.admin-package-btn-fullpage').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove selected class from all buttons
                    document.querySelectorAll('.admin-package-btn-fullpage').forEach(b => b.classList.remove('selected'));
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    // Store package size
                    document.getElementById('admin-schedule-package-fullpage').value = this.dataset.classes;
                });
            });
            
            // Back to admin panel button (fullpage version)
            const backBtn = document.getElementById('back-to-admin-panel');
            if (backBtn) {
                backBtn.addEventListener('click', showAdminPanel);
            }
            
            // Cancel button (fullpage step 1)
            const cancelStep1Fullpage = document.getElementById('admin-schedule-cancel-step1-fullpage');
            if (cancelStep1Fullpage) {
                cancelStep1Fullpage.addEventListener('click', showAdminPanel);
            }
            
            // Next button (step 1 to step 2) - fullpage
            const nextBtnFullpage = document.getElementById('admin-schedule-next-fullpage');
            if (nextBtnFullpage) {
                nextBtnFullpage.addEventListener('click', goToScheduleStep2);
            }
            
            // Back button (step 2 to step 1) - fullpage
            const backBtnFullpage = document.getElementById('admin-schedule-back-fullpage');
            if (backBtnFullpage) {
                backBtnFullpage.addEventListener('click', goToScheduleStep1);
            }
            
            // Confirm button (save all reservations) - fullpage
            const confirmBtnFullpage = document.getElementById('admin-schedule-confirm-fullpage');
            if (confirmBtnFullpage) {
                confirmBtnFullpage.addEventListener('click', confirmAdminSchedule);
            }
        }
        
        /**
         * Hide all main sections
         */
        function hideAllSections() {
            // Hide header and menu
            const header = document.querySelector('.site-header');
            if (header) header.style.display = 'none';
            
            const hamburger = document.getElementById('hamburger-container');
            if (hamburger) hamburger.style.display = 'none';
            
            // Hide all main page sections
            const sections = [
                'hero-section',
                'about-section', 
                'booking-section',
                'my-classes-section',
                'image-scroll-section',
                'admin-panel-section',
                'contact-section',
                'reglamento-link'
            ];
            
            sections.forEach(id => {
                const section = document.querySelector(`.${id}`) || document.getElementById(id);
                if (section) {
                    section.style.display = 'none';
                }
            });
        }

        /**
         * Show admin panel and hide scheduling section
         */
        function showAdminPanel() {
            // Hide scheduling section
            const schedulingSection = document.getElementById('admin-scheduling-section');
            if (schedulingSection) {
                schedulingSection.style.display = 'none';
            }
            
            // Show header and menu
            const header = document.querySelector('.site-header');
            if (header) header.style.display = 'block';
            
            const hamburger = document.getElementById('hamburger-container');
            if (hamburger) hamburger.style.display = 'flex';
            
            // Show admin panel
            const adminPanel = document.getElementById('admin-panel-section');
            if (adminPanel) {
                adminPanel.style.display = 'block';
                // Scroll to admin panel
                adminPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        /**
         * Open admin schedule modal (Step 1) - Now redirects to full-page section
         */
        function openAdminScheduleModal() {
            // Hide all other sections
            hideAllSections();
            
            // Show only the admin scheduling section
            const schedulingSection = document.getElementById('admin-scheduling-section');
            schedulingSection.style.display = 'block';
            
            // Reset state
            adminScheduleState = {
                clientName: '',
                clientPhone: '',
                packageSize: 0,
                selectedDates: [],
                scheduleCalendar: null
            };
            
            // Clear form
            document.getElementById('admin-schedule-name-fullpage').value = '';
            document.getElementById('admin-schedule-phone-fullpage').value = '';
            document.getElementById('admin-schedule-package-fullpage').value = '';
            document.querySelectorAll('.admin-package-btn-fullpage').forEach(btn => btn.classList.remove('selected'));
            
            // Show step 1, hide step 2
            document.getElementById('admin-schedule-step1-fullpage').style.display = 'block';
            document.getElementById('admin-schedule-step2-fullpage').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        /**
         * Go to step 2 (calendar selection) - Fullpage version
         */
        function goToScheduleStep2() {
            const name = document.getElementById('admin-schedule-name-fullpage').value.trim();
            const phone = document.getElementById('admin-schedule-phone-fullpage').value.trim();
            const packageSize = parseInt(document.getElementById('admin-schedule-package-fullpage').value);
            
            // Validate inputs
            if (!name) {
                alert('‚ö†Ô∏è Por favor ingresa el nombre del cliente');
                return;
            }
            
            if (!phone || !/^\d{10}$/.test(phone)) {
                alert('‚ö†Ô∏è Por favor ingresa un tel√©fono v√°lido de 10 d√≠gitos');
                return;
            }
            
            if (!packageSize || packageSize <= 0) {
                alert('‚ö†Ô∏è Por favor selecciona el n√∫mero de clases');
                return;
            }
            
            // Store state
            adminScheduleState.clientName = name;
            adminScheduleState.clientPhone = COUNTRY_CODE + phone; // Add country code
            adminScheduleState.packageSize = packageSize;
            adminScheduleState.selectedDates = [];
            
            // Update display
            document.getElementById('admin-schedule-client-name-display-fullpage').textContent = name;
            document.getElementById('admin-schedule-total-classes-fullpage').textContent = packageSize;
            document.getElementById('admin-schedule-selected-count-fullpage').textContent = '0';
            
            // Show step 2, hide step 1
            document.getElementById('admin-schedule-step1-fullpage').style.display = 'none';
            document.getElementById('admin-schedule-step2-fullpage').style.display = 'block';
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            // Initialize calendar for date/time selection
            initAdminScheduleCalendar();
        }
        
        /**
         * Go back to step 1 - Fullpage version
         */
        function goToScheduleStep1() {
            // Destroy calendar if it exists
            if (adminScheduleState.scheduleCalendar) {
                adminScheduleState.scheduleCalendar.destroy();
                adminScheduleState.scheduleCalendar = null;
            }
            
            // Show step 1, hide step 2
            document.getElementById('admin-schedule-step1-fullpage').style.display = 'block';
            document.getElementById('admin-schedule-step2-fullpage').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        /**
         * Convert a Date object to ISO format string preserving local timezone
         * @param {Date} date - Date object to convert
         * @returns {string} ISO formatted string (YYYY-MM-DDTHH:mm:ss) in local timezone
         * @throws {Error} If date is not a valid Date object
         */
        function dateToLocalISOString(date) {
            // Validate input
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                throw new Error('Invalid date: Expected a valid Date object');
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }
        
        /**
         * Initialize calendar for admin scheduling (step 2) - Fullpage version
         */
        function initAdminScheduleCalendar() {
            const calendarEl = document.getElementById('admin-schedule-calendar-fullpage');
            
            console.log('üé® Initializing admin schedule calendar...');
            console.log('üìä Reservations data available:', allReservationsData ? allReservationsData.length : 0);
            
            // Destroy existing calendar if any
            if (adminScheduleState.scheduleCalendar) {
                adminScheduleState.scheduleCalendar.destroy();
            }
            
            adminScheduleState.scheduleCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay'
                },
                dayHeaderFormat: {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'numeric'
                },
                slotMinTime: '06:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                expandRows: true,
                height: 'auto',
                nowIndicator: true,
                slotDuration: '01:00:00',
                slotLabelInterval: '01:00',
                selectable: true,
                selectMirror: true,
                selectOverlap: function(_event) {
                    // Always allow selection over existing events
                    // Capacity will be checked in handleAdminTimeSlotSelect
                    return true;
                },
                eventOverlap: true, // Also allow events to overlap each other
                buttonText: {
                    today: 'Hoy',
                    week: 'Semana',
                    day: 'D√≠a'
                },
                // Handle time slot selection
                select: function(info) {
                    console.log('üéØ Time slot selected:', info.start.toLocaleString('es-ES'));
                    handleAdminTimeSlotSelect(info);
                },
                // Load existing reservations to show occupied slots
                events: function(_info, successCallback, _failureCallback) {
                    const eventsCount = allReservationsData?.length || 0;
                    console.log('üìÖ Loading events for schedule calendar:', eventsCount);
                    
                    // Transform events to show only full capacity slots
                    const transformedEvents = (allReservationsData || []).reduce((acc, event) => {
                        let count = 1;
                        
                        // Calculate the number of people in this time slot
                        if (event.extendedProps && event.extendedProps.isGrouped && event.extendedProps.participants) {
                            count = event.extendedProps.participants.length;
                        }
                        
                        // Only show events when capacity is full (5/5)
                        if (count >= 5) {
                            acc.push({
                                ...event,
                                title: 'cupo lleno', // Show "cupo lleno" when full
                                textColor: '#d32f2f', // Red text for full capacity
                                backgroundColor: '#ffebee', // Light red background
                                borderColor: '#d32f2f'
                            });
                        }
                        // Don't add events with availability (< 5 people) to the result
                        
                        return acc;
                    }, [])
                    
                    successCallback(transformedEvents);
                },
                // Log when view is mounted
                viewDidMount: function(_info) {
                    // Use setTimeout(0) to defer logging until after event loop completes
                    // This ensures events are fully rendered before we query them
                    // Note: This is debug logging only and can be removed after testing
                    setTimeout(() => {
                        const events = adminScheduleState.scheduleCalendar?.getEvents() || [];
                        console.log('‚úÖ Calendar view mounted with events:', events.length);
                        if (events.length > 0) {
                            console.log('üìã Sample events:', events.slice(0, 3).map(e => ({
                                title: e.title,
                                start: e.start,
                                isGrouped: e.extendedProps?.isGrouped
                            })));
                        }
                    }, 0);
                }
            });
            
            adminScheduleState.scheduleCalendar.render();
        }
        
        /**
         * Handle time slot selection in admin schedule calendar
         */
        function handleAdminTimeSlotSelect(info) {
            // Check if max classes reached
            if (adminScheduleState.selectedDates.length >= adminScheduleState.packageSize) {
                alert(`‚ö†Ô∏è Ya has seleccionado ${adminScheduleState.packageSize} clases`);
                adminScheduleState.scheduleCalendar.unselect();
                return;
            }
            
            // Create datetime string in ISO format preserving local timezone
            const startDate = info.start;
            const dateTimeStr = dateToLocalISOString(startDate); // YYYY-MM-DDTHH:mm:ss in local timezone
            
            // Check if this slot is already selected
            const isAlreadySelected = adminScheduleState.selectedDates.some(d => d.datetime === dateTimeStr);
            if (isAlreadySelected) {
                alert('‚ö†Ô∏è Este horario ya est√° seleccionado');
                adminScheduleState.scheduleCalendar.unselect();
                return;
            }
            
            // Count existing reservations at this time slot
            let currentCount = 0;
            
            // Debug logging
            console.log('üîç Admin scheduling - time slot:', startDate.toLocaleString('es-ES'));
            console.log('üìä Total reservations in system:', allReservationsData ? allReservationsData.length : 0);
            
            // Count existing reservations at this time slot
            if (allReservationsData && allReservationsData.length > 0) {
                allReservationsData.forEach(event => {
                    if (event.start && event.start.getTime() === startDate.getTime()) {
                        console.log('‚úÖ Found existing reservation:', {
                            title: event.title,
                            isGrouped: event.extendedProps?.isGrouped,
                            participants: event.extendedProps?.participants?.length || 1
                        });
                        
                        // Check if it's a grouped event with multiple participants
                        if (event.extendedProps && event.extendedProps.isGrouped && event.extendedProps.participants) {
                            currentCount += event.extendedProps.participants.length;
                        } else {
                            currentCount++;
                        }
                    }
                });
            }
            
            console.log(`üìä Current occupancy: ${currentCount} person(s) at this time slot`);
            
            // Check capacity limit (5 people max per class)
            if (currentCount >= MAX_CAPACITY) {
                alert(`‚ö†Ô∏è Lo sentimos, este horario ya est√° completo.\n\nCapacidad m√°xima: ${MAX_CAPACITY} personas\nOcupaci√≥n actual: ${currentCount}/${MAX_CAPACITY}\n\nPor favor, selecciona otro horario disponible.`);
                adminScheduleState.scheduleCalendar.unselect();
                return;
            }
            
            // Add to selected dates
            adminScheduleState.selectedDates.push({
                datetime: dateTimeStr,
                start: startDate,
                displayText: startDate.toLocaleString('es-ES', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            });
            
            // Update UI
            updateAdminSelectedTimesList();
            
            // Add visual indicator to calendar
            adminScheduleState.scheduleCalendar.addEvent({
                start: startDate,
                end: new Date(startDate.getTime() + 60 * 60 * 1000),
                display: 'background',
                backgroundColor: 'rgba(239, 233, 225, 0.3)'
            });
            
            adminScheduleState.scheduleCalendar.unselect();
        }
        
        /**
         * Update selected times list display - Fullpage version
         */
        function updateAdminSelectedTimesList() {
            const container = document.getElementById('admin-selected-times-container-fullpage');
            const listEl = document.getElementById('admin-selected-times-list-fullpage');
            const countEl = document.getElementById('admin-schedule-selected-count-fullpage');
            
            if (adminScheduleState.selectedDates.length === 0) {
                container.style.display = 'none';
                countEl.textContent = '0';
                return;
            }
            
            container.style.display = 'block';
            countEl.textContent = adminScheduleState.selectedDates.length;
            
            listEl.innerHTML = '';
            adminScheduleState.selectedDates.forEach((dateInfo, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'admin-selected-time-item';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = dateInfo.displayText;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = '‚úï Quitar';
                removeBtn.dataset.index = index;
                removeBtn.addEventListener('click', function() {
                    removeAdminSelectedTime(parseInt(this.dataset.index));
                });
                
                itemEl.appendChild(textSpan);
                itemEl.appendChild(removeBtn);
                listEl.appendChild(itemEl);
            });
        }
        
        /**
         * Remove a selected time slot
         */
        function removeAdminSelectedTime(index) {
            adminScheduleState.selectedDates.splice(index, 1);
            
            // Refresh calendar to remove visual indicator
            if (adminScheduleState.scheduleCalendar) {
                // Reload calendar
                initAdminScheduleCalendar();
                
                // Re-add selected dates as background events
                adminScheduleState.selectedDates.forEach(dateInfo => {
                    adminScheduleState.scheduleCalendar.addEvent({
                        start: dateInfo.start,
                        end: new Date(dateInfo.start.getTime() + 60 * 60 * 1000),
                        display: 'background',
                        backgroundColor: 'rgba(239, 233, 225, 0.3)'
                    });
                });
            }
            
            updateAdminSelectedTimesList();
        }
        
        /**
         * Confirm and save all admin scheduled classes
         */
        async function confirmAdminSchedule() {
            if (adminScheduleState.selectedDates.length === 0) {
                alert('‚ö†Ô∏è Por favor selecciona al menos un horario');
                return;
            }
            
            if (adminScheduleState.selectedDates.length !== adminScheduleState.packageSize) {
                const confirmed = confirm(`‚ö†Ô∏è Has seleccionado ${adminScheduleState.selectedDates.length} de ${adminScheduleState.packageSize} clases.\n\n¬øDeseas continuar de todas formas?`);
                if (!confirmed) return;
            }
            
            // Get the fullpage confirm button
            const confirmBtn = document.getElementById('admin-schedule-confirm-fullpage');
            if (!confirmBtn) {
                console.error('‚ùå Confirm button not found');
                alert('‚ùå Error: No se encontr√≥ el bot√≥n de confirmaci√≥n. Por favor recarga la p√°gina.');
                return;
            }
            
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = '‚è≥ Guardando...';
            confirmBtn.disabled = true;
            
            try {
                console.log(`üìÖ Guardando ${adminScheduleState.selectedDates.length} clases para ${adminScheduleState.clientName}...`);
                
                let successCount = 0;
                let failCount = 0;
                
                // Save each reservation
                for (const dateInfo of adminScheduleState.selectedDates) {
                    try {
                        await window.saveReservationToFirestore(
                            adminScheduleState.clientName,
                            adminScheduleState.clientPhone,
                            dateInfo.datetime,
                            '' // No notes for admin scheduling
                        );
                        successCount++;
                    } catch (error) {
                        console.error('‚ùå Error al guardar reserva:', error);
                        failCount++;
                    }
                }
                
                // Show result
                if (failCount === 0) {
                    alert(`‚úÖ ${successCount} clases agendadas exitosamente para ${adminScheduleState.clientName}`);
                } else {
                    alert(`‚ö†Ô∏è ${successCount} clases guardadas, ${failCount} fallaron.\n\nPor favor, revisa el calendario.`);
                }
                
                // Return to admin panel
                showAdminPanel();
                
                // Reload admin calendar
                if (typeof loadAdminCalendarReservations === 'function') {
                    await loadAdminCalendarReservations();
                }
                
            } catch (error) {
                console.error('‚ùå Error al confirmar agendamiento:', error);
                alert('‚ùå Error al agendar las clases. Por favor, intente nuevamente.');
            } finally {
                // Restore button
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            }
        }
        
        /**
         * Close admin schedule modal
         */
        function closeAdminScheduleModal() {
            const modal = document.getElementById('admin-schedule-modal');
            
            // Destroy calendar if it exists
            if (adminScheduleState.scheduleCalendar) {
                adminScheduleState.scheduleCalendar.destroy();
                adminScheduleState.scheduleCalendar = null;
            }
            
            // Reset state
            adminScheduleState = {
                clientName: '',
                clientPhone: '',
                packageSize: 0,
                selectedDates: [],
                scheduleCalendar: null
            };
            
            // Reset form
            document.getElementById('admin-schedule-name').value = '';
            document.getElementById('admin-schedule-phone').value = '';
            document.getElementById('admin-schedule-package').value = '';
            document.querySelectorAll('.admin-package-btn').forEach(btn => btn.classList.remove('selected'));
            
            // Hide selected times list
            document.getElementById('admin-selected-times-container').style.display = 'none';
            document.getElementById('admin-selected-times-list').innerHTML = '';
            
            // Show step 1, hide step 2
            document.getElementById('admin-schedule-step1').style.display = 'block';
            document.getElementById('admin-schedule-step2').style.display = 'none';
            
            // Reset modal width to default by removing class
            const modalContent = document.getElementById('admin-schedule-modal-content');
            if (modalContent) {
                modalContent.classList.remove('step2-active');
            }
            
            // Hide modal and unlock body scroll
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        /**
         * Handle admin schedule form submission
         */
        
        /**
         * Apply filters to calendar
         */
        function applyFilters() {
            if (!adminCalendar || !allReservationsData) return;
            
            const searchText = document.getElementById('search-client').value.toLowerCase().trim();
            const dateStart = document.getElementById('filter-date-start').value;
            const dateEnd = document.getElementById('filter-date-end').value;
            
            // Normalize search text if it looks like a phone number (contains only digits)
            const normalizedSearchText = normalizePhoneNumber(searchText);
            
            // Clear current events
            adminCalendar.getEvents().forEach(event => event.remove());
            
            // Collect unique participants for mobile search results
            const searchResultsMap = new Map(); // Use Map to avoid duplicates (keyed by telefono)
            
            // Filter and re-add events
            const filteredEvents = allReservationsData.filter(event => {
                // Search filter
                if (searchText) {
                    let matchFound = false;
                    
                    // Check if grouped event
                    if (event.extendedProps.isGrouped && event.extendedProps.participants) {
                        // Search in all participants
                        event.extendedProps.participants.forEach(participant => {
                            const fullName = (participant.fullName || '').toLowerCase();
                            const telefono = (participant.telefono || '').toLowerCase();
                            const normalizedTelefono = normalizePhoneNumber(telefono);
                            
                            // Check if matches search
                            const isMatch = fullName.includes(searchText) || 
                                          telefono.includes(searchText) || 
                                          (normalizedSearchText && normalizedTelefono.includes(normalizedSearchText));
                            
                            if (isMatch) {
                                matchFound = true;
                                // Add to search results for mobile view
                                if (participant.telefono) {
                                    searchResultsMap.set(participant.telefono, {
                                        nombre: participant.fullName || 'Sin nombre',
                                        telefono: participant.telefono
                                    });
                                }
                            }
                        });
                    } else {
                        // Single event search
                        const fullName = (event.extendedProps.fullName || '').toLowerCase();
                        const telefono = (event.extendedProps.telefono || '').toLowerCase();
                        const normalizedTelefono = normalizePhoneNumber(telefono);
                        
                        // Search in name or phone
                        if (fullName.includes(searchText) || 
                            telefono.includes(searchText) || 
                            (normalizedSearchText && normalizedTelefono.includes(normalizedSearchText))) {
                            matchFound = true;
                            // Add to search results for mobile view
                            if (event.extendedProps.telefono) {
                                searchResultsMap.set(event.extendedProps.telefono, {
                                    nombre: event.extendedProps.fullName || 'Sin nombre',
                                    telefono: event.extendedProps.telefono
                                });
                            }
                        }
                    }
                    
                    if (!matchFound) {
                        return false;
                    }
                }
                
                // Date range filter
                if (dateStart) {
                    const startFilter = new Date(dateStart);
                    startFilter.setHours(0, 0, 0, 0);
                    if (event.start < startFilter) {
                        return false;
                    }
                }
                
                if (dateEnd) {
                    const endFilter = new Date(dateEnd);
                    endFilter.setHours(23, 59, 59, 999);
                    if (event.start > endFilter) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Add filtered events
            filteredEvents.forEach(event => {
                adminCalendar.addEvent(event);
            });
            
            // Display search results on mobile (width <= MOBILE_BREAKPOINT) when there's a search query
            const searchResultsContainer = document.getElementById('search-results-container');
            const searchResultsList = document.getElementById('search-results-list');
            
            if (searchText && window.innerWidth <= MOBILE_BREAKPOINT) {
                // Show search results container
                searchResultsContainer.style.display = 'block';
                
                // Clear existing results
                searchResultsList.innerHTML = '';
                
                // Convert Map to array and display results
                const participants = Array.from(searchResultsMap.values());
                
                if (participants.length === 0) {
                    searchResultsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No se encontraron participantes</p>';
                } else {
                    participants.forEach(participant => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        
                        // Escape HTML to prevent XSS
                        const escapedNombre = escapeHtml(participant.nombre);
                        const escapedTelefono = escapeHtml(participant.telefono);
                        
                        resultItem.innerHTML = `
                            <div class="participant-name">
                                <span>üë§</span>
                                <span>${escapedNombre}</span>
                            </div>
                            <div class="participant-phone">
                                <span>üì±</span>
                                <span>${escapedTelefono}</span>
                            </div>
                            <button class="contact-button" data-telefono="${escapedTelefono}" data-nombre="${escapedNombre}">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="flex-shrink: 0;">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" fill="currentColor"/>
                                </svg>
                                Contactar
                            </button>
                        `;
                        
                        // Add event listener for contact button
                        const contactButton = resultItem.querySelector('.contact-button');
                        contactButton.addEventListener('click', () => {
                            contactParticipant(participant.telefono, participant.nombre);
                        });
                        
                        searchResultsList.appendChild(resultItem);
                    });
                }
            } else {
                // Hide search results container when no search or on desktop
                searchResultsContainer.style.display = 'none';
            }
            
            console.log(`üîç Filtro aplicado: ${filteredEvents.length} de ${allReservationsData.length} eventos`);
        }
        
        /**
         * Escape HTML special characters to prevent XSS
         * @param {string} text - Text to escape
         * @returns {string} Escaped text safe for HTML insertion
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        /**
         * Clear all filters
         */
        function clearFilters() {
            document.getElementById('search-client').value = '';
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            applyFilters();
        }
        
        /**
         * Contact participant from search results
         * @param {string} telefono - Participant's phone number
         * @param {string} nombre - Participant's name
         */
        async function contactParticipant(telefono, nombre) {
            if (!telefono) {
                alert('‚ö†Ô∏è No hay tel√©fono disponible para este participante');
                return;
            }
            
            const normalizedPhone = normalizePhoneForWhatsApp(telefono);
            if (!normalizedPhone) {
                alert('‚ö†Ô∏è N√∫mero de tel√©fono inv√°lido.\n\nSe requiere un n√∫mero mexicano de 10 d√≠gitos.');
                return;
            }
            
            // Generate personalized message with client's schedule
            const mensajePersonalizado = await generateAdminToClientMessage(telefono, nombre || 'Cliente');
            
            if (!mensajePersonalizado) {
                // Fallback to generic message if generation fails
                const mensaje = encodeURIComponent(`¬°Hola ${nombre || 'Cliente'}!\n\nSomos AURA Studio. ¬øEn qu√© podemos ayudarte? üòä`);
                openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
                return;
            }
            
            const mensaje = encodeURIComponent(mensajePersonalizado);
            openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
        }
        
        // Expose contactParticipant globally for event handlers
        window.contactParticipant = contactParticipant;
        
        /**
         * Export calendar data to PDF with calendar format
         */
        async function exportCalendarData() {
            console.log('üîç Export button clicked');
            
            // Check if allReservationsData exists and has data
            if (!allReservationsData) {
                console.error('‚ùå allReservationsData is undefined');
                alert('‚ö†Ô∏è Error: Sistema de reservas no inicializado.\n\nPor favor, recarga la p√°gina.');
                return;
            }
            
            if (allReservationsData.length === 0) {
                console.warn('‚ö†Ô∏è No hay datos para exportar');
                alert('‚ö†Ô∏è No hay reservas para exportar.\n\nAgenda algunas clases primero.');
                return;
            }
            
            console.log(`üìä Exportando ${allReservationsData.length} eventos...`);
            
            try {
                // Prepare data for PDF generation
                const reservations = [];
                
                allReservationsData.forEach(event => {
                    // Validate event has required data
                    if (!event.start) {
                        console.warn('‚ö†Ô∏è Evento sin fecha:', event);
                        return;
                    }
                    
                    const date = event.start.toISOString().split('T')[0]; // YYYY-MM-DD format
                    const time = event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    
                    // Check if grouped event
                    if (event.extendedProps && event.extendedProps.isGrouped && event.extendedProps.participants) {
                        // Export each participant as a separate reservation
                        event.extendedProps.participants.forEach(participant => {
                            reservations.push({
                                date: date,
                                time: time,
                                name: participant.fullName || DEFAULT_NAME,
                                phone: participant.telefono || DEFAULT_PHONE,
                                notes: participant.notas || ''
                            });
                        });
                    } else {
                        // Single reservation
                        reservations.push({
                            date: date,
                            time: time,
                            name: (event.extendedProps && event.extendedProps.fullName) || event.title || DEFAULT_NAME,
                            phone: (event.extendedProps && event.extendedProps.telefono) || DEFAULT_PHONE,
                            notes: (event.extendedProps && event.extendedProps.notas) || ''
                        });
                    }
                });
                
                if (reservations.length === 0) {
                    console.warn('‚ö†Ô∏è No se pudieron procesar las reservas');
                    alert('‚ö†Ô∏è No hay datos v√°lidos para exportar.\n\nVerifica que las reservas tengan fecha y hora.');
                    return;
                }
                
                console.log(`üìã ${reservations.length} reservas procesadas para exportaci√≥n`);
                
                // Show loading indicator
                const btnExport = document.getElementById('btn-export-calendar');
                if (!btnExport) {
                    console.error('‚ùå Bot√≥n de exportar no encontrado');
                    alert('‚ö†Ô∏è Error: Bot√≥n de exportar no encontrado.\n\nPor favor, recarga la p√°gina.');
                    return;
                }
                
                const originalText = btnExport.textContent;
                btnExport.textContent = '‚è≥ Generando PDF...';
                btnExport.disabled = true;
                
                // Send data to API endpoint
                console.log('üîó Enviando datos al servidor...');
                const response = await fetch('/api/exportar-calendario', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reservations: reservations })
                });
                
                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                // Check if response is ok
                if (!response.ok) {
                    // Try to parse error message
                    let errorMsg = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        // Response is not JSON
                    }
                    throw new Error(`Error HTTP: ${response.status} - ${errorMsg}`);
                }
                
                // For PDF response, create blob and download
                const blob = await response.blob();
                console.log('üìÑ PDF generado, tama√±o:', blob.size);
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Get filename from response header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'calendario_reservas_aura.pdf';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=\s*["']?([^"';\n]+)["']?/i);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1];
                    }
                }
                
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up blob URL
                window.URL.revokeObjectURL(url);
                
                console.log(`‚úÖ Calendario exportado: ${filename}`);
                alert(`‚úÖ Calendario exportado exitosamente\n\nArchivo: ${filename}`);
                
                // Restore button
                btnExport.textContent = originalText;
                btnExport.disabled = false;
                
            } catch (error) {
                console.error('‚ùå Error al exportar calendario:', error);
                console.error('Detalles:', error.message, error.stack);
                
                // Determine error type
                let errorMessage = 'Error al exportar el calendario.';
                let errorDetails = 'Por favor, intente nuevamente.';
                
                if (error.message.includes('fetch')) {
                    errorDetails = 'Error de red. Verifica tu conexi√≥n a internet.';
                } else if (error.message.includes('HTTP')) {
                    errorDetails = 'Error del servidor. Contacta al administrador.';
                } else if (error.message.includes('JSON')) {
                    errorDetails = 'Error al procesar respuesta del servidor.';
                }
                
                alert(`‚ùå ${errorMessage}\n\n${errorDetails}\n\nDetalles t√©cnicos: ${error.message}`);
                
                // Restore button
                const btnExport = document.getElementById('btn-export-calendar');
                if (btnExport) {
                    btnExport.textContent = 'üì• Exportar';
                    btnExport.disabled = false;
                }
            }
        }
        
        /**
         * Export availability data to PDF showing 2-month schedule
         * Shows morning (6:00-11:00) and afternoon (17:00-20:00) slots
         * with available spots for each time slot
         */
        async function exportAvailabilityData() {
            console.log('üìä Export availability button clicked');
            
            // Button text constants
            const BUTTON_TEXT_NORMAL = 'üìä Exportar Disponibilidad';
            const BUTTON_TEXT_LOADING = '‚è≥ Generando PDF...';
            
            try {
                // Calculate date range (2 months from today)
                const today = new Date();
                const endDate = new Date(today);
                endDate.setMonth(endDate.getMonth() + 2);
                
                console.log(`üìÖ Generando disponibilidad desde ${today.toISOString().split('T')[0]} hasta ${endDate.toISOString().split('T')[0]}`);
                
                // Wait for Firebase to be ready
                if (!window.firebaseReady || !window.db || !window.firestoreExports) {
                    console.error('‚ùå Firebase no est√° listo');
                    alert('‚ö†Ô∏è Error: Sistema de reservas no inicializado.\n\nPor favor, recarga la p√°gina.');
                    return;
                }
                
                // Show loading indicator
                const btnExport = document.getElementById('btn-export-availability');
                if (!btnExport) {
                    console.error('‚ùå Bot√≥n de exportar disponibilidad no encontrado');
                    alert('‚ö†Ô∏è Error: Bot√≥n no encontrado.\n\nPor favor, recarga la p√°gina.');
                    return;
                }
                
                btnExport.textContent = BUTTON_TEXT_LOADING;
                btnExport.disabled = true;
                
                // Get all reservations from Firestore
                const { query, collection, getDocs, where } = window.firestoreExports;
                const db = window.db;
                
                // Query reservations in the date range
                const startDateStr = today.toISOString().split('T')[0] + 'T00:00:00';
                const endDateStr = endDate.toISOString().split('T')[0] + 'T23:59:59';
                
                console.log('üîç Consultando reservas en Firestore...');
                const q = query(
                    collection(db, 'reservas'),
                    where('fechaHora', '>=', startDateStr),
                    where('fechaHora', '<=', endDateStr)
                );
                
                const querySnapshot = await getDocs(q);
                const allReservations = [];
                querySnapshot.forEach((doc) => {
                    allReservations.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`üìö ${allReservations.length} reservas encontradas`);
                
                // Business hours configuration
                const businessHours = {
                    morning: [6, 7, 8, 9, 10], // 6:00 AM to 11:00 AM (last class at 10:00 AM)
                    afternoon: [17, 18, 19] // 5:00 PM to 8:00 PM (last class at 7:00 PM)
                };
                const maxCapacity = 5;
                const daysOfWeek = [1, 2, 3, 4, 5, 6]; // Monday to Saturday (0 = Sunday, 1 = Monday, etc.)
                
                // Generate availability data for each day
                const availabilityData = [];
                const currentDate = new Date(today);
                
                while (currentDate <= endDate) {
                    const dayOfWeek = currentDate.getDay();
                    
                    // Skip Sundays
                    if (dayOfWeek === 0) {
                        currentDate.setDate(currentDate.getDate() + 1);
                        continue;
                    }
                    
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayData = {
                        date: dateStr,
                        dayName: currentDate.toLocaleDateString('es-ES', { weekday: 'short' }),
                        dayNumber: currentDate.getDate(),
                        monthName: currentDate.toLocaleDateString('es-ES', { month: 'short' }),
                        morning: [],
                        afternoon: []
                    };
                    
                    // Process morning slots
                    businessHours.morning.forEach(hour => {
                        const timeSlot = `${String(hour).padStart(2, '0')}:00:00`;
                        const dateTimeStr = `${dateStr}T${timeSlot}`;
                        
                        // Count reservations for this time slot
                        const reservationsCount = allReservations.filter(r => r.fechaHora === dateTimeStr).length;
                        const available = maxCapacity - reservationsCount;
                        
                        dayData.morning.push({
                            hour: hour,
                            time: `${hour}:00`,
                            available: available,
                            isFull: available === 0
                        });
                    });
                    
                    // Process afternoon slots
                    businessHours.afternoon.forEach(hour => {
                        const timeSlot = `${String(hour).padStart(2, '0')}:00:00`;
                        const dateTimeStr = `${dateStr}T${timeSlot}`;
                        
                        // Count reservations for this time slot
                        const reservationsCount = allReservations.filter(r => r.fechaHora === dateTimeStr).length;
                        const available = maxCapacity - reservationsCount;
                        
                        dayData.afternoon.push({
                            hour: hour,
                            time: `${hour}:00`,
                            available: available,
                            isFull: available === 0
                        });
                    });
                    
                    availabilityData.push(dayData);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                console.log(`üìã ${availabilityData.length} d√≠as de disponibilidad generados`);
                
                // Prepare data for API
                const exportData = {
                    startDate: today.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0],
                    availability: availabilityData,
                    maxCapacity: maxCapacity
                };
                
                // Send data to API endpoint
                console.log('üîó Enviando datos al servidor...');
                const response = await fetch('/api/exportar-disponibilidad', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exportData)
                });
                
                console.log('üì° Respuesta del servidor:', response.status, response.statusText);
                
                // Check if response is ok
                if (!response.ok) {
                    // Try to parse error message
                    let errorMsg = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        // Response is not JSON
                    }
                    throw new Error(`Error HTTP: ${response.status} - ${errorMsg}`);
                }
                
                // For PDF response, create blob and download
                const blob = await response.blob();
                console.log('üìÑ PDF generado, tama√±o:', blob.size);
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Disponibilidad.pdf';
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up blob URL
                window.URL.revokeObjectURL(url);
                
                console.log('‚úÖ Disponibilidad exportada: Disponibilidad.pdf');
                alert('‚úÖ Disponibilidad exportada exitosamente\n\nArchivo: Disponibilidad.pdf');
                
                // Restore button
                btnExport.textContent = BUTTON_TEXT_NORMAL;
                btnExport.disabled = false;
                
            } catch (error) {
                console.error('‚ùå Error al exportar disponibilidad:', error);
                console.error('Detalles:', error.message, error.stack);
                
                // Determine error type
                let errorMessage = 'Error al exportar disponibilidad.';
                let errorDetails = 'Por favor, intente nuevamente.';
                
                if (error.message.includes('fetch')) {
                    errorDetails = 'Error de red. Verifica tu conexi√≥n a internet.';
                } else if (error.message.includes('HTTP')) {
                    errorDetails = 'Error del servidor. Contacta al administrador.';
                } else if (error.message.includes('Firebase')) {
                    errorDetails = 'Error al conectar con la base de datos.';
                }
                
                alert(`‚ùå ${errorMessage}\n\n${errorDetails}\n\nDetalles t√©cnicos: ${error.message}`);
                
                // Restore button
                const btnExport = document.getElementById('btn-export-availability');
                if (btnExport) {
                    btnExport.textContent = BUTTON_TEXT_NORMAL;
                    btnExport.disabled = false;
                }
            }
        }
        
        /**
         * Show event detail modal
         */
        function showEventDetailModal(event) {
            const props = event.extendedProps;
            
            // Format date and time (common for both single and grouped)
            const date = event.start.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('detail-date').textContent = date;
            
            const startTime = event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const endTime = event.end ? event.end.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
            document.getElementById('detail-time').textContent = endTime ? `${startTime} - ${endTime}` : startTime;
            
            // Check if this is a grouped event
            if (props.isGrouped && props.participants && props.participants.length > 0) {
                // Handle grouped event - show all participants
                const modalHeader = document.querySelector('.event-detail-header h3');
                modalHeader.textContent = `üë• Detalle de Reserva - ${props.count} Personas`;
                
                // Create participant list HTML
                let participantsHTML = '<div class="participants-list">';
                props.participants.forEach((participant, index) => {
                    // Escape data for HTML attributes
                    const escapedTelefono = (participant.telefono || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const escapedNombre = (participant.fullName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const escapedFirebaseId = (participant.firebaseId || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    participantsHTML += `
                        <div class="participant-item" style="padding: 10px; margin-bottom: 10px; border-left: 3px solid #EFE9E1; background-color: #EFE9E1; border-radius: 5px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                <span style="color: #EFE9E1; margin-right: 5px;">üë§</span>${participant.fullName || '-'}
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 3px;">
                                <span style="color: #EFE9E1; margin-right: 5px;">üì±</span>${participant.telefono || '-'}
                            </div>
                            ${participant.notas && participant.notas.trim() ? `
                                <div style="font-size: 13px; color: #777; font-style: italic;">
                                    <span style="color: #EFE9E1; margin-right: 5px;">üìù</span>${participant.notas}
                                </div>
                            ` : ''}
                            <div class="participant-buttons">
                                <button type="button" class="btn-participant-contact" data-telefono="${escapedTelefono}" data-nombre="${escapedNombre}">
                                    üì± Contactar
                                </button>
                                <button type="button" class="btn-participant-edit" data-telefono="${escapedTelefono}" data-nombre="${escapedNombre}" data-firebase-id="${escapedFirebaseId}">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        </div>
                    `;
                });
                participantsHTML += '</div>';
                
                // Replace client name/email section with participants list
                document.getElementById('detail-client-name').innerHTML = participantsHTML;
                document.getElementById('detail-client-email').style.display = 'none';
                document.querySelector('.event-detail-row:has(#detail-client-email)').style.display = 'none';
                
                // Hide single client row, show only participants
                const clientRow = document.querySelector('.event-detail-row:has(#detail-client-name)');
                clientRow.querySelector('.event-detail-icon').style.display = 'none';
                clientRow.querySelector('.event-detail-label').textContent = 'Participantes';
                
                // Hide notes row for grouped events (notes shown per participant)
                document.getElementById('detail-notes-row').style.display = 'none';
                
                // Hide contact button and edit button for grouped events
                document.getElementById('detail-contact-btn').style.display = 'none';
                document.getElementById('detail-whatsapp-btn').style.display = 'none';
                document.getElementById('detail-edit-btn').style.display = 'none';
                window.currentEventEmail = null;
                window.currentEventTelefono = null;
                window.currentEventNombre = null;
                window.currentEvent = null;
            } else {
                // Handle single event - show one client
                const modalHeader = document.querySelector('.event-detail-header h3');
                modalHeader.textContent = 'üë§ Detalle de Reserva';
                
                // Show client name and telefono normally
                document.getElementById('detail-client-name').textContent = props.fullName || event.title;
                document.getElementById('detail-client-email').textContent = props.telefono || '-';
                document.getElementById('detail-client-email').style.display = 'block';
                document.querySelector('.event-detail-row:has(#detail-client-email)').style.display = 'flex';
                
                // Restore client row styling
                const clientRow = document.querySelector('.event-detail-row:has(#detail-client-name)');
                clientRow.querySelector('.event-detail-icon').style.display = 'flex';
                clientRow.querySelector('.event-detail-label').textContent = 'Cliente';
                
                // Notes (optional)
                const notesRow = document.getElementById('detail-notes-row');
                if (props.notas && props.notas.trim()) {
                    document.getElementById('detail-notes').textContent = props.notas;
                    notesRow.style.display = 'flex';
                } else {
                    notesRow.style.display = 'none';
                }
                
                // Show contact button, edit button, and store event data
                document.getElementById('detail-contact-btn').style.display = 'inline-block';
                document.getElementById('detail-whatsapp-btn').style.display = 'inline-block';
                document.getElementById('detail-edit-btn').style.display = 'inline-block';
                window.currentEventTelefono = props.telefono;
                window.currentEventNombre = props.fullName || event.title;
                window.currentEvent = event;
            }
            
            // Show modal and lock body scroll
            document.getElementById('event-detail-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }
        
        /**
         * Close event detail modal
         */
        function closeEventDetailModal() {
            document.getElementById('event-detail-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        /**
         * Open edit reservation modal
         */
        function openEditReservationModal() {
            // Get the current event from global variable
            if (!window.currentEvent) {
                alert('‚ùå No se encontr√≥ informaci√≥n del evento para editar');
                return;
            }
            
            const event = window.currentEvent;
            const props = event.extendedProps;
            
            // Set client name
            document.getElementById('edit-client-name').textContent = props.fullName || event.title;
            
            // Set current date in date picker (format: YYYY-MM-DD)
            const startDate = event.start;
            const year = startDate.getFullYear();
            const month = String(startDate.getMonth() + 1).padStart(2, '0');
            const day = String(startDate.getDate()).padStart(2, '0');
            document.getElementById('edit-reservation-date').value = `${year}-${month}-${day}`;
            
            // Set current time in time picker (format: HH:MM)
            const hours = String(startDate.getHours()).padStart(2, '0');
            const minutes = String(startDate.getMinutes()).padStart(2, '0');
            document.getElementById('edit-reservation-time').value = `${hours}:${minutes}`;
            
            // Close detail modal and open edit modal
            closeEventDetailModal();
            document.getElementById('edit-reservation-modal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }
        
        /**
         * Close edit reservation modal
         */
        function closeEditReservationModal() {
            document.getElementById('edit-reservation-modal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        /**
         * Save edited reservation
         */
        async function saveEditedReservation() {
            // Store original button text for restoration
            const saveBtn = document.getElementById('edit-reservation-save');
            const originalText = saveBtn.textContent;
            
            try {
                // Get form values
                const newDate = document.getElementById('edit-reservation-date').value;
                const newTime = document.getElementById('edit-reservation-time').value;
                
                // Validate inputs
                if (!newDate || !newTime) {
                    alert('‚ö†Ô∏è Por favor selecciona una fecha y hora');
                    return;
                }
                
                if (!window.currentEvent || !window.currentEvent.extendedProps.firebaseId) {
                    alert('‚ùå No se encontr√≥ el ID del evento para actualizar');
                    return;
                }
                
                // Combine date and time into ISO format (YYYY-MM-DDTHH:mm:ss)
                const newDateTime = `${newDate}T${newTime}:00`;
                
                // Validate that the new date is not in the past
                // Create date objects and reset to midnight for fair comparison
                const newDateObj = new Date(newDateTime);
                const now = new Date();
                
                // Compare timestamps
                if (newDateObj.getTime() < now.getTime()) {
                    alert('‚ö†Ô∏è No puedes mover una reserva a una fecha pasada');
                    return;
                }
                
                // Show loading state
                saveBtn.textContent = '‚è≥ Guardando...';
                saveBtn.disabled = true;
                
                // Update in Firestore
                const firebaseId = window.currentEvent.extendedProps.firebaseId;
                const docRef = doc(db, 'reservas', firebaseId);
                
                await updateDoc(docRef, {
                    fechaHora: newDateTime
                });
                
                console.log('‚úÖ Reserva actualizada exitosamente:', firebaseId);
                
                // Close modal
                closeEditReservationModal();
                
                // Reload calendar to show updated reservation
                await loadAdminCalendarReservations();
                
                // Show success message
                alert('‚úÖ Reserva actualizada exitosamente');
                
                // Reset button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                
            } catch (error) {
                console.error('‚ùå Error al actualizar reserva:', error);
                alert('‚ùå Error al actualizar la reserva. Por favor, intenta nuevamente.');
                
                // Reset button state using stored original text
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        /**
         * Delete a reservation
         */
        async function deleteReservation() {
            // Show confirmation dialog
            const confirmDelete = confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar esta clase? Esta acci√≥n no se puede deshacer.');
            
            if (!confirmDelete) {
                return;
            }
            
            // Store original button text for restoration
            const deleteBtn = document.getElementById('edit-reservation-delete');
            const originalText = deleteBtn.textContent;
            
            try {
                // Validate event exists
                if (!window.currentEvent?.extendedProps?.firebaseId) {
                    alert('‚ùå No se encontr√≥ el ID del evento para eliminar');
                    return;
                }
                
                // Show loading state
                deleteBtn.textContent = '‚è≥ Eliminando...';
                deleteBtn.disabled = true;
                
                // Delete from Firestore
                const firebaseId = window.currentEvent.extendedProps.firebaseId;
                const docRef = doc(db, 'reservas', firebaseId);
                
                await deleteDoc(docRef);
                
                console.log('‚úÖ Reserva eliminada exitosamente:', firebaseId);
                
                // Close modal
                closeEditReservationModal();
                
                // Reload calendar to show updated schedule (this will free up the slot)
                await loadAdminCalendarReservations();
                
                // Show success message
                alert('‚úÖ Clase eliminada exitosamente. El espacio ahora est√° disponible para otras personas.');
                
            } catch (error) {
                console.error('‚ùå Error al eliminar reserva:', error);
                alert('‚ùå Error al eliminar la clase. Por favor, intenta nuevamente.');
            } finally {
                // Reset button state
                deleteBtn.textContent = originalText;
                deleteBtn.disabled = false;
            }
        }
        
        /**
         * Normalize phone number for WhatsApp (always 12 digits: 52 + 10 digits)
         * @param {string} telefono - Phone number to normalize (expected: Mexican 10-digit number)
         * @returns {string} Normalized phone number with exactly 12 digits, or empty string if invalid
         */
        function normalizePhoneForWhatsApp(telefono) {
            if (!telefono) return '';
            
            // Remove all non-numeric characters
            let cleaned = telefono.replace(/\D/g, '');
            
            // If the number has 12 digits and starts with 52, assume it's already formatted
            // Otherwise, if it starts with 52 but doesn't have 12 digits, remove the 52
            if (cleaned.startsWith('52')) {
                if (cleaned.length === 12) {
                    // Already properly formatted (52 + 10 digits)
                    return cleaned;
                } else {
                    // Remove the 52 prefix to extract the base number
                    cleaned = cleaned.substring(2);
                }
            }
            
            // Validate that we have exactly 10 digits (Mexican phone number)
            if (cleaned.length !== 10) {
                console.warn('‚ö†Ô∏è Invalid phone number: expected 10-digit Mexican phone number');
                return '';
            }
            
            // Add 52 at the beginning
            return '52' + cleaned;
        }
        
        /**
         * Generate personalized admin-to-client message with their reservations
         * @param {string} userTelefono - User's phone number
         * @param {string} userName - User's name
         * @returns {Promise<string|null>} Personalized message with reservations, generic greeting if no reservations, or null on error
         */
        async function generateAdminToClientMessage(userTelefono, userName) {
            try {
                console.log(`üì± Generando mensaje personalizado para: ${userName} (${userTelefono})`);
                
                // Wait for Firebase to be ready
                if (!window.firebaseReady || !window.db || !window.firestoreExports) {
                    console.error('‚ùå Firebase no est√° listo');
                    return null;
                }
                
                // Get Firestore functions from global exports
                const { query, collection, getDocs } = window.firestoreExports;
                const db = window.db;
                
                // Normalize telefono
                const userTelefonoTrimmed = userTelefono.trim();
                
                // Query all reservations without filtering (consistent approach)
                // Then filter client-side by telefono
                const q = query(collection(db, 'reservas'));
                const querySnapshot = await getDocs(q);
                
                // Collect reservations and filter by telefono client-side
                const userReservations = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use flexible phone matching to handle format variations
                    if (data.telefono && phonesMatch(data.telefono, userTelefonoTrimmed)) {
                        userReservations.push({ id: doc.id, ...data });
                    }
                });
                
                console.log(`üìö Encontradas ${userReservations.length} reservas para el usuario`);
                
                if (userReservations.length === 0) {
                    // If no reservations, return a generic greeting
                    return `¬°Hola ${userName}!\n\nSomos AURA Studio. ¬øEn qu√© podemos ayudarte? üòä`;
                }
                
                // Sort by date (upcoming first)
                userReservations.sort((a, b) => {
                    const dateA = parseFechaHora(a.fechaHora);
                    const dateB = parseFechaHora(b.fechaHora);
                    return dateA - dateB;
                });
                
                // Build the personalized message
                let mensaje = `¬°Hola ${userName}!\n\n`;
                mensaje += `Somos AURA Studio. Gracias por agendar con nosotros.\n\n`;
                mensaje += `Aqu√≠ est√° tu rol de clases:\n\n`;
                
                // Add each class with formatted date
                userReservations.forEach((reserva) => {
                    const fechaFormateada = formatDateToSpanish(reserva.fechaHora);
                    mensaje += `‚Ä¢ ${fechaFormateada}\n`;
                });
                
                mensaje += `\n¬øHay algo en lo que podamos ayudarte? üòä`;
                
                return mensaje;
            } catch (error) {
                console.error('‚ùå Error al generar mensaje personalizado:', error);
                console.error('Error details:', error.message, error.stack);
                return null;
            }
        }
        
        /**
         * Contact client via WhatsApp
         */
        async function contactClient() {
            const telefono = window.currentEventTelefono;
            const nombre = window.currentEventNombre;
            
            if (!telefono) {
                alert('‚ö†Ô∏è No hay tel√©fono disponible para este cliente');
                return;
            }
            
            const normalizedPhone = normalizePhoneForWhatsApp(telefono);
            if (!normalizedPhone) {
                alert('‚ö†Ô∏è N√∫mero de tel√©fono inv√°lido.\n\nSe requiere un n√∫mero mexicano de 10 d√≠gitos.');
                return;
            }
            
            // Generate personalized message with client's schedule
            const mensajePersonalizado = await generateAdminToClientMessage(telefono, nombre || 'Cliente');
            
            if (!mensajePersonalizado) {
                // Fallback to generic message if generation fails
                const mensaje = encodeURIComponent(`¬°Hola ${nombre || 'Cliente'}!\n\nSomos AURA Studio. ¬øEn qu√© podemos ayudarte? üòä`);
                openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
                return;
            }
            
            const mensaje = encodeURIComponent(mensajePersonalizado);
            openWhatsAppLink(`https://wa.me/${normalizedPhone}?text=${mensaje}`);
        }

        /**
         * Send class schedule to client via WhatsApp from admin panel
         * This function fetches all the client's reservations and sends them via WhatsApp
         */
        async function sendClassScheduleToClient() {
            const telefono = window.currentEventTelefono;
            const nombre = window.currentEventNombre;
            
            if (!telefono || !nombre) {
                showCustomAlert('‚ö†Ô∏è No hay informaci√≥n del cliente disponible', 'warning', 'Atenci√≥n');
                return;
            }
            
            console.log('üì± Enviando clases al cliente desde admin panel:', nombre);
            
            try {
                // Use the existing sendWhatsAppMessage function which already handles everything
                const success = await sendWhatsAppMessage(telefono, nombre);
                
                if (success) {
                    console.log('‚úÖ Mensaje de WhatsApp enviado exitosamente');
                }
            } catch (error) {
                console.error('‚ùå Error al enviar clases por WhatsApp:', error);
                showCustomAlert('Error al enviar clases por WhatsApp. Por favor, intenta nuevamente.', 'error', 'Error');
            }
        }

        // ========== MY CLASSES FUNCTIONALITY ==========
        
        /**
         * Load user's classes from Firestore
         * This function loads only the reservations for the currently logged-in user
         * SISTEMA SUPER SIMPLE: Filtrar por tel√©fono en vez de email
         */
        async function loadUserClasses(userTelefono) {
            const myClassesSection = document.getElementById('my-classes-section');
            const greetingEl = document.getElementById('my-classes-greeting');
            const loadingDiv = document.getElementById('my-classes-loading');
            const emptyDiv = document.getElementById('my-classes-empty');
            const gridDiv = document.getElementById('my-classes-grid');

            myClassesSection.style.display = 'block';
            loadingDiv.style.display = 'block';
            emptyDiv.style.display = 'none';
            gridDiv.innerHTML = '';
            
            // Set greeting with user's name
            const userName = currentUser?.nombre || localStorage.getItem('userNombre') || '';
            if (userName) {
                greetingEl.textContent = `Hola ${userName}`;
            } else {
                greetingEl.textContent = 'Mis Clases';
            }

            try {
                console.log(`Cargando clases para tel√©fono: ${userTelefono}`);

                // Normalize telefono - trim spaces
                const userTelefonoTrimmed = userTelefono.trim();

                // Query Firestore without filtering to avoid permission issues
                const q = query(collection(db, 'reservas'));

                const querySnapshot = await getDocs(q);
                const userReservations = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use phonesMatch for flexible phone number comparison
                    if (data.telefono && phonesMatch(data.telefono, userTelefonoTrimmed)) {
                        userReservations.push({ id: doc.id, ...data });
                    }
                });

                console.log(`Encontradas ${userReservations.length} clases`);

                loadingDiv.style.display = 'none';

                if (userReservations.length === 0) {
                    emptyDiv.style.display = 'block';
                } else {
                    displayUserClasses(userReservations);
                }

            } catch (error) {
                console.error('Error al cargar clases del usuario:', error);
                console.error('Detalles del error:', error.message);
                loadingDiv.style.display = 'none';
                
                // Provide more helpful error message based on error type
                let errorMessage = 'Error al cargar tus clases';
                let errorDetails = 'Intenta recargar la p√°gina';
                
                if (error.code === 'permission-denied') {
                    errorDetails = 'Verifica tu conexi√≥n y vuelve a iniciar sesi√≥n';
                } else if (error.message && error.message.includes('index')) {
                    errorDetails = 'Se est√° configurando la base de datos. Intenta nuevamente en unos minutos.';
                }
                
                gridDiv.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#EFE9E1;grid-column:1/-1">
                        <p style="font-size:1.2rem">${errorMessage}</p>
                        <p style="margin-top:10px;color:#999">${errorDetails}</p>
                    </div>`;
            }
        }
        
        // Expose loadUserClasses to window object for accessibility
        window.loadUserClasses = loadUserClasses;
        
        /**
         * Display user's classes in the grid
         */
        function displayUserClasses(reservations) {
            const gridDiv = document.getElementById('my-classes-grid');
            gridDiv.innerHTML = '';
            
            const now = new Date();
            
            // Sort by date (upcoming first)
            reservations.sort((a, b) => {
                const dateA = parseFechaHora(a.fechaHora);
                const dateB = parseFechaHora(b.fechaHora);
                return dateA - dateB;
            });
            
            reservations.forEach((reservation, index) => {
                const classDate = parseFechaHora(reservation.fechaHora);
                
                if (!classDate) {
                    console.warn('Formato de fecha inv√°lido:', reservation.fechaHora);
                    return;
                }
                
                // Determine if class is upcoming or past
                const isUpcoming = classDate >= now;
                
                // Format date and time
                const dateStr = classDate.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const timeStr = classDate.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Create class card
                const classCard = document.createElement('div');
                classCard.className = 'class-card';
                classCard.style.animationDelay = `${index * 0.1}s`;
                
                classCard.innerHTML = `
                    <div class="class-card-date">
                        <span class="class-card-date-icon">üìÖ</span>
                        <span>${dateStr}</span>
                    </div>
                    <div class="class-card-time">
                        <span class="class-card-time-icon">üïê</span>
                        <span>${timeStr}</span>
                    </div>
                    ${reservation.notas ? `
                        <div class="class-card-info">
                            <strong>üìù Notas:</strong> ${reservation.notas}
                        </div>
                    ` : ''}
                    <div class="class-card-status ${isUpcoming ? 'upcoming' : 'past'}">
                        ${isUpcoming ? '‚ú® Pr√≥xima clase' : '‚úì Clase completada'}
                    </div>
                `;
                
                gridDiv.appendChild(classCard);
            });
            
            // Show WhatsApp button if user has classes
            if (reservations.length > 0) {
                const whatsappContainer = document.getElementById('my-classes-whatsapp');
                if (whatsappContainer) {
                    const userName = currentUser?.nombre || localStorage.getItem('userNombre') || '';
                    const userTelefono = currentUser?.telefono || localStorage.getItem('userTelefono') || '';
                    
                    if (userName && userTelefono) {
                        whatsappContainer.innerHTML = '';
                        const whatsappBtn = createWhatsAppButton(userTelefono, userName);
                        whatsappContainer.appendChild(whatsappBtn);
                        whatsappContainer.style.display = 'block';
                    }
                }
            }
        }
        
        /**
         * Hide My Classes section
         */
        function hideUserClasses() {
            const myClassesSection = document.getElementById('my-classes-section');
            const greetingEl = document.getElementById('my-classes-greeting');
            myClassesSection.style.display = 'none';
            // Reset greeting to default
            greetingEl.textContent = 'Mis Clases';
        }

        // ========== WHATSAPP BUTTON FUNCTIONALITY ==========
        
        /**
         * Format date and time in Spanish readable format
         * @param {string} fechaHora - ISO date string (YYYY-MM-DDTHH:mm:ss)
         * @returns {string} Formatted date in Spanish (e.g., "Lunes 15 dic a las 10:00 am")
         */
        function formatDateToSpanish(fechaHora) {
            try {
                const date = parseFechaHora(fechaHora);
                if (!date) {
                    return 'Fecha inv√°lida';
                }
                
                const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const mesesCortos = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
                
                const diaSemana = diasSemana[date.getDay()];
                const dia = date.getDate();
                const mes = mesesCortos[date.getMonth()];
                const hora = date.getHours();
                const minutos = date.getMinutes().toString().padStart(2, '0');
                const periodo = hora >= 12 ? 'pm' : 'am';
                const hora12 = hora === 0 ? 12 : (hora > 12 ? hora - 12 : hora);
                
                return `${diaSemana} ${dia} ${mes} a las ${hora12}:${minutos} ${periodo}`;
            } catch (error) {
                console.error('Error al formatear fecha:', error);
                return 'Fecha inv√°lida';
            }
        }
        
        /**
         * Fetch user reservations from Firebase and generate WhatsApp message
         * @param {string} userTelefono - User's phone number
         * @param {string} userName - User's name
         * @returns {Promise<string>} WhatsApp message or null if error
         */
        async function generateWhatsAppMessage(userTelefono, userName) {
            try {
                console.log(`üì± Generando mensaje de WhatsApp para: ${userName} (${userTelefono})`);
                
                // Wait for Firebase to be ready
                if (!window.firebaseReady || !window.db || !window.firestoreExports) {
                    console.error('‚ùå Firebase no est√° listo');
                    return null;
                }
                
                // Get Firestore functions from global exports
                const { query, collection, getDocs } = window.firestoreExports;
                const db = window.db;
                
                // Normalize telefono
                const userTelefonoTrimmed = userTelefono.trim();
                
                // Query all reservations without filtering (to avoid Firestore security rules issues)
                // Then filter client-side by telefono (same approach as loadUserClasses)
                const q = query(collection(db, 'reservas'));
                const querySnapshot = await getDocs(q);
                
                // Collect reservations and filter by telefono client-side
                const userReservations = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use flexible phone matching to handle format variations
                    if (data.telefono && phonesMatch(data.telefono, userTelefonoTrimmed)) {
                        userReservations.push({ id: doc.id, ...data });
                    }
                });
                
                console.log(`üìö Encontradas ${userReservations.length} reservas para el usuario`);
                
                if (userReservations.length === 0) {
                    return null;
                }
                
                // Sort by date (upcoming first)
                userReservations.sort((a, b) => {
                    const dateA = parseFechaHora(a.fechaHora);
                    const dateB = parseFechaHora(b.fechaHora);
                    return dateA - dateB;
                });
                
                // Format phone number for display (remove country code 52)
                let phoneDisplay = userTelefonoTrimmed;
                if (phoneDisplay.startsWith('52') && phoneDisplay.length === 12) {
                    phoneDisplay = phoneDisplay.substring(2);
                }
                
                // Build the message
                let mensaje = `¬°Hola Aura Studio!\n`;
                mensaje += `Soy ${userName} (${phoneDisplay})\n`;
                mensaje += `Ya pagu√© mis ${userReservations.length} clases, aqu√≠ mi rol:\n\n`;
                
                // Add each class with formatted date
                userReservations.forEach((reserva) => {
                    const fechaFormateada = formatDateToSpanish(reserva.fechaHora);
                    mensaje += `‚Ä¢ ${fechaFormateada}\n`;
                });
                
                return mensaje;
            } catch (error) {
                console.error('‚ùå Error al generar mensaje de WhatsApp:', error);
                console.error('Error details:', error.message, error.stack);
                return null;
            }
        }
        
        /**
         * Open WhatsApp with personalized message
         * @param {string} userTelefono - User's phone number
         * @param {string} userName - User's name
         */
        async function sendWhatsAppMessage(userTelefono, userName) {
            try {
                console.log('üì± Iniciando env√≠o de WhatsApp para:', userName);
                
                // Generate message with real data from Firebase
                const mensaje = await generateWhatsAppMessage(userTelefono, userName);
                
                if (!mensaje) {
                    console.warn('‚ö†Ô∏è No se pudo generar el mensaje (sin clases o error de Firebase)');
                    showCustomAlert('No se pudieron cargar tus clases.\n\nPor favor, intenta m√°s tarde o contacta con soporte.', 'warning', 'Atenci√≥n');
                    return false; // Return false to indicate failure
                }
                
                console.log('‚úÖ Mensaje generado correctamente');
                
                // Studio WhatsApp number
                const studioNumber = STUDIO_PHONE;
                
                // Encode message for URL
                const mensajeEncoded = encodeURIComponent(mensaje);
                
                // Open WhatsApp
                const whatsappUrl = `https://wa.me/${studioNumber}?text=${mensajeEncoded}`;
                console.log('üîó Abriendo WhatsApp con URL:', whatsappUrl.substring(0, 100) + '...');
                openWhatsAppLink(whatsappUrl);
                
                console.log('‚úÖ WhatsApp abierto con mensaje personalizado');
                return true; // Return true to indicate success
            } catch (error) {
                console.error('‚ùå Error al abrir WhatsApp:', error);
                console.error('Error details:', error.message, error.stack);
                showCustomAlert('Error al abrir WhatsApp. Por favor, intenta nuevamente.', 'error', 'Error');
                return false; // Return false to indicate failure
            }
        }
        
        // Expose sendWhatsAppMessage to window for access from dynamically created buttons
        window.sendWhatsAppMessage = sendWhatsAppMessage;
        
        /**
         * Create WhatsApp button element
         * @param {string} userTelefono - User's phone number
         * @param {string} userName - User's name
         * @returns {HTMLElement} WhatsApp button element
         */
        function createWhatsAppButton(userTelefono, userName) {
            const button = document.createElement('button');
            button.className = 'whatsapp-schedule-button';
            button.type = 'button'; // Explicitly set button type
            button.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="margin-right: 12px;">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" fill="currentColor"/>
                </svg>
                Recibir mi rol de clases por WhatsApp
            `;
            // Use addEventListener instead of onclick for better event handling
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('üì± WhatsApp button clicked', { userTelefono, userName });
                try {
                    await sendWhatsAppMessage(userTelefono, userName);
                } catch (error) {
                    console.error('‚ùå Error in button click handler:', error);
                    showCustomAlert('Error al abrir WhatsApp. Por favor, intenta nuevamente.', 'error', 'Error');
                }
            });
            return button;
        }


        // ========== REGLAS DE SEGURIDAD DE FIRESTORE ==========
        /*
         * INSTRUCCIONES: Copia y pega estas reglas en Firebase Console > Firestore Database > Rules
         * 
         * Estas reglas permiten:
         * - Lectura de la colecci√≥n 'reservas' para el admin y para usuarios que lean sus propias reservas
         * - Escritura en 'reservas' SOLO para usuarios autenticados (request.auth != null)
         * - Lectura de 'usuarios' SOLO para el admin (correo configurado en Firebase)
         * - Escritura en 'usuarios' SOLO para usuarios autenticados
         * 
         * REGLAS DE FIRESTORE (copiar en Firebase Console):
         * 
         * rules_version = '2';
         * service cloud.firestore {
         *   match /databases/{database}/documents {
         *     // Colecci√≥n de reservas
         *     match /reservas/{reservaId} {
         *       // Lectura: admin puede leer todo, usuarios pueden leer sus propias reservas
         *       allow read: if request.auth != null && 
         *                    (request.auth.token.email == '[ADMIN_EMAIL]' || 
         *                     resource.data.email == request.auth.token.email);
         *       // Escritura solo para usuarios autenticados
         *       allow write: if request.auth != null;
         *     }
         *     
         *     // Colecci√≥n de usuarios (perfiles)
         *     match /usuarios/{document=**} {
         *       // Lectura: admin puede leer todo, usuarios pueden leer su propio perfil
         *       // IMPORTANTE: Los usuarios DEBEN poder leer su perfil para recuperar su nombre
         *       allow read: if request.auth != null && 
         *                    (request.auth.token.email == '[ADMIN_EMAIL]' || 
         *                     resource.data.email == request.auth.token.email);
         *       // Escritura solo para usuarios autenticados
         *       // IMPORTANTE: Los usuarios DEBEN poder escribir para guardar su perfil al registrarse
         *       allow write: if request.auth != null;
         *     }
         *     
         *     // Todas las dem√°s colecciones: acceso denegado por defecto
         *     match /{document=**} {
         *       allow read, write: if false;
         *     }
         *   }
         * }
         * 
         * IMPORTANTE: Despu√©s de copiar estas reglas en Firebase Console,
         * haz clic en "Publicar" para aplicar los cambios.
         */

        // ========== INICIALIZACI√ìN ==========
        
        /**
         * Cargar reservas y exponer funci√≥n globalmente
         */
        window.loadReservationsFromFirestore = loadReservations;
        window.loadAdminCalendarReservations = loadAdminCalendarReservations;
        window.initAdminCalendar = initAdminCalendar;
        
        /**
         * Inicializar todo cuando el DOM est√© listo
         */
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Inicializando sistema de autenticaci√≥n y reservas...');
            
            // Configurar admin login y logout
            setupAdminLogin();
            setupLogout();
            
            // Observar cambios de autenticaci√≥n
            setupAuthObserver();
            
            // Handle window resize to apply/remove mobile-admin-view class
            // Use debouncing to improve performance
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (window.isAdmin) {
                        if (window.innerWidth <= MOBILE_BREAKPOINT) {
                            document.body.classList.add('mobile-admin-view');
                        } else {
                            document.body.classList.remove('mobile-admin-view');
                        }
                    }
                }, 150); // Debounce delay of 150ms
            });
            
            console.log('‚úÖ Sistema de autenticaci√≥n y reservas inicializado');
        });
    </script>

    <!-- ========== Hero Video Control Script ========== -->
    <script>
        // Control hero video playback (play from second 1 to second 25)
        // Enhanced for cross-device compatibility - removes play button on all devices
        document.addEventListener('DOMContentLoaded', function() {
            const heroVideo = document.getElementById('hero-video');
            // Delay before retrying play on pause (allows browser to settle)
            const PAUSE_RETRY_DELAY_MS = 100;
            
            if (heroVideo) {
                // Track if video loaded successfully and if play was already attempted
                let videoLoaded = false;
                let playAttempted = false;
                
                // Remove controls attribute programmatically (ensures no controls appear)
                heroVideo.controls = false;
                heroVideo.setAttribute('webkit-playsinline', 'true');
                heroVideo.setAttribute('x-webkit-airplay', 'deny');
                
                // Set start time to 1 second when video is loaded
                heroVideo.addEventListener('loadedmetadata', function() {
                    videoLoaded = true;
                    heroVideo.currentTime = 1;
                    console.log('‚úÖ Video loaded successfully');
                    // Ensure video plays after metadata loads
                    attemptPlay();
                });
                
                // Also try on canplay event (consolidated from multiple events)
                heroVideo.addEventListener('canplay', function() {
                    if (!playAttempted) {
                        attemptPlay();
                    }
                });
                
                // Monitor playback and loop from second 1 to 25
                heroVideo.addEventListener('timeupdate', function() {
                    // If video reaches 25 seconds or beyond, reset to 1 second
                    if (heroVideo.currentTime >= 25) {
                        heroVideo.currentTime = 1;
                    }
                });
                
                // If video is paused for any reason, try to resume
                heroVideo.addEventListener('pause', function() {
                    // Only try to resume if the video was loaded and is within playback range
                    if (videoLoaded && heroVideo.currentTime >= 1 && heroVideo.currentTime < 25) {
                        setTimeout(function() {
                            attemptPlay();
                        }, PAUSE_RETRY_DELAY_MS);
                    }
                });
                
                // Function to attempt playing the video with fallback
                function attemptPlay() {
                    if (heroVideo.paused) {
                        playAttempted = true;
                        const playPromise = heroVideo.play();
                        if (playPromise !== undefined) {
                            playPromise.then(function() {
                                console.log('‚úÖ Video autoplay successful');
                            }).catch(function(error) {
                                console.log('Video autoplay was prevented:', error.message);
                                // Try again on user interaction
                                setupUserInteractionFallback();
                            });
                        }
                    }
                }
                
                // Setup fallback for browsers that require user interaction
                function setupUserInteractionFallback() {
                    const startPlayback = function() {
                        attemptPlay();
                        // Remove listeners after first interaction
                        document.removeEventListener('touchstart', startPlayback);
                        document.removeEventListener('click', startPlayback);
                        document.removeEventListener('scroll', startPlayback);
                    };
                    
                    document.addEventListener('touchstart', startPlayback, { passive: true, once: true });
                    document.addEventListener('click', startPlayback, { once: true });
                    document.addEventListener('scroll', startPlayback, { passive: true, once: true });
                }
                
                // Detect video load errors
                heroVideo.addEventListener('error', function(e) {
                    console.warn('‚ö†Ô∏è Video failed to load');
                    console.warn('üìÅ Expected location: videoaura155.mp4');
                    console.warn('üìñ Instructions: See DOWNLOAD_VIDEO_FIRST.md or video-missing.html');
                    console.warn('üîó Download from: https://www.pexels.com/video/8746842/download/');
                    
                    // Show a subtle notification to developers
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        setTimeout(function() {
                            if (!videoLoaded) {
                                console.log('%cüé¨ AURA Studio - Video Missing', 'font-size: 16px; font-weight: bold; color: #EFE9E1;');
                                console.log('%cThe background video is not playing because the file is missing.', 'font-size: 14px;');
                                console.log('%cTo fix this:', 'font-size: 14px; font-weight: bold;');
                                console.log('%c1. Download: https://www.pexels.com/video/8746842/download/', 'font-size: 13px;');
                                console.log('%c2. Save as: videoaura155.mp4', 'font-size: 13px;');
                                console.log('%c3. Or run: ./download-video.sh or python download-video.py', 'font-size: 13px;');
                                console.log('%cFor detailed instructions, open: video-missing.html', 'font-size: 13px; font-style: italic;');
                            }
                        }, 1000);
                    }
                });
                
                // Ensure video starts at second 1
                heroVideo.currentTime = 1;
                
                // Initial play attempt
                attemptPlay();
                
                // Check if video is actually loading after a delay
                setTimeout(function() {
                    if (!videoLoaded && heroVideo.readyState === 0) {
                        console.warn('‚ö†Ô∏è Video may be missing or failed to load');
                        console.log('%cüìñ Open video-missing.html for instructions', 'font-size: 14px; color: #2196F3; font-weight: bold;');
                    }
                }, 2000);
            }
        });
    </script>

    <!-- ========== Page Loader Script ========== -->
    <script>
        // Hide loader after 3 seconds on page load or refresh
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loader = document.getElementById('page-loader');
                if (loader) {
                    // Add fade-out class
                    loader.classList.add('fade-out');
                    
                    // Remove from DOM after fade-out animation completes
                    setTimeout(function() {
                        loader.style.display = 'none';
                    }, 500); // Match the CSS transition duration
                }
            }, 3000); // 3 seconds delay
        });
    </script>

    <!-- ========== Business Hours Real-Time Display Script ========== -->
    <script>
        /**
         * Updates business hours display to show real-time status
         * Business hours:
         * - Monday to Saturday: 06:00 AM - 11:00 AM, 05:00 PM - 07:00 PM
         * - Sunday: Closed
         */
        function updateBusinessHoursDisplay() {
            const hoursElement = document.querySelector('.hours');
            if (!hoursElement) return;
            
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const currentTime = hours * 60 + minutes; // Convert to minutes since midnight
            
            // Define business hours in minutes since midnight
            const morningStart = 6 * 60; // 06:00 AM
            const morningEnd = 11 * 60; // 11:00 AM
            const afternoonStart = 17 * 60; // 05:00 PM
            const afternoonEnd = 19 * 60; // 07:00 PM (last class)
            
            // Check if it's Sunday (closed)
            if (dayOfWeek === 0) {
                hoursElement.innerHTML = 'üî¥ <strong>Cerrado hoy</strong> (Domingo)<br>Abrimos el Lunes a las 06:00 a.m.';
                hoursElement.style.color = '#C51162';
                return;
            }
            
            // Check if currently open (Monday-Saturday, within business hours)
            const isMorningHours = currentTime >= morningStart && currentTime < morningEnd;
            const isAfternoonHours = currentTime >= afternoonStart && currentTime < afternoonEnd;
            
            if (isMorningHours) {
                // Open in morning
                hoursElement.innerHTML = 'üü¢ <strong>Abierto ahora</strong><br>Horario: 06:00 a.m. ‚Äì 11:00 a.m.<br>Cerramos a las 11:00 a.m. (Abrimos 05:00 p.m.)';
                hoursElement.style.color = '#2E7D32';
            } else if (isAfternoonHours) {
                // Open in afternoon
                hoursElement.innerHTML = 'üü¢ <strong>Abierto ahora</strong><br>Horario: 05:00 p.m. ‚Äì 07:00 p.m. (√∫ltima clase)<br>√öltima clase a las 07:00 p.m.';
                hoursElement.style.color = '#2E7D32';
            } else if (currentTime < morningStart) {
                // Before morning opening
                hoursElement.innerHTML = 'üî¥ <strong>Cerrado</strong><br>Abrimos hoy a las 06:00 a.m.';
                hoursElement.style.color = '#C51162';
            } else if (currentTime >= morningEnd && currentTime < afternoonStart) {
                // Between morning and afternoon (lunch break)
                hoursElement.innerHTML = 'üî¥ <strong>Cerrado</strong> (Hora de comida)<br>Abrimos a las 05:00 p.m.';
                hoursElement.style.color = '#C51162';
            } else {
                // After evening closing - determine next opening day
                let nextOpening = 'ma√±ana'; // Default for Monday-Thursday
                if (dayOfWeek === 6) {
                    // Saturday evening -> opens Monday
                    nextOpening = 'el Lunes';
                } else if (dayOfWeek === 5) {
                    // Friday evening -> opens Saturday
                    nextOpening = 'ma√±ana S√°bado';
                }
                hoursElement.innerHTML = `üî¥ <strong>Cerrado</strong><br>Abrimos ${nextOpening} a las 06:00 a.m.`;
                hoursElement.style.color = '#C51162';
            }
        }
        
        // Update on page load
        document.addEventListener('DOMContentLoaded', updateBusinessHoursDisplay);
        
        // Update every minute to keep it current
        setInterval(updateBusinessHoursDisplay, 60000); // Update every 60 seconds
    </script>

    <!-- ========== Custom Alert Modal ========== -->
    <div id="custom-alert-overlay" class="custom-alert-overlay">
        <div id="custom-alert-card" class="custom-alert-card">
            <span id="custom-alert-icon" class="custom-alert-icon">‚úì</span>
            <h3 id="custom-alert-title" class="custom-alert-title">T√≠tulo</h3>
            <p id="custom-alert-message" class="custom-alert-message">Mensaje</p>
            <button type="button" id="custom-alert-button" class="custom-alert-button">Aceptar</button>
        </div>
    </div>

    <!-- ========== Custom Alert Script ========== -->
    <script>
        /**
         * Custom Alert System - Beautiful pearl/white styled cards
         * Replaces native browser alert() with styled modal cards
         */
        function showCustomAlert(message, type = 'info', title = '') {
            const overlay = document.getElementById('custom-alert-overlay');
            const card = document.getElementById('custom-alert-card');
            const icon = document.getElementById('custom-alert-icon');
            const titleEl = document.getElementById('custom-alert-title');
            const messageEl = document.getElementById('custom-alert-message');
            const button = document.getElementById('custom-alert-button');

            // Set icon and title based on type
            let iconChar = '‚úì';
            let defaultTitle = 'Notificaci√≥n';
            
            // Remove previous type classes
            card.classList.remove('custom-alert-success', 'custom-alert-error', 'custom-alert-warning', 'custom-alert-info');
            
            if (type === 'success') {
                iconChar = '‚úì';
                defaultTitle = '¬°√âxito!';
                card.classList.add('custom-alert-success');
            } else if (type === 'error') {
                iconChar = '‚úï';
                defaultTitle = 'Error';
                card.classList.add('custom-alert-error');
            } else if (type === 'warning') {
                iconChar = '‚ö†';
                defaultTitle = 'Atenci√≥n';
                card.classList.add('custom-alert-warning');
            } else if (type === 'info') {
                iconChar = '‚Ñπ';
                defaultTitle = 'Informaci√≥n';
                card.classList.add('custom-alert-info');
            }

            icon.textContent = iconChar;
            titleEl.textContent = title || defaultTitle;
            messageEl.textContent = message;

            // Show overlay
            overlay.style.display = 'flex';

            // Button click handler
            const closeAlert = () => {
                overlay.style.display = 'none';
                button.removeEventListener('click', closeAlert);
                overlay.removeEventListener('click', outsideClickHandler);
            };

            // Close on button click
            button.addEventListener('click', closeAlert);

            // Close on overlay click (outside card)
            const outsideClickHandler = (e) => {
                if (e.target === overlay) {
                    closeAlert();
                }
            };
            overlay.addEventListener('click', outsideClickHandler);
        }

        // Override native alert function
        window.alert = function(message) {
            // Determine alert type based on message content
            let type = 'info';
            let title = '';

            if (message.includes('‚úÖ') || message.includes('Completadas') || message.includes('exitoso') || message.includes('agregada')) {
                type = 'success';
                title = '¬°√âxito!';
            } else if (message.includes('‚ùå') || message.includes('Error')) {
                type = 'error';
                title = 'Error';
            } else if (message.includes('‚ö†Ô∏è') || message.includes('Atenci√≥n') || message.includes('Debes')) {
                type = 'warning';
                title = 'Atenci√≥n';
            }

            showCustomAlert(message, type, title);
        };
    </script>

    <!-- ========== MERCADO PAGO - FIX DEFINITIVO 2025 (100% RETORNO) ========== -->
    <script>
        // CONFIGURACI√ìN DE PRODUCCI√ìN - Token movido al backend por seguridad
        const BACKEND_URL = '/api/create-preference';
        const RETURN_URL = 'https://aurapilates.app';

        // NUEVO FLUJO: Attach click handlers to all "Agendar Clase" buttons
        document.addEventListener('DOMContentLoaded', () => {
            // Attach click handlers to all "Agendar Clase" buttons
            const planButtons = document.querySelectorAll('.plan-btn');
            planButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Extract clases from data-title (e.g., "1 Clases" -> 1)
                    const dataTitle = button.getAttribute('data-title');
                    if (!dataTitle) {
                        console.error('Missing data-title attribute on button');
                        return;
                    }
                    const match = dataTitle.match(/\d+/);
                    if (!match) {
                        console.error('Invalid data-title format (expected number):', dataTitle);
                        return;
                    }
                    const clases = parseInt(match[0], 10);
                    if (isNaN(clases) || clases <= 0) {
                        console.error('Invalid number of classes (must be positive):', clases);
                        return;
                    }
                    
                    // Extract precio from data-price
                    const dataPrecio = button.getAttribute('data-price');
                    if (!dataPrecio) {
                        console.error('Missing data-price attribute on button');
                        return;
                    }
                    const precio = parseInt(dataPrecio, 10);
                    if (isNaN(precio) || precio <= 0) {
                        console.error('Invalid price (must be positive):', precio);
                        return;
                    }
                    
                    console.log(`Plan button clicked: ${clases} clases, $${precio}`);
                    // NUEVO FLUJO: Llamar directamente a selectPlan (muestra calendario inmediatamente)
                    window.selectPlan(clases, precio);
                });
            });
            
            // Setup payment button click handler
            const finalPaymentBtn = document.getElementById('final-payment-btn');
            if (finalPaymentBtn) {
                finalPaymentBtn.addEventListener('click', () => {
                    // Mostrar modal para pedir nombre y tel√©fono antes de proceder al pago
                    showFinalReservationModal();
                });
            }
            
            // Setup time selection modal cancel button
            const timeCancelBtn = document.getElementById('time-cancel');
            if (timeCancelBtn) {
                timeCancelBtn.addEventListener('click', () => {
                    // Clear the time slots container to prevent any potential duplication issues
                    const slotsContainer = document.getElementById('time-slots-container');
                    if (slotsContainer) {
                        slotsContainer.innerHTML = '';
                    }
                    document.getElementById('time-selection-modal').style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling
                });
            }
        });

        async function crearPreferenciaYRedirigir(nombre, telefono) {
            // Validar que tenemos los datos necesarios
            if (!nombre || !telefono) {
                console.error('‚ùå Faltan datos del cliente:', { nombre, telefono });
                alert('‚ùå Error: Faltan datos del cliente. Por favor, completa el formulario.');
                return;
            }
            
            // Usar selectedPlan para obtener clases y precio
            const classes = selectedPlan.classes || parseInt(localStorage.getItem('tempPlanClasses') || '1');
            const price = selectedPlan.price || parseInt(localStorage.getItem('tempPlanPrice') || '150');
            
            // Validar que hay clases y precio v√°lidos
            if (classes <= 0 || price <= 0) {
                console.error('‚ùå Plan inv√°lido:', { classes, price });
                alert('‚ùå Error: Plan no v√°lido. Por favor, selecciona un plan nuevamente.');
                return;
            }
            
            // Mostrar indicador de carga
            console.log(`‚è≥ Procesando pago de ${classes} clase${classes > 1 ? 's' : ''} por $${price}...`);

            try {
                // Llamar al backend seguro en lugar de exponer el token
                const res = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `${classes} clase${classes > 1 ? 's' : ''} en Aura Studio`,
                        price: price,
                        payer_name: nombre,
                        payer_phone: telefono
                    })
                });
                
                // Verificar si la respuesta es exitosa
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    console.error('‚ùå Error del servidor:', res.status, errorData);
                    
                    if (res.status === 400) {
                        alert(`‚ùå Datos inv√°lidos: ${errorData.details || errorData.error || 'Verifica tus datos'}`);
                    } else if (res.status === 500) {
                        const errorMsg = errorData.details || errorData.error || 'Error del servidor';
                        alert(`‚ùå ${errorMsg}\n\nPor favor, intenta nuevamente en unos minutos o contacta con soporte.`);
                    } else {
                        alert(`‚ùå Error al procesar pago (${res.status}). Por favor, intenta nuevamente.`);
                    }
                    return;
                }
                
                const data = await res.json();
                if (!data.init_point) {
                    console.error('‚ùå Error en respuesta del servidor:', data);
                    alert('‚ùå Error al crear preferencia de pago. Por favor, intenta nuevamente.');
                    return;
                }
                
                console.log('‚úÖ Preferencia creada:', data.preference_id || 'OK');
                console.log('üîó Redirigiendo a MercadoPago...');
                
                // Verificar una √∫ltima vez que las reservas est√°n guardadas
                const verificacionFinal = localStorage.getItem('tempReservations');
                if (!verificacionFinal) {
                    console.error('‚ö†Ô∏è ADVERTENCIA: tempReservations no est√° en localStorage antes de redirigir');
                    alert('‚ö†Ô∏è Error al guardar las reservas.\n\nPor favor, intenta nuevamente.');
                    return;
                }
                console.log('‚úÖ Verificaci√≥n final: tempReservations presente en localStorage');
                
                // Redirigir a MercadoPago
                location.href = data.init_point;
            } catch (e) {
                console.error('‚ùå Error al procesar pago:', e);
                
                // Verificar si es un error de red
                if (e.name === 'TypeError' && e.message.includes('fetch')) {
                    alert('‚ùå Error de conexi√≥n. Verifica tu internet e intenta nuevamente.');
                } else {
                    alert('‚ùå Error al procesar pago. Por favor, intenta nuevamente.');
                }
            }
        }

        // Constants for the application
        const COUNTRY_CODE = '52'; // Mexico country code (also defined as MEXICO_COUNTRY_CODE earlier)
        const DEFAULT_NAME = 'Sin nombre';
        const DEFAULT_PHONE = 'Sin tel√©fono';
        const MAX_CAPACITY = 5; // Maximum number of people per time slot
        
        // Constants for Firebase initialization
        const MAX_FIREBASE_INIT_ATTEMPTS = 20;
        const FIREBASE_POLLING_INTERVAL_MS = 500;
        
        // DETECTOR DE RETORNO MEJORADO - Maneja callback de Mercado Pago
        // NUEVO FLUJO: Guardar todas las reservas en Firestore al regresar del pago
        // Flag para evitar ejecuci√≥n m√∫ltiple
        let paymentReturnProcessed = false;
        
        async function detectarRetorno() {
            // Evitar doble procesamiento (DOMContentLoaded + load)
            if (paymentReturnProcessed) {
                console.log('‚è≠Ô∏è Retorno ya procesado, saltando...');
                return;
            }
            
            // Check if localStorage is available
            if (!window.localStorage) {
                console.error('‚ùå localStorage no est√° disponible en este navegador');
                alert('‚ö†Ô∏è Tu navegador no soporta almacenamiento local.\n\nNo se pueden recuperar tus reservas.\n\nPor favor, contacta con soporte con tu comprobante de pago.');
                return;
            }
            
            // Usar la funci√≥n helper para verificar si es un retorno de pago
            if (!isPaymentReturnFromMercadoPago()) {
                return; // No hay par√°metros de pago, no hacer nada
            }
            
            const params = new URLSearchParams(location.search);
            
            // Verificar estados de pago de MercadoPago
            const status = params.get('status');
            const paymentId = params.get('payment_id') || params.get('collection_id');
            const hasSuccessParam = params.has('success') && params.get('success') === '1';
            
            // Determinar el estado del pago
            const isApproved = status === 'approved' || hasSuccessParam;
            const isPending = status === 'pending' || status === 'in_process';
            const isRejected = status === 'rejected' || (params.has('error') && params.get('error') === '1');
            
            // Solo procesar si hay par√°metros de pago
            if (!isApproved && !isPending && !isRejected && !paymentId) {
                return; // No hay par√°metros de pago, no hacer nada
            }
            
            // Marcar como procesado para evitar doble ejecuci√≥n
            paymentReturnProcessed = true;
            console.log('üí≥ Retorno de Mercado Pago detectado:', { status, paymentId, isApproved, isPending, isRejected });
            
            // Manejar pago rechazado
            if (isRejected) {
                console.log('‚ùå Pago rechazado');
                history.replaceState({}, document.title, location.pathname);
                alert('‚ùå El pago fue rechazado.\n\nPor favor, verifica tu m√©todo de pago e intenta nuevamente.\n\nTus reservas temporales se mantienen.');
                return;
            }
            
            // Manejar pago pendiente
            if (isPending) {
                console.log('‚è≥ Pago pendiente');
                history.replaceState({}, document.title, location.pathname);
                alert('‚è≥ Tu pago est√° siendo procesado.\n\nTe notificaremos cuando se confirme.\n\nNo cierres esta ventana.');
                // No limpiar localStorage, ya que el pago a√∫n no est√° confirmado
                return;
            }
            
            // Solo continuar si el pago fue aprobado
            if (!isApproved) {
                console.log('‚ö†Ô∏è Estado de pago no reconocido:', status);
                history.replaceState({}, document.title, location.pathname);
                return;
            }
            
            console.log('‚úÖ Pago aprobado, procesando reservas...');
            
            // 1. Limpiar URL inmediatamente (quitar par√°metros de pago)
            history.replaceState({}, document.title, location.pathname);
            console.log('üßπ URL limpiada');
            
            // 2. Recuperar reservas temporales de localStorage
            console.log('üîç Verificando localStorage...');
            console.log('üì¶ Claves en localStorage:', Object.keys(localStorage));
            
            const tempReservationsStr = localStorage.getItem('tempReservations');
            
            if (!tempReservationsStr) {
                console.error('‚ùå No hay reservas temporales en localStorage');
                console.log('üìã Estado de localStorage:', {
                    tempReservations: localStorage.getItem('tempReservations'),
                    tempPlanClasses: localStorage.getItem('tempPlanClasses'),
                    tempPlanPrice: localStorage.getItem('tempPlanPrice'),
                    userNombre: localStorage.getItem('userNombre'),
                    userTelefono: localStorage.getItem('userTelefono')
                });
                alert('‚ö†Ô∏è No se encontraron reservas pendientes.\n\nEsto puede suceder si:\n- El navegador bloque√≥ el almacenamiento\n- Se limpi√≥ el cach√©\n- Se us√≥ modo inc√≥gnito\n\nPor favor, selecciona un plan nuevamente o contacta con soporte si ya pagaste.');
                return;
            }
            
            console.log('‚úÖ Reservas encontradas en localStorage:', tempReservationsStr.substring(0, 100) + '...');
            
            let tempData;
            try {
                tempData = JSON.parse(tempReservationsStr);
            } catch (e) {
                console.error('‚ùå Error al parsear reservas temporales:', e);
                alert('‚ùå Error al recuperar reservas. Por favor, contacta con soporte.');
                return;
            }
            
            // Validar estructura de datos
            const { reservations, userInfo } = tempData;
            if (!reservations || !Array.isArray(reservations) || reservations.length === 0) {
                console.error('‚ùå Estructura de reservas inv√°lida:', tempData);
                alert('‚ùå Error: Reservas no v√°lidas. Por favor, contacta con soporte.');
                return;
            }
            
            const nombre = userInfo?.nombre || localStorage.getItem('userNombre') || 'Cliente';
            const telefono = userInfo?.telefono || localStorage.getItem('userTelefono') || '';
            
            if (!telefono) {
                console.error('‚ùå Falta el tel√©fono del usuario');
                alert('‚ùå Error: Informaci√≥n del usuario incompleta.\n\nPor favor, contacta con soporte con tu comprobante de pago.');
                return;
            }
            
            console.log(`üìã Reservas recuperadas: ${reservations.length} clases para ${nombre} (${telefono})`);
            
            // 3. Mostrar mensaje de √©xito inicial
            alert(`¬°Pago recibido, ${nombre}!\n\nGuardando tus ${reservations.length} clases...`);
            
            // 4. Esperar a que Firebase est√© listo
            const waitForFirebase = async () => {
                let attempts = 0;
                
                while (attempts < MAX_FIREBASE_INIT_ATTEMPTS) {
                    if (window.firebaseReady && window.db && typeof window.saveReservationToFirestore === 'function') {
                        return true;
                    }
                    await new Promise(resolve => setTimeout(resolve, FIREBASE_POLLING_INTERVAL_MS));
                    attempts++;
                    console.log(`‚è≥ Esperando Firebase... (${attempts}/${MAX_FIREBASE_INIT_ATTEMPTS})`);
                }
                return false;
            };
            
            const firebaseReady = await waitForFirebase();
            if (!firebaseReady) {
                console.error('‚ùå Firebase no est√° listo');
                // NO limpiar localStorage para que el usuario pueda reintentar
                alert('‚ùå Error: Sistema de reservas no disponible.\n\nTus reservas est√°n guardadas temporalmente.\nPor favor, recarga la p√°gina para reintentar o contacta con soporte.');
                return;
            }
            
            console.log('‚úÖ Firebase listo, guardando reservas...');
            
            // 5. Guardar todas las reservas en Firestore
            const savedReservations = [];
            const failedReservations = [];
            
            for (let i = 0; i < reservations.length; i++) {
                const reservation = reservations[i];
                try {
                    console.log(`üíæ Guardando reserva ${i + 1}/${reservations.length}...`, reservation);
                    
                    // Validar datos de la reserva antes de guardar
                    if (!reservation.nombre || !reservation.telefono || !reservation.fechaHora) {
                        console.error(`‚ùå Reserva ${i + 1} tiene datos incompletos:`, reservation);
                        failedReservations.push(reservation);
                        continue;
                    }
                    
                    const reservaId = await window.saveReservationToFirestore(
                        reservation.nombre,
                        reservation.telefono,
                        reservation.fechaHora, // ISO format: YYYY-MM-DDTHH:mm:ss
                        '' // notas vac√≠as por ahora
                    );
                    
                    savedReservations.push(reservaId);
                    console.log(`‚úÖ Reserva ${i + 1} guardada con ID:`, reservaId);
                } catch (error) {
                    console.error(`‚ùå Error al guardar reserva ${i + 1}:`, error);
                    failedReservations.push(reservation);
                }
            }
            
            // 6. Solo limpiar datos temporales si se guard√≥ al menos una reserva
            if (savedReservations.length > 0) {
                localStorage.removeItem('tempReservations');
                localStorage.removeItem('tempPlanClasses');
                localStorage.removeItem('tempPlanPrice');
                localStorage.removeItem('planClases');
                localStorage.removeItem('planPrecio');
                console.log('üßπ Datos temporales limpiados');
            }
            
            // 7. Mostrar resultado
            if (savedReservations.length === reservations.length) {
                // Todas guardadas exitosamente
                // Show custom success message with WhatsApp button
                showPaymentSuccessWithWhatsApp(nombre, telefono, savedReservations.length);
                
                // 8. Recargar "Mis Clases" si el usuario est√° logueado
                if (telefono && typeof window.loadUserClasses === 'function') {
                    console.log('üìö Recargando "Mis Clases"...');
                    try {
                        await window.loadUserClasses(telefono);
                    } catch (e) {
                        console.error('Error al cargar clases del usuario:', e);
                    }
                }
                
                // 9. Recargar panel admin si est√° disponible
                if (window.isAdmin && typeof window.loadReservationsFromFirestore === 'function') {
                    console.log('üë®‚Äçüíº Recargando panel admin...');
                    try {
                        await window.loadReservationsFromFirestore();
                    } catch (e) {
                        console.error('Error al recargar panel admin:', e);
                    }
                }
                
                // 10. Scroll a "Mis Clases" si est√° visible
                const myClassesSection = document.getElementById('my-classes-section');
                if (myClassesSection && myClassesSection.style.display !== 'none') {
                    setTimeout(() => {
                        myClassesSection.scrollIntoView({ behavior: 'smooth' });
                    }, 1000);
                }
            } else if (savedReservations.length > 0) {
                // Algunas guardadas
                alert(`‚ö†Ô∏è Pago recibido\n\n${savedReservations.length} de ${reservations.length} clases guardadas correctamente.\n\n${failedReservations.length} clases fallaron.\n\nPor favor, contacta con soporte.`);
            } else {
                // Ninguna guardada - NO limpiar localStorage
                alert('‚ùå Error al guardar las reservas.\n\nTu pago fue recibido pero hubo un error t√©cnico.\n\nPor favor, recarga la p√°gina para reintentar o contacta con soporte inmediatamente.');
            }
        }
        
        /**
         * Show payment success message with WhatsApp button
         * @param {string} nombre - User's name
         * @param {string} telefono - User's phone number
         * @param {number} classCount - Number of classes
         */
        function showPaymentSuccessWithWhatsApp(nombre, telefono, classCount) {
            // Create custom modal
            const modal = document.createElement('div');
            modal.id = 'payment-success-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #ffffff 0%, #EFE9E1 100%);
                border-radius: 25px;
                padding: 40px 30px;
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                animation: fadeInUp 0.4s ease-out;
            `;
            
            modalContent.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                <h2 style="color: #333; font-size: 1.8rem; margin-bottom: 15px; font-weight: 700;">¬°Pago recibido!</h2>
                <p style="color: #666; font-size: 1.2rem; margin-bottom: 10px;">
                    Gracias <strong>${nombre}</strong>
                </p>
                <p style="color: #666; font-size: 1.1rem; margin-bottom: 30px;">
                    Tus <strong>${classCount}</strong> clases est√°n confirmadas
                </p>
                <button id="send-classes-modal" type="button" style="
                    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
                    border: none;
                    color: #fff;
                    padding: 16px 40px;
                    border-radius: 12px;
                    font-size: 1.1rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    margin: 0 auto;
                ">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" fill="currentColor"/>
                    </svg>
                    Enviar mis clases
                </button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Send classes button handler - sends WhatsApp and closes modal
            const sendBtn = modalContent.querySelector('#send-classes-modal');
            sendBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('üì± Enviar mis clases button clicked', { telefono, nombre });
                try {
                    // Send WhatsApp message with class schedule
                    if (typeof window.sendWhatsAppMessage === 'function') {
                        await window.sendWhatsAppMessage(telefono, nombre);
                    } else {
                        console.error('‚ùå sendWhatsAppMessage function not available yet');
                        // Fallback: open WhatsApp directly without class details
                        const studioNumber = STUDIO_PHONE;
                        const mensaje = `Hola, soy ${nombre}. Acabo de completar mi pago y me gustar√≠a recibir el detalle de mis clases.`;
                        const whatsappUrl = `https://wa.me/${studioNumber}?text=${encodeURIComponent(mensaje)}`;
                        window.open(whatsappUrl, '_blank');
                    }
                    // Close modal after successful send
                    modal.remove();
                } catch (error) {
                    console.error('‚ùå Error sending WhatsApp message:', error);
                    // Don't close modal if there was an error
                    // Error is already shown by sendWhatsAppMessage function
                }
            });
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Hover effect for send button
            sendBtn.addEventListener('mouseenter', () => {
                sendBtn.style.transform = 'translateY(-2px)';
                sendBtn.style.boxShadow = '0 6px 20px rgba(37, 211, 102, 0.4)';
            });
            sendBtn.addEventListener('mouseleave', () => {
                sendBtn.style.transform = 'translateY(0)';
                sendBtn.style.boxShadow = '0 4px 15px rgba(37, 211, 102, 0.3)';
            });
        }
        
        // Expose showPaymentSuccessWithWhatsApp to window for debugging and testing
        window.showPaymentSuccessWithWhatsApp = showPaymentSuccessWithWhatsApp;

        // Ejecutar al cargar
        document.addEventListener('DOMContentLoaded', detectarRetorno);
        window.addEventListener('load', detectarRetorno);
    </script>

    <!-- External JavaScript for Registration and Payment Flow -->
    <script src="script.js" onerror="console.error('Error loading script.js - Registration functionality may not work')"></script>

</body>
</html>
