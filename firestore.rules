rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====== RESERVAS ======
    match /reservas/{reservaId} {
      // Admin tiene acceso total (por email)
      allow read, write: if request.auth != null && 
          (request.auth.token.email == 'admin@aura.com' || 
           request.auth.token.email == '7151596586');

      // Cualquier persona puede crear reservas (nuevo flujo - después del pago exitoso)
      // Las reservas se crean desde el frontend después de confirmar el pago
      allow create: if true;

      // Lectura pública para mostrar disponibilidad en el calendario
      // Solo se muestran datos limitados (fechaHora) en el frontend
      // También permite que usuarios autenticados lean todas las reservas para filtrar client-side
      allow read: if true;
      
      // Solo admin puede actualizar o borrar reservas
      allow update, delete: if request.auth != null && 
          (request.auth.token.email == 'admin@aura.com' || 
           request.auth.token.email == '7151596586');
    }

    // ====== PERFIL DE USUARIOS ======
    match /usuarios/{userId} {
      // Admin tiene acceso total
      allow read, write: if request.auth != null && 
          (request.auth.token.email == 'admin@aura.com' || 
           request.auth.token.email == '7151596586');
      
      // Usuario normal puede crear su perfil si está autenticado
      allow create: if request.auth != null;
      
      // Usuario normal puede leer y actualizar su propio perfil
      // Ahora usa el email del token (que es phoneNumber@aurapilates.app)
      allow read, update: if request.auth != null && 
          (resource.data.email.toLowerCase() == request.auth.token.email.toLowerCase() ||
           resource.data.telefono == request.auth.token.phone_number);
    }

    // Todo lo demás bloqueado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
