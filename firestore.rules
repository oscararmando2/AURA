rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====== RESERVAS ======
    match /reservas/{reservaId} {
      // Admin tiene acceso total (por email o por teléfono)
      allow read, write: if request.auth != null && 
          (request.auth.token.email == 'admin@aura.com' || 
           request.auth.token.email == '7151596586');

      // Cualquier persona puede crear reservas (nuevo flujo sin login obligatorio)
      // Las reservas se crean después del pago exitoso
      allow create: if true;

      // Usuario normal puede leer sus propias reservas por teléfono
      // IMPORTANTE: Esta regla permite que los usuarios vean "Mis Clases"
      // Soporta tanto email como telefono para compatibilidad
      allow read: if request.auth == null || 
          resource.data.telefono == request.resource.data.telefono ||
          (request.auth != null && 
           (resource.data.email != null && resource.data.email.toLowerCase() == request.auth.token.email.toLowerCase()));
      
      // Solo admin puede actualizar o borrar
      allow update, delete: if request.auth != null && 
          (request.auth.token.email == 'admin@aura.com' || 
           request.auth.token.email == '7151596586');
    }

    // ====== PERFIL DE USUARIOS ======
    match /usuarios/{userId} {
      // Admin tiene acceso total
      allow read, write: if request.auth != null && 
          (request.auth.token.email == 'admin@aura.com' || 
           request.auth.token.email == '7151596586');
      
      // Usuario normal puede crear su perfil
      allow create: if request.auth != null;
      
      // Usuario normal puede leer y actualizar SOLO su propio perfil
      allow read, update: if request.auth != null && 
          resource.data.email.toLowerCase() == request.auth.token.email.toLowerCase();
    }

    // Todo lo demás bloqueado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
